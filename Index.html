<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Uratex Workforce Intelligence & Analytics Hub</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/jspdf-autotable@latest/dist/jspdf.plugin.autotable.js"></script>

  <script src="https://code.jquery.com/jquery-3.7.0.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
  
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.colVis.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>

  <style>
    body {
      background-color: #f7fafc;
      font-family: 'Roboto', sans-serif;
    }
    details>summary {
      list-style: none;
    }
    details>summary::-webkit-details-marker {
      display: none;
    }
    .google-visualization-orgchart-node-medium {
      padding: 0 !important;
      border: none !important;
      background: none !important;
      box-shadow: none !important;
    }
    .node-card {
      position: relative;
      display: inline-flex;
      align-items: flex-start;
      padding: 8px;
      border-radius: 8px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      min-width: 320px;
      width: auto;
      border: 2px solid;
      text-align: left;
    }
    .node-card:hover .node-actions {
      display: flex;
    }
    .node-card img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      margin-right: 12px;
      object-fit: cover;
      flex-shrink: 0;
    }
    .node-text {
      flex-grow: 1;
      margin-right: 8px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .node-text .name,
    .node-text .title,
    .node-text .dept {
      white-space: nowrap;
    }
    .node-text .name {
      font-weight: 700;
      font-size: 15px;
      color: #334155;
    }
    .node-text .title {
      font-size: 13px;
      color: #2563eb;
    }
    .node-text .dept {
      font-size: 12px;
      color: #718096;
      font-style: italic;
      margin-top: 2px;
    }
    .badge-grid {
      display: grid;
      grid-template-columns: repeat(2, auto);
      gap: 4px;
      flex-shrink: 0;
    }
    .badge {
      padding: 1px 5px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 500;
      text-align: center;
      white-space: nowrap;
    }
    .bg-badge-payroll {
      background-color: #3b82f6;
      color: white;
    }
    .bg-badge-joblevel {
      background-color: #facc15;
      color: black;
    }
    .bg-badge-contract {
      background-color: #1e40af;
      color: white;
    }
    .bg-badge-competency {
      background-color: #ef4444;
      color: white;
    }
    .level-1-border { border-color: #000000; }
    .level-2-border { border-color: #f56565; }
    .level-3-border { border-color: #4299e1; }
    .level-4-border { border-color: #48bb78; }
    .level-5-border { border-color: #9f7aea; }
    .level-6-border { border-color: #ed8936; }
    .level-default-border { border-color: #a0aec0; }
    .level-1-bg { background-color: #f3f4f6; }
    .level-2-bg { background-color: #fee2e2; }
    .level-3-bg { background-color: #dbeafe; }
    .level-4-bg { background-color: #dcfce7; }
    .level-5-bg { background-color: #f3e8ff; }
    .level-6-bg { background-color: #fff7ed; }
    .level-default-bg { background-color: #f1f5f9; }
    .contract-jrel-jpro-border { border-color: #f97316; }
    .contract-jrel-jpro-bg { background-color: #ffedd5; }
    .contract-jreg-border { border-color: #3b82f6; }
    .contract-jreg-bg { background-color: #dbeafe; }
    .contract-others-border { border-color: #6b7280; }
    .contract-others-bg { background-color: #e5e7eb; }
    .contract-dashed { border-style: dashed !important; border-width: 2px !important; }
    .vacant-card {
      position: relative;
      display: inline-flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 8px 12px;
      border-radius: 8px;
      min-width: 280px;
      width: auto;
      border: 2px dashed #9ca3af;
      background-color: #f9fafb;
    }
    .vacant-card:hover .node-actions {
      display: flex;
    }
    .status-dot {
      position: absolute;
      top: -5px;
      right: -5px;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.1);
    }
    .bg-new-hire { background-color: #22c55e; }
    .bg-filled-vacancy { background-color: #3b82f6; }
    .bg-internal-transfer { background-color: #8b5cf6; }
    .bg-promotion { background-color: #f59e0b; }
    .bg-lateral-transfer { background-color: #0ea5e9; }
    .plantilla-over { background-color: #fee2e2; }
    .plantilla-at { background-color: #f1f5f9; }
    #custom-tooltip {
      position: absolute;
      display: none;
      background-color: white;
      border-width: 2px;
      border-style: solid;
      border-radius: 8px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      padding: 12px;
      min-width: 280px;
      z-index: 1000;
    }
    #custom-tooltip img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: block;
      margin: 0 auto 10px;
      border-width: 3px;
      border-style: solid;
    }
    #custom-tooltip p {
      margin: 0 0 2px 0;
      font-size: 12px;
      color: #2d3748;
    }
    #custom-tooltip p strong {
      font-weight: 700;
      color: #4a5568;
      display: inline-block;
      width: 110px;
    }
    #loader {
      border: 8px solid #f3f3f3;
      border-radius: 50%;
      border-top: 8px solid #4338ca;
      width: 60px;
      height: 60px;
      animation: spin 2s linear infinite;
    }
    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }
    .node-actions {
      position: absolute;
      top: -12px;
      right: -12px;
      display: none;
      gap: 4px;
      z-index: 10;
    }
    .action-btn {
      background-color: white;
      border: 1px solid #d1d5db;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      cursor: pointer;
    }
    .action-btn:hover {
      background-color: #f9fafb;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal-content {
      background-color: white;
      padding: 24px;
      border-radius: 8px;
      width: 90%;
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
    }
    /* ADD THIS NEW CSS RULE */
    .inactive-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(107, 114, 128, 0.75); /* A semi-transparent gray */
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.5rem;
      border-radius: 6px; /* Match the card's border-radius */
      z-index: 5;
      pointer-events: none; /* Allows mouse events to pass through to the card */
    }
    .searchable-dropdown {
      position: relative;
    }
    .searchable-dropdown-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .searchable-dropdown-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background-color: white;
      border: 1px solid #ccc;
      border-top: none;
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }
    .searchable-dropdown-list div {
      padding: 8px;
      cursor: pointer;
    }
    .searchable-dropdown-list div:hover {
      background-color: #f0f0f0;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      font-weight: 600;
      color: #64748b;
    }
    .tab.active {
      color: #1d4ed8;
      border-bottom-color: #2563eb;
    }
    .notification-badge {
      background-color: #3b82f6; /* Blue */
      color: white;
      font-size: 0.75rem;
      font-weight: bold;
      padding: 0.125rem 0.5rem;
      border-radius: 9999px;
      line-height: 1;
    }
    .notification-badge-rejected {
      background-color: #ef4444; /* Red */
      color: white;
      font-size: 0.75rem;
      font-weight: bold;
      padding: 0.125rem 0.5rem;
      border-radius: 9999px;
      line-height: 1;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .chart-card {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      overflow: hidden; /* This is key to keep the rounded corners with the header strip */
      transition: all 0.2s ease-in-out;
    }

    .chart-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .chart-card-header {
      padding: 12px 24px;
      color: white;
      font-weight: bold;
    }

    .chart-card-body {
      padding: 24px;
    }

/* Color themes for each tab */
.header-demographics { background-color: #22c55e; } /* Green */
.header-resignation { background-color: #ef4444; } /* Light Red */
.header-movement { background-color: #0d9488; } /* Teal */

.summary-card {
      transition: all 0.2s ease-in-out;
    }

    .summary-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    .dt-controls-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1em;
    }
    /* --- NEW TABLE STYLES --- */
    .dataTables_wrapper .dataTables_length, .dataTables_wrapper .dataTables_filter, .dataTables_wrapper .dataTables_info, .dataTables_wrapper .dataTables_paginate {
      margin-bottom: 1.5em;
    }
    table.dataTable thead th, table.dataTable thead td {
      padding: 12px 18px;
      border-bottom: 1px solid #e2e8f0;
      white-space: nowrap;
    }
    table.dataTable thead {
      background-color: #1e40af; /* Darker Blue header background for consistency */
      color: #ffffff; /* White text for header */
      font-weight: bold;
    }
    table.dataTable tbody tr {
      background-color: #ffffff;
      transition: background-color 0.2s ease-in-out;
    }
    table.dataTable tbody tr:nth-child(even) {
      background-color: #f8fafc;
    }
    table.dataTable tbody tr:hover {
      background-color: #eff6ff; /* Lighter blue on hover */
    }
    table.dataTable tbody td {
      padding: 12px 18px;
      vertical-align: middle;
    }
    table.dataTable.no-footer {
      border-bottom: 1px solid #e2e8f0;
    }
    .dataTables_scrollBody {
        border-bottom: 1px solid #e2e8f0 !important;
    }
    .dataTables_wrapper .dt-buttons button {
      background-color: #4f46e5;
      color: white;
      border: none;
      padding: 0.5em 1em;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .dataTables_wrapper .dt-buttons button:hover {
      background-color: #4338ca;
    }
    .dt-button-collection .dt-button {
        color: black !important;
    }
    /* --- END NEW TABLE STYLES --- */

    /* --- NEW PREVIEW STYLES --- */
    .preview-highlight {
      border: 3px solid #f59e0b !important; /* Bright orange border */
      box-shadow: 0 0 15px rgba(245, 158, 11, 0.7) !important; /* Orange glow */
      position: relative; /* Needed for the label */
    }
    .preview-vacated {
        border: 3px dashed #ef4444 !important; /* Dashed red border for vacated */
        opacity: 0.7;
        background-color: #fef2f2 !important; /* Light red background */
    }
    .preview-label {
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #f59e0b;
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: bold;
      white-space: nowrap;
      z-index: 15; /* Ensure it's above the node actions */
    }
 /* --- END PREVIEW STYLES --- */

 /* --- HEATMAP STYLES --- */
    .heatmap-legend-item {
      display: flex;
      align-items: center;
      margin-right: 16px;
      font-size: 0.875rem;
      color: #374151;
    }
    .heatmap-color-box {
      width: 16px;
      height: 16px;
      margin-right: 6px;
      border-radius: 4px;
    }
    /* Sticky Column Logic */
    .sticky-col {
      position: sticky !important;
      left: 0;
      z-index: 10;
      border-right: 2px solid #e2e8f0 !important; /* Visible separator */
    }
    /* Header needs higher z-index to stay on top of body columns */
    thead th.sticky-col {
      z-index: 20;
      background-color: #f9fafb; /* Match bg-gray-50 */
    }
    /* Body cells need white background so scrolled numbers don't show behind them */
    tbody td.sticky-col {
      background-color: #ffffff;
    }

    /* --- NEW ATTACHMENT STYLES --- */
.attachment-group {
  background-color: #f8fafc;
  padding: 12px;
  border-radius: 6px;
  border: 1px solid #e2e8f0;
  margin-top: 8px;
}
.attachment-row {
  margin-bottom: 12px;
  padding-bottom: 12px;
  border-bottom: 1px solid #e2e8f0;
}
.attachment-row:last-child {
  border-bottom: none;
  margin-bottom: 0;
  padding-bottom: 0;
}
.attachment-label {
  display: block;
  font-size: 0.875rem;
  font-weight: 500;
  color: #4b5563;
  margin-bottom: 4px;
}
.required-star {
  color: #ef4444;
  margin-left: 2px;
}
.attachment-subtext {
  font-size: 0.75rem;
  color: #64748b;
  font-style: italic;
}
/* Validation Styles */
.input-error {
  border: 1px solid #ef4444 !important;
  background-color: #fef2f2;
}
.error-message {
  color: #ef4444;
  font-size: 0.75rem;
  margin-top: 4px;
  display: none; /* Hidden by default */
}
.show-error {
  display: block;
}

/* --- EDITABLE CONTENT STYLES --- */
.editable-content {
  cursor: text;
  transition: all 0.2s;
  min-height: 24px; /* Ensure empty areas are still clickable */
}
.editable-content:hover {
  background-color: #fcfcfc;
  outline: 1px dashed #cbd5e1; /* Subtle dashed border on hover */
  border-radius: 4px;
}
.editable-content:focus {
  background-color: #ffffff;
  outline: 2px solid #a855f7; /* Purple outline when typing */
  border-radius: 4px;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  z-index: 10;
  position: relative;
}

/* --- MULTI-SELECT STYLES --- */
.multiselect-container {
  border: 1px solid #d1d5db;
  border-radius: 6px;
  padding: 4px;
  background: white;
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  min-height: 42px;
}
.multiselect-container:focus-within {
  border-color: #a855f7;
  ring: 2px solid #a855f7;
}
.multiselect-tag {
  background-color: #f3e8ff;
  color: #6b21a8;
  border: 1px solid #d8b4fe;
  border-radius: 4px;
  padding: 2px 8px;
  font-size: 0.75rem;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 4px;
}
.multiselect-tag button {
  font-size: 1rem;
  line-height: 0.5;
  color: #9333ea;
  cursor: pointer;
}
.multiselect-tag button:hover {
  color: #581c87;
}
.multiselect-input {
  border: none;
  outline: none;
  flex-grow: 1;
  padding: 4px;
  font-size: 0.875rem;
  min-width: 120px;
}
.multiselect-dropdown {
  position: absolute;
  z-index: 50;
  width: 100%;
  background: white;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  max-height: 200px;
  overflow-y: auto;
  box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
  display: none;
}
.multiselect-option {
  padding: 8px 12px;
  font-size: 0.875rem;
  cursor: pointer;
  color: #374151;
}
.multiselect-option:hover {
  background-color: #f3f4f6;
}

  </style>
</head>
<body>

<div id="login-view" class="min-h-screen flex flex-col items-center justify-center bg-slate-200 p-4">
  <div class="w-full max-w-md text-center">
    <h1 class="text-4xl font-bold text-slate-800">Uratex Workforce Intelligence & Analytics Hub</h1>
    <p class="mt-2 text-slate-600">Please log in with your corporate Google account to continue.</p>
    <div id="login-button-container" class="mt-8">
      </div>
  </div>
</div>

<div id="denied-view" style="display: none;" class="min-h-screen flex flex-col items-center justify-center bg-red-100 p-4">
  <div class="w-full max-w-md text-center">
    <h1 class="text-4xl font-bold text-red-800">Access Denied</h1>
    <p class="mt-2 text-red-700">Your account (<span id="denied-email" class="font-bold"></span>) is not authorized to access this application. Please contact your administrator.</p>
  </div>
</div>

<div id="app-view" style="display: none;">

<div id="saving-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 9998; flex-direction: column; align-items: center; justify-content: center;">
  <div id="loader"></div>
  <p id="saving-text" class="text-white text-lg font-bold mt-4">Saving...</p>
</div>

<div id="employee-modal" class="modal-overlay">
  <div class="modal-content">
    <div class="flex justify-between items-center mb-4">
      <h2 id="modal-title" class="text-2xl font-bold text-slate-800">Edit Employee</h2>
      <button onclick="closeModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
    </div>
    <form id="employee-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
      <input type="hidden" id="form-mode" name="formmode">
      <input type="hidden" id="original-status" name="originalstatus">
      <div>
        <label class="block font-medium">Position ID</label>
        <input type="text" id="positionid" name="positionid" readonly class="mt-1 p-2 w-full border rounded bg-gray-100">
        <label class="block font-medium mt-2">Employee ID</label>
        <input type="text" id="employeeid" name="employeeid" class="mt-1 p-2 w-full border rounded">
        <label class="block font-medium mt-2">Employee Name</label>
        <input type="text" id="employeename" name="employeename" class="mt-1 p-2 w-full border rounded">
        <label class="block font-medium mt-2">Reporting to <span class="text-red-500">*</span></label>
        <div id="reportingto-dropdown-container" class="searchable-dropdown"></div>
        <input type="hidden" id="reportingtoid" name="reportingtoid">
        <input type="hidden" id="reportingto" name="reportingto">
        <label class="block font-medium text-xs mt-1">Reporting to ID</label>
        <input type="text" id="reportingtoid_display" readonly class="mt-1 p-2 w-full border rounded bg-gray-100 text-sm">
      </div>
      <div>
        <label class="block font-medium">Division <span class="text-red-500">*</span></label>
        <div id="division-dropdown-container" class="searchable-dropdown"></div>
        <input type="hidden" id="division" name="division">
        <label class="block font-medium mt-2">Group</label>
        <div id="group-dropdown-container" class="searchable-dropdown"></div>
        <input type="hidden" id="group" name="group">
        <label class="block font-medium mt-2">Department <span class="text-red-500">*</span></label>
        <div id="department-dropdown-container" class="searchable-dropdown"></div>
        <input type="hidden" id="department" name="department">
        <label class="block font-medium mt-2">Section <span class="text-red-500">*</span></label>
        <div id="section-dropdown-container" class="searchable-dropdown"></div>
        <input type="hidden" id="section" name="section">
      </div>
      <div>
        <label class="block font-medium">Job Title <span class="text-red-500">*</span></label>
        <div id="jobtitle-dropdown-container" class="searchable-dropdown"></div>
        <input type="hidden" id="jobtitle" name="jobtitle">
        <label class="block font-medium mt-2">Level</label>
        <div id="level-dropdown-container" class="searchable-dropdown"></div>
        <input type="hidden" id="level" name="level">
        <label class="block font-medium mt-2">Payroll Type</label>
        <div id="payrolltype-dropdown-container" class="searchable-dropdown"></div>
        <input type="hidden" id="payrolltype" name="payrolltype">
        <label class="block font-medium mt-2">Job Level</label>
        <div id="joblevel-dropdown-container" class="searchable-dropdown"></div>
        <input type="hidden" id="joblevel" name="joblevel">
        <label class="block font-medium mt-2">Contract Type</label>
        <div id="contracttype-dropdown-container" class="searchable-dropdown"></div>
        <input type="hidden" id="contracttype" name="contracttype">
        <div id="contract-end-date-wrapper" style="display: none;">
            <label class="block font-medium mt-2">Contract End Date <span class="text-red-500">*</span></label>
            <input type="date" id="contractenddate" name="contractenddate" class="mt-1 p-2 w-full border rounded">
        </div>
        <label class="block font-medium mt-2">Competency</label>
        <div id="competency-dropdown-container" class="searchable-dropdown"></div>
        <input type="hidden" id="competency" name="competency">
        <label class="block font-medium mt-2">Status</label>
        <div id="status-dropdown-container" class="searchable-dropdown"></div>
        <input type="hidden" id="status" name="status">
        <div id="start-date-wrapper" style="display: none;">
          <label class="block font-medium mt-2">Start Date in Position <span class="text-red-500">*</span></label>
          <input type="date" id="startdateinposition" name="startdateinposition" class="mt-1 p-2 w-full border rounded">
        </div>
        <div id="effective-date-wrapper" style="display: none;">
          <label id="effective-date-label" class="block font-medium mt-2"></label>
          <input type="date" id="effectivedate" name="effectivedate" class="mt-1 p-2 w-full border rounded">
        </div>
        <div id="reasonforleaving-wrapper" style="display: none;">
            <label class="block font-medium mt-2">Reason for Leaving <span class="text-red-500">*</span></label>
            <div id="reasonforleaving-dropdown-container" class="searchable-dropdown"></div>
            <input type="hidden" id="reasonforleaving" name="reasonforleaving">
        </div>
        <label class="block font-medium mt-2">Gender</label>
        <div id="gender-dropdown-container" class="searchable-dropdown"></div>
        <input type="hidden" id="gender" name="gender">
        <label class="block font-medium mt-2">Position Status</label>
        <div id="positionstatus-dropdown-container" class="searchable-dropdown"></div>
        <input type="hidden" id="positionstatus" name="positionstatus">
        <label class="block font-medium mt-2">Date Hired</label>
        <input type="date" id="datehired" name="datehired" class="mt-1 p-2 w-full border rounded">
        <label class="block font-medium mt-2">Date of Birth</label>
        <input type="date" id="dateofbirth" name="dateofbirth" class="mt-1 p-2 w-full border rounded">
      </div>
    </form>
    <div class="mt-6 flex justify-end gap-3">
      <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Cancel</button>
      <button onclick="saveEmployee()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save Changes</button>
    </div>
  </div>
</div>

<div id="jd-modal" class="modal-overlay" style="z-index: 70;">
  <div class="modal-content">
    <div class="flex justify-between items-center mb-4">
      <h2 id="jd-modal-title" class="text-2xl font-bold text-slate-800">Job Description</h2>
      <button onclick="closeJdModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
    </div>
    
    <div id="jd-content-area" class="prose max-w-none">
      </div>

    <div class="mt-6 flex justify-end">
      <button onclick="closeJdModal()" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Close</button>
    </div>
  </div>
</div>

<div id="history-modal" class="modal-overlay">
  <div class="modal-content">
    <div class="flex justify-between items-center mb-4">
      <h2 id="history-modal-title" class="text-2xl font-bold text-slate-800">Incumbency History</h2>
      <button onclick="closeHistoryModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Incumbent Name</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start Date in Position</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">End Date in Position</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tenure in Role</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Overall Hire Date</th>
          </tr>
        </thead>
        <tbody id="history-table-body" class="bg-white divide-y divide-gray-200">
        </tbody>
      </table>
    </div>
    <div class="mt-6 flex justify-end">
      <button onclick="closeHistoryModal()" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Close</button>
    </div>
  </div>
</div>

<div id="custom-tooltip" onmouseover="clearTimeout(tooltipTimeout)" onmouseout="hideTooltip()"></div>

<header class="bg-blue-800 shadow-md p-4 flex justify-between items-center sticky top-0 z-40">
  <div class="w-1/3">
    <button onclick="showHomepage()" title="Go to Homepage" class="text-white hover:bg-blue-700 rounded-full p-2">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
    </button>
    <button onclick="google.script.run.withSuccessHandler(alert).testBackendConnection()" class="ml-4 bg-yellow-400 text-black py-1 px-3 rounded">Test Backend</button>
  </div>
  <div class="w-1/3 text-center">
    <h1 class="text-xl font-bold text-white truncate">Uratex Workforce Intelligence & Analytics Hub</h1>
  </div>
  <div class="w-1/3 flex justify-end">
    <div id="user-info" class="text-sm text-slate-200"></div>
  </div>
</header>

<main class="p-4 sm:p-6 md:p-8">

  <div id="homepage-view">
    <h2 class="text-3xl font-bold text-slate-800 mb-8 text-center">Gandang Gising!</h2>
    <div class="flex justify-center">
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">

        <!-- Organizational Chart Card -->
        <div onclick="navigateToView('org', 'org-chart')" class="dashboard-card bg-white rounded-lg shadow p-6 flex flex-col items-center text-center w-80 cursor-pointer hover:shadow-xl transition-shadow">
          <svg class="h-24 w-24 mb-4 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 7.5l-9-5.25L3 7.5m18 0l-9 5.25m9-5.25v9l-9 5.25M3 7.5l9 5.25M3 7.5v9l9 5.25m0-9v9" />
          </svg>
          <h3 class="font-bold text-lg text-slate-800">Organizational Chart</h3>
          <p class="text-sm text-slate-500 mt-1">Visualize company structure and reporting lines.</p>
        </div>

        <!-- HR Data Analytics Card -->
        <div onclick="navigateToView('analytics', 'demographics')" class="dashboard-card bg-white rounded-lg shadow p-6 flex flex-col items-center text-center w-80 cursor-pointer hover:shadow-xl transition-shadow">
          <svg class="h-24 w-24 mb-4 text-teal-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
          </svg>
          <h3 class="font-bold text-lg text-slate-800">HR Data Analytics</h3>
          <p class="text-sm text-slate-500 mt-1">Explore demographics, resignation trends, and employee movement.</p>
        </div>

        <!-- Recruitment Card (Disabled) -->
        <div class="dashboard-card bg-gray-100 rounded-lg shadow p-6 flex flex-col items-center text-center w-80 cursor-not-allowed opacity-60">
          <svg class="h-24 w-24 mb-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.5 22.5c-2.996 0-5.717-.93-7.962-2.565z" />
          </svg>
          <h3 class="font-bold text-lg text-slate-600">Recruitment</h3>
          <p class="text-sm text-slate-400 mt-1">Analyze hiring pipeline and source performance. (Coming Soon)</p>
        </div>
        
        <!-- Training and Development Card (Disabled) -->
        <div class="dashboard-card bg-gray-100 rounded-lg shadow p-6 flex flex-col items-center text-center w-80 cursor-not-allowed opacity-60">
          <svg class="h-24 w-24 mb-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
          </svg>
          <h3 class="font-bold text-lg text-slate-600">Training and Development</h3>
          <p class="text-sm text-slate-400 mt-1">Track learning progress and identify skill gaps. (Coming Soon)</p>
        </div>

        <!-- Employee Competency Card -->
        <div onclick="navigateToView('competency', 'competency')" class="dashboard-card bg-white rounded-lg shadow p-6 flex flex-col items-center text-center w-80 cursor-pointer hover:shadow-xl transition-shadow">
          <svg class="h-24 w-24 mb-4 text-amber-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" />
          </svg>
          <h3 class="font-bold text-lg text-slate-800">Employee Competency</h3>
          <p class="text-sm text-slate-500 mt-1">Visualize and analyze employee skill sets and competency gaps.</p>
        </div>

        <!-- Employee Engagement Card (Disabled) -->
        <div class="dashboard-card bg-gray-100 rounded-lg shadow p-6 flex flex-col items-center text-center w-80 cursor-not-allowed opacity-60">
          <svg class="h-24 w-24 mb-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345h5.364c.518 0 .734.654.372 1.01l-4.36 3.176a.563.563 0 00-.182.557l1.652 5.023a.563.563 0 01-.84.622l-4.43-3.232a.563.563 0 00-.652 0l-4.43 3.232a.563.563 0 01-.84-.622l1.652-5.023a.563.563 0 00-.182-.557l-4.36-3.176a.563.563 0 01.372-1.01h5.364a.563.563 0 00.475-.345L11.48 3.5z" />
          </svg>
          <h3 class="font-bold text-lg text-slate-600">Employee Engagement</h3>
          <p class="text-sm text-slate-400 mt-1">Measure and improve workforce satisfaction. (Coming Soon)</p>
        </div>

        <!-- Employee Commuting Card (Disabled) -->
        <div class="dashboard-card bg-gray-100 rounded-lg shadow p-6 flex flex-col items-center text-center w-80 cursor-not-allowed opacity-60">
          <svg class="h-24 w-24 mb-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 6.75V15m6-6v8.25m.503 3.498l4.875-2.437c.381-.19.622-.58.622-1.006V4.82c0-.836-.88-1.37-1.628-1.006l-3.869 1.934c-.317.159-.69.159-1.006 0L9.503 3.252a1.125 1.125 0 00-1.006 0L3.875 5.69c-.381.19-.622.58-.622-1.006V15.18c0 .836.88 1.37 1.628 1.006l3.869-1.934c.317-.159.69-.159-1.006 0l4.875 2.437a1.125 1.125 0 001.006 0z" />
          </svg>
          <h3 class="font-bold text-lg text-slate-600">Employee Commuting</h3>
          <p class="text-sm text-slate-400 mt-1">Analyze employee travel patterns and logistics. (Coming Soon)</p>
        </div>

        <!-- Predictive Insight Card -->
        <div onclick="navigateToView('predictive', 'predictive')" class="dashboard-card bg-white rounded-lg shadow p-6 flex flex-col items-center text-center w-80 cursor-pointer hover:shadow-xl transition-shadow">
          <svg class="h-24 w-24 mb-4 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519 2.25 2.25 0 012.185 2.185.683.683 0 01-.546.636l-3.876 1.162A2.25 2.25 0 0016.5 21h-5.25a2.25 2.25 0 01-2.25-2.25V18m-3.375-3.375L1.5 15m0 0l3.375 3.375M1.5 15h16.5" />
          </svg>
          <h3 class="font-bold text-lg text-slate-800">Predictive Insight</h3>
          <p class="text-sm text-slate-500 mt-1">Forecast attrition risk and analyze hiring trends.</p>
        </div>

      </div>
    </div>
  </div>

<div id="tab-area" style="display:none;">

  <div class="flex justify-between items-center mb-6">
    <h1 id="main-title" class="text-3xl font-bold text-slate-800">Uratex Workforce Intelligence & Analytics Hub</h1>
    <div id="header-controls" class="flex items-center space-x-4 ml-auto">
        <div class="flex items-center">
            <input type="checkbox" id="show-inactive-checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
            <label for="show-inactive-checkbox" class="ml-2 block text-sm font-medium text-gray-700">Show Inactive Positions</label>
        </div>
        <button onclick="openAIJDModal()" class="bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 flex items-center shadow-md">
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
      AI JD Builder
    </button>
        <button id="request-change-btn" onclick="openRequestModal()" class="hidden bg-yellow-500 text-white py-2 px-4 rounded-lg hover:bg-yellow-600">Request Change to Org Chart</button>
        <button id="add-employee-btn" onclick="openModal('add')" class="hidden bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700">Add New Position</button>
    </div>
  </div>

  <!-- Tab Navigation -->
  <div class="border-b border-gray-200 mb-6">
  <nav id="tab-navigation" class="flex -mb-px" aria-label="Tabs">
    <div onclick="switchTab('org-chart')" id="tab-org-chart" class="tab active org-view-tab">Org Chart</div>
    <div onclick="switchTab('my-requests')" id="tab-my-requests" class="tab org-view-tab" style="display: none;">My Requests
      <span id="pending-requests-badge" class="notification-badge ml-2" style="display: none;"></span>
      <span id="rejected-requests-badge" class="notification-badge-rejected ml-1" style="display: none;"></span>
    </div>
    <div onclick="switchTab('approvals')" id="tab-approvals" class="tab org-view-tab" style="display: none;">Approvals
      <span id="pending-approvals-badge" class="notification-badge ml-2" style="display: none;"></span>
    </div>
    <div onclick="switchTab('demographics')" id="tab-demographics" class="tab analytics-view-tab">Demographics</div>
    <div onclick="switchTab('resignation')" id="tab-resignation" class="tab analytics-view-tab">Resignation</div>
    <div onclick="switchTab('employee-movement')" id="tab-employee-movement" class="tab analytics-view-tab">Employee Movement</div>
    <div onclick="switchTab('masterlist')" id="tab-masterlist" class="tab analytics-view-tab">Masterlist</div>
    <div onclick="switchTab('predictive')" id="tab-predictive" class="tab predictive-view-tab">Predictive Insights</div>
  </nav>
</div>

  <!-- Org Chart View -->
  <div id="org-chart-view" class="tab-content active">
    <div id="notifications-container" class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-6"></div>
    <div class="p-4 sm:p-6 rounded-lg mb-6 bg-white shadow-md">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Filter by Division</label>
        <div id="division-filter-container" class="searchable-dropdown mt-1"></div>
        <input type="hidden" id="division-filter-value" value="all">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Filter by Group</label>
        <div id="group-filter-container" class="searchable-dropdown mt-1"></div>
        <input type="hidden" id="group-filter-value" value="all">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Filter by Department</label>
        <div id="department-filter-container" class="searchable-dropdown mt-1"></div>
        <input type="hidden" id="department-filter-value" value="all">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Filter by Section</label>
        <div id="section-filter-container" class="searchable-dropdown mt-1"></div>
        <input type="hidden" id="section-filter-value" value="all">
      </div>
    </div>
    <button id="reset-filters-btn" class="w-full bg-slate-700 text-white py-2 mt-4 rounded-lg hover:bg-slate-800">Reset Filters</button>
  </div>
  <div id="headcount-cards-container" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <div id="filtered-headcount-card" class="bg-blue-100 border-l-4 border-blue-500 text-blue-800 p-4 rounded-md shadow"></div>
    <div id="plantilla-headcount-card" class="bg-gray-100 border-l-4 border-gray-500 text-gray-800 p-4 rounded-md shadow"></div>
  </div>
  <div class="space-y-4 mb-6">
    <details class="bg-white rounded-lg shadow-md group">
      <summary class="w-full text-left p-4 flex justify-between items-center font-bold text-xl text-slate-800 cursor-pointer"><span>Overall Headcount Summary</span><svg class="w-6 h-6 transition-transform transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></summary>
      <div id="overall-summary-content" class="p-4 border-t border-gray-200">
        <p>Loading summary...</p>
      </div>
    </details>
  </div>
  <div class="space-y-4 mb-6">
    <details class="bg-white rounded-lg shadow-md group">
      <summary class="w-full text-left p-4 flex justify-between items-center font-bold text-xl text-slate-800 cursor-pointer"><span>Legends</span><svg class="w-6 h-6 transition-transform transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></summary>
      <div class="p-4 border-t border-gray-200">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div>
            <h3 class="font-bold text-lg mb-3 text-slate-700">Badge Legend</h3>
            <div class="space-y-2 text-sm">
              <div class="flex items-center">
                <div class="badge bg-badge-payroll mr-2">P</div>Payroll Type
              </div>
              <div class="flex items-center">
                <div class="badge bg-badge-joblevel mr-2">JL</div>Job Level
              </div>
              <div class="flex items-center">
                <div class="badge bg-badge-contract mr-2">C</div>Contract Type
              </div>
              <div class="flex items-center">
                <div class="badge bg-badge-competency mr-2">C</div>Competency
              </div>
            </div>
          </div>
          <div>
            <h3 class="font-bold text-lg mb-3 text-slate-700">Box legend</h3>
            <div id="level-legend" class="space-y-2 text-sm"></div>
          </div>
          <div>
            <h3 class="font-bold text-lg mb-3 text-slate-700">Jobcon Contract Type Legend</h3>
            <div class="space-y-2 text-sm">
              <div class="flex items-center">
                <div class="w-4 h-4 mr-2 border-2 border-dashed" style="border-color: #f97316; background-color: #ffedd5;"></div>
                <span>JREL / JPRO</span>
              </div>
              <div class="flex items-center">
                <div class="w-4 h-4 mr-2 border-2 border-dashed" style="border-color: #3b82f6; background-color: #dbeafe;"></div>
                <span>JREG</span>
              </div>
              <div class="flex items-center">
                <div class="w-4 h-4 mr-2 border-2 border-dashed" style="border-color: #6b7280; background-color: #e5e7eb;"></div>
                <span>OTHERS</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </details>
  </div>
  <div class="space-y-4 mb-6">
    <details class="bg-white rounded-lg shadow-md group" open>
      <summary class="w-full text-left p-4 flex justify-between items-center font-bold text-xl text-slate-800 cursor-pointer"><span>Approval Status</span><svg class="w-6 h-6 transition-transform transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></summary>
      <div id="approval-section" class="p-4 border-t border-gray-200">
        <p>Loading approval status...</p>
      </div>
    </details>
  </div>
  <div class="bg-white rounded-lg shadow-md p-4 relative">
    <div class="absolute top-4 right-4 z-10 flex space-x-2">
      <button onclick="exportChart('png')" title="Export as PNG" class="bg-blue-600 text-white py-2 px-4 rounded-lg text-sm font-semibold hover:bg-blue-700 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></svg>PNG</button>
      <button onclick="exportChart('pdf')" title="Export as PDF" class="bg-red-600 text-white py-2 px-4 rounded-lg text-sm font-semibold hover:bg-red-700 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>PDF</button>
      <button onclick="zoom(0.1)" class="bg-slate-600 text-white w-8 h-8 rounded-full font-bold text-xl flex items-center justify-center">+</button>
      <button onclick="zoom(-0.1)" class="bg-slate-600 text-white w-8 h-8 rounded-full font-bold text-xl flex items-center justify-center">-</button>
    </div>
    <div id="chart-wrapper" class="w-full h-[85vh] overflow-auto">
      <div id="loader-container" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-75 z-20">
        <div id="loader"></div>
      </div>
      <div id="chart_div" style="transform-origin: top left;"></div>
    </div>
  </div>
  </div> <!-- Close org-chart-view -->

  <!-- Demographics View -->
  <div id="demographics-view" class="tab-content">
    <div class="p-4 sm:p-6 rounded-lg mb-6 bg-white shadow-md">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">Division</label>
                <div id="analytics-division-filter-container" class="searchable-dropdown mt-1"></div>
                <input type="hidden" id="analytics-division-filter-value" value="all">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Group</label>
                <div id="analytics-group-filter-container" class="searchable-dropdown mt-1"></div>
                <input type="hidden" id="analytics-group-filter-value" value="all">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Department</label>
                <div id="analytics-department-filter-container" class="searchable-dropdown mt-1"></div>
                <input type="hidden" id="analytics-department-filter-value" value="all">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Section</label>
                <div id="analytics-section-filter-container" class="searchable-dropdown mt-1"></div>
                <input type="hidden" id="analytics-section-filter-value" value="all">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Job Level</label>
                <div id="analytics-joblevel-filter-container" class="searchable-dropdown mt-1"></div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Position Status</label>
                <div id="analytics-pos-status-filter-container" class="searchable-dropdown mt-1"></div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Gender</label>
                <div id="analytics-gender-filter-container" class="searchable-dropdown mt-1"></div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Job Title</label>
                <div id="analytics-jobtitle-filter-container" class="searchable-dropdown mt-1"></div>
            </div>
        </div>
        <div class="flex justify-between items-start gap-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-2/3">
                <div id="analytics-headcount-card" class="summary-card bg-indigo-100 border-l-4 border-indigo-500 text-indigo-800 p-4 rounded-md shadow">
                    <h3 class="font-bold text-lg mb-2">Total Headcount</h3>
                    <p class="text-3xl font-bold">--</p>
                </div>
                 <div id="analytics-vacant-card" class="summary-card bg-gray-100 border-l-4 border-gray-500 text-gray-800 p-4 rounded-md shadow">
                    <h3 class="font-bold text-lg mb-2">Vacant</h3>
                    <p class="text-3xl font-bold">--</p>
                </div>
            </div>
            <div class="flex space-x-2">
                <button id="analytics-reset-filters-btn" class="bg-slate-700 text-white py-2 px-4 rounded-lg hover:bg-slate-800">Reset Filters</button>
                <button onclick="drawAnalyticsCharts(true)" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 font-semibold flex items-center">
                    <svg class="w-5 h-5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 4l5 5M20 20l-5-5"></path></svg>
                    Refresh Data
                </button>
            </div>
        </div>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <div class="chart-card">
        <div class="chart-card-header header-demographics"><h3 class="text-xl">Employees by Gender</h3></div>
        <div class="chart-card-body"><div id="gender_chart_div" style="width: 100%; height: 350px;"></div></div>
      </div>
      <div class="chart-card">
        <div class="chart-card-header header-demographics"><h3 class="text-xl">Employees by Age Generation</h3></div>
        <div class="chart-card-body">
            <div id="age_generation_chart_div" style="width: 100%; height: 350px;"></div>
            <div class="text-xs text-gray-600 mt-4 border-t pt-2">
                <p>
                    <b class="italic">Generation Age Ranges:</b>
                    <i class="ml-2">1946 - 1964 BABY BOOMERS ; 1965 - 1980 GENERATION X ; 1981 - 1996 MILLENNIALS ; 1997 - 2012 GEN Z</i>
                </p>
            </div>
        </div>
      </div>
    </div>
    <div class="mt-8 grid grid-cols-1 gap-8">
        <div class="chart-card">
            <div class="chart-card-header header-demographics"><h3 class="text-xl">Monthly New Hires (Last 12 Months)</h3></div>
            <div class="chart-card-body"><div id="new_hires_chart_div" style="width: 100%; height: 350px;"></div></div>
        </div>
    </div>
    <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-8">
        <div class="chart-card">
            <div class="chart-card-header header-demographics"><h3 class="text-xl">Employees by Status</h3></div>
            <div class="chart-card-body"><div id="status_chart_div" style="width: 100%; height: 350px;"></div></div>
        </div>
        <div class="chart-card">
            <div class="chart-card-header header-demographics"><h3 class="text-xl">Employees by Contract Type</h3></div>
            <div class="chart-card-body"><div id="contract_chart_div" style="width: 100%; height: 350px;"></div></div>
        </div>
        <div class="chart-card">
            <div class="chart-card-header header-demographics"><h3 class="text-xl">Employees by Job Group</h3></div>
            <div class="chart-card-body"><div id="job_group_chart_div" style="width: 100%; height: 350px;"></div></div>
        </div>
        <div class="chart-card">
            <div class="chart-card-header header-demographics"><h3 class="text-xl">Employees by Length of Service</h3></div>
            <div class="chart-card-body"><div id="los_chart_div" style="width: 100%; height: 350px;"></div></div>
        </div>
    </div>
  </div>

  <!-- Resignation View -->
<div id="resignation-view" class="tab-content">
    <div class="p-4 sm:p-6 rounded-lg mb-6 bg-white shadow-md">
        <div class="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-5 gap-4 mb-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">Division</label>
                <div id="resignation-division-filter-container" class="searchable-dropdown mt-1"></div>
                <input type="hidden" id="resignation-division-filter-value" value="all">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Group</label>
                <div id="resignation-group-filter-container" class="searchable-dropdown mt-1"></div>
                <input type="hidden" id="resignation-group-filter-value" value="all">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Department</label>
                <div id="resignation-department-filter-container" class="searchable-dropdown mt-1"></div>
                <input type="hidden" id="resignation-department-filter-value" value="all">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Section</label>
                <div id="resignation-section-filter-container" class="searchable-dropdown mt-1"></div>
                <input type="hidden" id="resignation-section-filter-value" value="all">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Job Level</label>
                <div id="resignation-joblevel-filter-container" class="searchable-dropdown mt-1"></div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Gender</label>
                <div id="resignation-gender-filter-container" class="searchable-dropdown mt-1"></div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Job Title</label>
                <div id="resignation-jobtitle-filter-container" class="searchable-dropdown mt-1"></div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Year</label>
                <div id="resignation-year-filter-container" class="searchable-dropdown mt-1"></div>
            </div>
             <div>
                <label class="block text-sm font-medium text-gray-700">Month</label>
                <div id="resignation-month-filter-container" class="searchable-dropdown mt-1"></div>
            </div>
        </div>
        <div class="flex justify-between items-start gap-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-1/2">
                <div id="resignation-headcount-card" class="summary-card bg-red-100 border-l-4 border-red-500 text-red-800 p-4 rounded-md shadow">
                    <h3 class="font-bold text-lg mb-2">Resigned</h3>
                    <p class="text-3xl font-bold">--</p>
                </div>
                <div id="resignation-hired-card" class="summary-card bg-blue-100 border-l-4 border-blue-500 text-blue-800 p-4 rounded-md shadow">
                    <h3 class="font-bold text-lg mb-2">Hired</h3>
                    <p class="text-3xl font-bold">--</p>
                </div>
            </div>
            <div class="flex space-x-2">
                <button id="resignation-reset-filters-btn" class="bg-slate-700 text-white py-2 px-4 rounded-lg hover:bg-slate-800">Reset Filters</button>
                <button onclick="drawResignationCharts(true)" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 font-semibold flex items-center">
                    <svg class="w-5 h-5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 4l5 5M20 20l-5-5"></path></svg>
                    Refresh Data
                </button>
            </div>
        </div>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
    <div class="chart-card">
        <div class="chart-card-header header-resignation"><h3 class="text-xl">YTD Turnover Rate</h3></div>
        <div class="chart-card-body">
            <div id="ytd_turnover_chart_div" style="width: 100%; height: 350px;"></div>
            <div class="mt-2 pt-2 border-t border-gray-200">
                <p class="text-xs italic text-gray-600">
                    Formula: (Total Resignations / Average Headcount for the Period) * 100
                </p>
            </div>
        </div>
    </div>

    <div class="chart-card">
        <div class="chart-card-header header-resignation"><h3 class="text-xl">YTD Attrition Rate</h3></div>
        <div class="chart-card-body">
            <div id="attrition_rate_chart_div" style="width: 100%; height: 350px;"></div>
            <div class="mt-2 pt-2 border-t border-gray-200">
                <p class="text-xs italic text-gray-600">
                    Formula: (Positions Made Inactive / Average Headcount for the Period) * 100
                </p>
            </div>
        </div>
    </div>

    <div class="chart-card">
        <div class="chart-card-header header-resignation"><h3 class="text-xl">YTD Retention Rate</h3></div>
        <div class="chart-card-body">
            <div id="retention_rate_chart_div" style="width: 100%; height: 350px;"></div>
            <div class="mt-2 pt-2 border-t border-gray-200">
                <p class="text-xs italic text-gray-600">
                    Formula: ((Starting Headcount - Total Resignations) / Starting Headcount) * 100
                </p>
            </div>
        </div>
    </div>
</div>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="chart-card lg:col-span-2">
            <div class="chart-card-header header-resignation"><h3 class="text-xl">Monthly Separations</h3></div>
            <div class="chart-card-body"><div id="monthly_turnover_chart_div" style="width: 100%; height: 350px;"></div></div>
        </div>
        <div class="chart-card">
            <div class="chart-card-header header-resignation"><h3 class="text-xl">Reason for Leaving</h3></div>
            <div class="chart-card-body"><div id="reason_chart_div" style="width: 100%; height: 350px;"></div></div>
        </div>
        <div class="chart-card">
            <div class="chart-card-header header-resignation"><h3 class="text-xl">Resignation by Gender</h3></div>
            <div class="chart-card-body"><div id="resignation_gender_chart_div" style="width: 100%; height: 350px;"></div></div>
        </div>
        <div class="chart-card">
            <div class="chart-card-header header-resignation"><h3 class="text-xl">Resignation by Contract Type</h3></div>
            <div class="chart-card-body"><div id="resignation_contract_chart_div" style="width: 100%; height: 350px;"></div></div>
        </div>
        <div class="chart-card">
            <div class="chart-card-header header-resignation"><h3 class="text-xl">Resignation by Division</h3></div>
            <div class="chart-card-body"><div id="resignation_division_chart_div" style="width: 100%; height: 350px;"></div></div>
        </div>
        <div class="chart-card">
            <div class="chart-card-header header-resignation"><h3 class="text-xl">Resignation by Job Group</h3></div>
            <div class="chart-card-body"><div id="resignation_job_group_chart_div" style="width: 100%; height: 350px;"></div></div>
        </div>
        <div class="chart-card">
            <div class="chart-card-header header-resignation"><h3 class="text-xl">Yearly Hires and Leavers</h3></div>
            <div class="chart-card-body"><div id="hires_leavers_chart_div" style="width: 100%; height: 350px;"></div></div>
        </div>
    </div>
  </div>

  <!-- Employee Movement View -->
<div id="employee-movement-view" class="tab-content">
    <div class="p-4 sm:p-6 rounded-lg mb-6 bg-white shadow-md">
        <div class="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-5 gap-4 mb-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">Division</label>
                <div id="movement-division-filter-container" class="searchable-dropdown mt-1"></div>
                <input type="hidden" id="movement-division-filter-value" value="all">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Group</label>
                <div id="movement-group-filter-container" class="searchable-dropdown mt-1"></div>
                <input type="hidden" id="movement-group-filter-value" value="all">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Department</label>
                <div id="movement-department-filter-container" class="searchable-dropdown mt-1"></div>
                <input type="hidden" id="movement-department-filter-value" value="all">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Section</label>
                <div id="movement-section-filter-container" class="searchable-dropdown mt-1"></div>
                <input type="hidden" id="movement-section-filter-value" value="all">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Job Level</label>
                <div id="movement-joblevel-filter-container" class="searchable-dropdown mt-1"></div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Gender</label>
                <div id="movement-gender-filter-container" class="searchable-dropdown mt-1"></div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Job Title</label>
                <div id="movement-jobtitle-filter-container" class="searchable-dropdown mt-1"></div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Year</label>
                <div id="movement-year-filter-container" class="searchable-dropdown mt-1"></div>
            </div>
             <div>
                <label class="block text-sm font-medium text-gray-700">Month</label>
                <div id="movement-month-filter-container" class="searchable-dropdown mt-1"></div>
            </div>
        </div>
        <div class="flex justify-between items-start gap-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-1/2">
                <div id="movement-promoted-card" class="summary-card bg-green-100 border-l-4 border-green-500 text-green-800 p-4 rounded-md shadow">
    <h3 class="font-bold text-lg mb-2">Promoted</h3>
    <p class="text-3xl font-bold">--</p>
</div>
 <div id="movement-transferred-card" class="summary-card bg-purple-100 border-l-4 border-purple-500 text-purple-800 p-4 rounded-md shadow">
    <h3 class="font-bold text-lg mb-2">Transferred</h3>
    <p class="text-3xl font-bold">--</p>
</div>
            </div>
            <div class="flex space-x-2">
                <button id="movement-reset-filters-btn" class="bg-slate-700 text-white py-2 px-4 rounded-lg hover:bg-slate-800">Reset Filters</button>
                <button onclick="drawEmployeeMovementCharts(true)" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 font-semibold flex items-center">
                    <svg class="w-5 h-5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 4l5 5M20 20l-5-5"></path></svg>
                    Refresh Data
                </button>
            </div>
        </div>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="chart-card">
            <div class="chart-card-header header-movement"><h3 class="text-xl">Promotions by Department</h3></div>
            <div class="chart-card-body"><div id="promo_by_dept_chart_div" style="width: 100%; height: 350px;"></div></div>
        </div>
        <div class="chart-card">
            <div class="chart-card-header header-movement"><h3 class="text-xl">Transfers by Department</h3></div>
            <div class="chart-card-body"><div id="transfer_by_dept_chart_div" style="width: 100%; height: 350px;"></div></div>
        </div>
        <div class="chart-card">
            <div class="chart-card-header header-movement"><h3 class="text-xl">Promotion Rate</h3></div>
            <div class="chart-card-body">
                <div id="promotion_rate_chart_div" style="width: 100%; height: 350px;"></div>
                <div class="mt-2 pt-2 border-t border-gray-200">
                    <p class="text-xs italic text-gray-600">
                        Formula: (Total Promotions / Average Headcount for the Period) * 100
                    </p>
                </div>
            </div>
        </div>
        <div class="chart-card">
            <div class="chart-card-header header-movement"><h3 class="text-xl">Transfer Rate</h3></div>
            <div class="chart-card-body">
                <div id="transfer_rate_chart_div" style="width: 100%; height: 350px;"></div>
                <div class="mt-2 pt-2 border-t border-gray-200">
                    <p class="text-xs italic text-gray-600">
                        Formula: (Total Transfers / Average Headcount for the Period) * 100
                    </p>
                </div>
            </div>
        </div>
    </div>
  </div>

<div id="masterlist-view" class="tab-content">
    <div class="p-4 sm:p-6 rounded-lg mb-6 bg-white shadow-md">
        <div class="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-5 gap-4 mb-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">Division</label>
                <div id="masterlist-Division-filter-container" class="searchable-dropdown mt-1"></div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Group</label>
                <div id="masterlist-Group-filter-container" class="searchable-dropdown mt-1"></div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Department</label>
                <div id="masterlist-Department-filter-container" class="searchable-dropdown mt-1"></div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Section</label>
                <div id="masterlist-Section-filter-container" class="searchable-dropdown mt-1"></div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Job Level</label>
                <div id="masterlist-JobLevel-filter-container" class="searchable-dropdown mt-1"></div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Gender</label>
                <div id="masterlist-Gender-filter-container" class="searchable-dropdown mt-1"></div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Job Title</label>
                <div id="masterlist-JobTitle-filter-container" class="searchable-dropdown mt-1"></div>
            </div>
        </div>
        <div class="flex justify-end items-center gap-4 mt-4">
    <button id="masterlist-reset-filters-btn" class="bg-slate-700 text-white py-2 px-4 rounded-lg hover:bg-slate-800">Reset Filters</button>
    <button id="masterlist-apply-filters-btn" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">Apply Filters</button>
</div>
    </div>
    <div class="p-4 sm:p-6 bg-white rounded-lg shadow-md">
        <table id="masterlist-table" class="display" style="width:100%">
            </table>
    </div>
  </div>

  <div id="competency-view" class="tab-content">
    
    <h2 class="text-3xl font-bold text-slate-800 mb-6">Employee Competency</h2>

    <div class="p-4 sm:p-6 bg-white rounded-lg shadow-md">
        
        <div class="flex flex-col md:flex-row justify-between items-center mb-6">
            <h3 id="competency-card-title" class="text-xl font-bold text-slate-800 mb-4 md:mb-0">
                Employee Competency Profile
            </h3>

            <div id="competency-view-toggle" class="flex space-x-1 bg-gray-200 p-1 rounded-lg">
                <button id="show-individual-profile" class="px-3 py-1 text-sm font-medium rounded-md bg-white shadow text-blue-700">Individual Profile</button>
                <button id="show-team-heatmap" class="px-3 py-1 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-300">Team Heatmap</button>
            </div>
        </div>

        <div id="individual-profile-view">
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-4 mb-4 bg-gray-50 p-4 rounded border">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Division</label>
                    <div id="comp-division-filter-container" class="searchable-dropdown mt-1"></div>
                    <input type="hidden" id="comp-division-filter-value" value="all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Group</label>
                    <div id="comp-group-filter-container" class="searchable-dropdown mt-1"></div>
                    <input type="hidden" id="comp-group-filter-value" value="all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Department</label>
                    <div id="comp-department-filter-container" class="searchable-dropdown mt-1"></div>
                    <input type="hidden" id="comp-department-filter-value" value="all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Section</label>
                    <div id="comp-section-filter-container" class="searchable-dropdown mt-1"></div>
                    <input type="hidden" id="comp-section-filter-value" value="all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Employee Name</label>
                    <div id="comp-employee-filter-container" class="searchable-dropdown mt-1"></div>
                    <input type="hidden" id="competency-employee-select" value=""> 
                    
                    <button onclick="resetCompetencyFilters()" class="mt-3 w-full bg-rose-600 text-white py-2 px-4 rounded hover:bg-rose-700 font-semibold shadow text-sm">
                        Reset Filter
                    </button>
                </div>
            </div>
        </div>

    <div id="individual-profile-content">
            <div id="competency-dashboard-grid" class="mt-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" style="display: none;">
                <div class="bg-white rounded-lg shadow-md p-4 flex flex-col items-center justify-center h-full min-h-[280px]">
                    <h3 class="text-md font-bold text-slate-700 mb-2 text-center">Current Overall Score</h3>
                    <div id="gauge-chart-div" class="flex justify-center items-center flex-grow"></div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4 border-t-4 border-green-500 h-full min-h-[280px] flex flex-col">
                    <div class="flex items-center mb-4 shrink-0">
                        <div class="p-2 bg-green-100 rounded-full mr-3">
                            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                        </div>
                        <h3 class="text-md font-bold text-slate-800">Top Strengths</h3>
                    </div>
                    <ul id="strengths-list" class="space-y-3 text-sm overflow-y-auto flex-grow"></ul>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4 border-t-4 border-red-500 h-full min-h-[280px] flex flex-col">
                    <div class="flex items-center mb-4 shrink-0">
                        <div class="p-2 bg-red-100 rounded-full mr-3">
                            <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        </div>
                        <h3 class="text-md font-bold text-slate-800">Development Areas</h3>
                    </div>
                    <ul id="gaps-list" class="space-y-3 text-sm overflow-y-auto flex-grow"></ul>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4 flex flex-col h-full min-h-[280px]">
                    <h3 class="text-md font-bold text-slate-700 mb-2 text-center">Development Over Time</h3>
                    <div class="relative w-full flex-grow flex items-center justify-center">
                        <canvas id="historical-competency-chart" style="max-height: 220px;"></canvas>
                    </div>
                </div>
            </div>
            <div id="competency-charts-loader" class="flex justify-center items-center h-64 mt-8" style="display: none;"><div id="loader"></div></div>
            <div id="competency-charts-container" class="mt-8 flex flex-col gap-8" style="display: none;">
                <div id="core-section" class="bg-white rounded-lg shadow-md p-6"></div>
                <div id="leadership-section" class="bg-white rounded-lg shadow-md p-6"></div>
                <div id="technical-section" class="bg-white rounded-lg shadow-md p-6"></div>
            </div>
        </div>

    <!-- New Team Competency Heatmap Section -->
    <div id="team-competency-section" class="mt-0" style="display: none;">
            
            <div class="flex justify-end mb-4">
                <div id="heatmap-legend" class="flex flex-wrap p-2 bg-gray-50 rounded border border-gray-200 items-center shadow-sm text-sm" style="display: none;">
                    <span class="font-bold text-gray-700 mr-3">Legend:</span>
                    <div class="heatmap-legend-item"><div class="heatmap-color-box" style="background-color: #16a34a;"></div>4 (Innovator)</div>
                    <div class="heatmap-legend-item"><div class="heatmap-color-box" style="background-color: #22c55e;"></div>3 (Knowledge Sharer)</div>
                    <div class="heatmap-legend-item"><div class="heatmap-color-box" style="background-color: #facc15;"></div>2 (Competent)</div>
                    <div class="heatmap-legend-item"><div class="heatmap-color-box" style="background-color: #f97316;"></div>1 (Learner)</div>
                    <div class="heatmap-legend-item"><div class="heatmap-color-box" style="background-color: #f3f4f6; border: 1px solid #ccc;"></div>N/A</div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6 bg-gray-50 p-4 rounded border">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Division</label>
                    <div id="heatmap-division-filter-container" class="searchable-dropdown mt-1"></div>
                    <input type="hidden" id="heatmap-division-filter-value" value="all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Group</label>
                    <div id="heatmap-group-filter-container" class="searchable-dropdown mt-1"></div>
                    <input type="hidden" id="heatmap-group-filter-value" value="all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Department</label>
                    <div id="heatmap-department-filter-container" class="searchable-dropdown mt-1"></div>
                    <input type="hidden" id="heatmap-department-filter-value" value="all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Section</label>
                    <div id="heatmap-section-filter-container" class="searchable-dropdown mt-1"></div>
                    <input type="hidden" id="heatmap-section-filter-value" value="all">
                </div>
                <div class="flex items-end gap-2">
                    <button onclick="resetHeatmapFilters()" class="bg-slate-700 text-white py-2 px-3 rounded hover:bg-slate-800 font-semibold shadow" title="Reset Filters">
                        Reset
                    </button>
                    <button onclick="triggerHeatmapDraw()" class="flex-grow bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 font-semibold shadow">
                        Generate
                    </button>
                </div>
            </div>

        <div id="heatmap-loader" class="flex justify-center items-center h-48" style="display: none;"><div id="loader"></div></div>
            <div id="heatmap-container" class="overflow-x-auto" style="max-height: 70vh;"></div>
        </div>
    </div>

        <div id="heatmap-legend" class="flex flex-wrap p-3 mb-4 bg-white rounded border border-gray-200 items-center shadow-sm" style="display: none;">
            <span class="font-bold text-sm text-gray-700 mr-4">Legend:</span>
            <div class="heatmap-legend-item"><div class="heatmap-color-box" style="background-color: #16a34a;"></div>4 (Innovator)</div>
            <div class="heatmap-legend-item"><div class="heatmap-color-box" style="background-color: #22c55e;"></div>3 (Knowledge Sharer)</div>
            <div class="heatmap-legend-item"><div class="heatmap-color-box" style="background-color: #facc15;"></div>2 (Competent)</div>
            <div class="heatmap-legend-item"><div class="heatmap-color-box" style="background-color: #f97316;"></div>1 (Learner)</div>
            <div class="heatmap-legend-item"><div class="heatmap-color-box" style="background-color: #f3f4f6; border: 1px solid #ccc;"></div>N/A</div>
        </div>

        <div id="heatmap-loader" class="flex justify-center items-center h-48" style="display: none;"><div id="loader"></div></div>

        <div id="heatmap-container" class="overflow-x-auto" style="max-height: 70vh;">
            </div>
    </div>
            </div>
            <!-- Heatmap table will be generated here by JavaScript -->
        </div>
    </div>

    <!-- New Competency Deep Dive Modal -->
    <div id="competency-deep-dive-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 id="deep-dive-modal-title" class="text-2xl font-bold text-slate-800">Competency Deep Dive</h2>
                <button onclick="closeDeepDiveModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="deep-dive-content" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h3 class="text-xl font-bold text-slate-700 mb-4 text-center">Score Comparison</h3>
                    <canvas id="deep-dive-bar-chart"></canvas>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-slate-700 mb-4 text-center">Top Performers</h3>
                    <ul id="top-performers-list" class="space-y-2"></ul>
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button onclick="closeDeepDiveModal()" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>
</main> <!-- Close main content area -->

    <div id="request-details-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="flex justify-between items-center mb-4">
          <h2 id="request-details-modal-title" class="text-2xl font-bold text-slate-800">Request Details</h2>
          <button onclick="closeRequestDetailsModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
        </div>
        <div id="request-details-modal-body" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
          </div>
        <div id="request-details-modal-footer" class="mt-6 flex justify-end gap-3">
          </div>
      </div>
    </div>
</div> <!-- Close app -->

<!-- Request Change Modal -->
<div id="request-modal" class="modal-overlay">
  <div class="modal-content">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold text-slate-800">Request Change to Org Chart</h2>
      <button onclick="closeRequestModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
    </div>
    <form id="request-form">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block font-medium">Request Type</label>
          <select id="request-type" name="requesttype" class="mt-1 p-2 w-full border rounded">
            <option value="">-- Select a Request Type --</option>
            <option value="Lateral Transfer">Lateral Transfer</option>
            <option value="Promotion">Promotion</option>
            <option value="Internal Transfer">Internal Transfer</option>
            <option value="Hiring of a new employee (newly created position)">Hiring of a new employee (newly created position)</option>
            <option value="Hiring of a new employee (replacement for vacancy)">Hiring of a new employee (replacement for vacancy)</option>
            <option value="Change in Employment Status">Change in Employment Status</option>
            <option value="Change in Reporting line">Change in Reporting line</option>
            <option value="Job Title/Position Change (without promotion)">Job Title/Position Change (without promotion)</option>
            <option value="Name Correction/Update of Employee Information">Name Correction/Update of Employee Information</option>
            <option value="Position on Hold/Cancelled/Deleted">Position on Hold/Cancelled/Deleted</option>
            <option value="Regularization">Regularization</option>
            <option value="Resignation/Separation">Resignation/Separation</option>
          </select>
        </div>
        <div>
          <label class="block font-medium">Select Approver <span class="text-red-500">*</span></label>
          <select id="approver-email-select" name="ApproverEmail" class="mt-1 p-2 w-full border rounded">
            <option value="">Loading approvers...</option>
          </select>
        </div>
        <div id="request-fields" class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>
      <div class="mt-6 flex justify-end gap-3">
        <button type="button" onclick="closeRequestModal()" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Cancel</button>
        <button type="button" onclick="submitRequest()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Submit Request</button>
      </div>
    </form>
  </div>
</div>

<div id="ai-jd-modal" class="modal-overlay" style="z-index: 100;">
  <div class="modal-content" style="max-width: 1000px; width: 95%; height: 90vh; display: flex; flex-direction: column;">
    
    <div class="flex justify-between items-center mb-4 border-b pb-2">
      <div class="flex items-center">
        <div class="p-2 bg-purple-100 rounded-full mr-3">
          <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
        </div>
        <h2 class="text-2xl font-bold text-slate-800">AI Job Description Builder</h2>
      </div>
      <button onclick="closeAIJDModal()" class="text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
    </div>

    <div class="flex flex-col md:flex-row gap-6 flex-grow overflow-hidden">
      
      <div class="w-full md:w-1/3 flex flex-col overflow-y-auto pr-2 border-r border-gray-200">
        
        <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg mb-4">
          <button id="tab-jd-workload" onclick="switchAIInputTab('workload')" class="flex-1 py-2 text-sm font-medium rounded-md bg-white shadow text-purple-700 transition-colors">From Workload</button>
          <button id="tab-jd-upload" onclick="switchAIInputTab('upload')" class="flex-1 py-2 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-200 transition-colors">Upload JD</button>
        </div>

        <form id="ai-jd-form" class="space-y-4 flex-grow">
  
  <div>
    <label class="block text-sm font-bold text-gray-700">Position ID <span class="text-gray-400 font-normal">(Required for filename)</span></label>
    <input type="text" id="ai-position-id" class="mt-1 w-full p-2 border rounded text-sm" placeholder="e.g. 04-CSD-001">
  </div>

  <div>
    <label class="block text-sm font-bold text-gray-700">Select Position (Search from Org Chart)</label>
    <div id="ai-job-title-dropdown-container" class="searchable-dropdown"></div>
    <input type="hidden" id="ai-job-title">
  </div>
  
  <div id="ai-workload-fields">
    
    <div class="grid grid-cols-2 gap-2 mb-4">
      <div>
        <label class="block text-sm font-bold text-gray-700">Department</label>
        <input type="text" id="ai-dept" class="mt-1 w-full p-2 border rounded text-sm">
      </div>
      <div>
        <label class="block text-sm font-bold text-gray-700">Level</label>
        <select id="ai-level" class="mt-1 w-full p-2 border rounded text-sm">
          </select>
      </div>
    </div>

    <div class="mb-4 relative">
      <label class="block text-sm font-bold text-gray-700 mb-1">Required Competencies (Optional)</label>
      <p class="text-xs text-gray-500 mb-1">Select competencies from the matrix to prioritize them.</p>
      
      <div class="multiselect-container" id="competency-multiselect-wrapper" onclick="document.getElementById('competency-search-input').focus()">
        <input type="text" id="competency-search-input" class="multiselect-input" placeholder="Search competencies..." autocomplete="off">
      </div>
      
      <div id="competency-dropdown-list" class="multiselect-dropdown"></div>
      <input type="hidden" id="ai-selected-competencies">
    </div>

    <div>
      <label class="block text-sm font-bold text-gray-700 mb-1">Workload Assessment / Task List</label>
      <p class="text-xs text-gray-500 mb-2">Paste the list of daily tasks, strategic goals, or raw workload data here.</p>
      <textarea id="ai-workload-text" class="w-full p-3 border rounded text-sm h-64 focus:ring-2 focus:ring-purple-500" placeholder="- Coordinate daily standups (10%)&#10;- Manage budget (20%)&#10;- Strategy planning..."></textarea>
    </div>

  </div>

  <div id="ai-upload-fields" style="display: none;">
    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition-colors">
      <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
      <p class="mt-1 text-sm text-gray-600">Click to upload JD file (PDF, Docx, Txt)</p>
      <input type="file" id="ai-upload-file" class="mt-2 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
    </div>
    <p class="text-xs text-gray-500 mt-2">The AI will analyze the file content and restructure it into the PLOC format.</p>
  </div>

</form>

        <div class="mt-4 pt-4 border-t">
          <button onclick="generateJD()" id="btn-generate-jd" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold py-3 rounded-lg shadow-lg hover:opacity-90 flex justify-center items-center">
            <span> Generate Job Description</span>
          </button>
        </div>
      </div>

      <div class="w-full md:w-2/3 flex flex-col bg-gray-50 rounded-lg border border-gray-200 overflow-hidden relative">
        <div class="bg-gray-100 p-3 border-b flex justify-between items-center">
          <h3 class="font-bold text-gray-700">Preview & Edit</h3>
          <div class="flex space-x-2">
            <button onclick="copyJDToClipboard()" class="text-xs bg-white border border-gray-300 px-3 py-1 rounded hover:bg-gray-100">Copy Text</button>
            <button onclick="saveAIJD()" class="text-xs bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">Save / Export</button>
          </div>
        </div>
        
        <div id="ai-loading-overlay" class="absolute inset-0 bg-white bg-opacity-90 z-50 hidden flex-col items-center justify-center">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mb-4"></div>
          <p class="text-purple-800 font-bold animate-pulse">AI is crafting the Job Description...</p>
          <p class="text-xs text-gray-500 mt-2">Applying PLOC Structure</p>
        </div>

        <div id="ai-preview-content" class="p-6 overflow-y-auto h-full text-sm space-y-6">
          <div class="text-center text-gray-400 mt-20">
            <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            <p>Generated content will appear here.</p>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<div id="preview-modal" class="modal-overlay" style="z-index: 60;"> <div class="modal-content" style="max-width: 95%; width: 95%;"> <div class="flex justify-between items-center mb-4">
      <h2 id="preview-modal-title" class="text-2xl font-bold text-slate-800">Preview Change Request</h2>
      <button onclick="closePreviewModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
    </div>
    <p id="preview-change-description" class="mb-4 text-lg font-semibold text-indigo-700"></p>
    <div class="mb-2 flex justify-end space-x-2">
         <button onclick="zoomPreview(0.1)" class="bg-slate-600 text-white w-8 h-8 rounded-full font-bold text-xl flex items-center justify-center">+</button>
         <button onclick="zoomPreview(-0.1)" class="bg-slate-600 text-white w-8 h-8 rounded-full font-bold text-xl flex items-center justify-center">-</button>
    </div>
    <div id="preview-chart-wrapper" class="w-full h-[70vh] overflow-auto border rounded bg-gray-50">
         <div id="preview-loader-container" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-75 z-20" style="display: none;">
             <div id="loader"></div> <span class="ml-3 font-semibold">Generating Preview...</span>
         </div>
         <div id="preview_chart_div" style="transform-origin: top left; min-width: 100%; min-height: 100%;">
             </div>
    </div>
    <div class="mt-6 flex justify-end">
      <button onclick="closePreviewModal()" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Close Preview</button>
    </div>
  </div>
</div>
<div id="custom-tooltip" onmouseover="clearTimeout(tooltipTimeout)" onmouseout="hideTooltip()"></div>

<div id="return-modal" class="modal-overlay">
  <div class="modal-content" style="max-width: 500px;">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold text-slate-800">Return Request</h2>
      <button onclick="closeReturnModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
    </div>
    
    <p class="text-sm text-gray-600 mb-4">Please indicate why this request is being returned. Select the fields that need correction.</p>
    
    <form id="return-form" class="space-y-3 max-h-[60vh] overflow-y-auto p-1">
        <div class="space-y-2" id="return-checklist-container">
            </div>
        
        <div class="mt-4 pt-4 border-t">
            <label class="block font-bold text-sm text-gray-700 mb-1">Additional Comments / Instructions</label>
            <textarea id="return-general-comment" class="w-full p-2 border rounded text-sm" rows="3" placeholder="Provide overall instructions here..."></textarea>
        </div>
    </form>

    <div class="mt-6 flex justify-end gap-3">
      <button onclick="closeReturnModal()" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Cancel</button>
      <button onclick="submitReturnDecision()" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 font-bold">Return Request</button>
    </div>
  </div>
 </div> 

<!-- My Requests View -->
<div id="my-requests-view" class="tab-content">
  <div class="p-4 sm:p-6 bg-white rounded-lg shadow-md">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold text-slate-800">My Change Requests</h2>
      <button id="refresh-my-requests" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 font-semibold flex items-center">
        <svg class="w-5 h-5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 4l5 5M20 20l-5-5"></path></svg>
        Refresh
      </button>
    </div>
    <table id="my-requests-table" class="display" style="width:100%">
    </table>
  </div>
</div>

<!-- Approvals View -->
<div id="approvals-view" class="tab-content">
  <div class="p-4 sm:p-6 bg-white rounded-lg shadow-md">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold text-slate-800">Change Request Approvals</h2>
      <button id="refresh-approvals" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 font-semibold flex items-center">
        <svg class="w-5 h-5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 4l5 5M20 20l-5-5"></path></svg>
        Refresh
      </button>
    </div>
    <table id="approvals-table" class="display" style="width:100%">
    </table>
  </div>
</div>

<!-- Predictive View -->
<div id="predictive-view" class="tab-content">

    <div class="p-4 sm:p-6 bg-white rounded-lg shadow-md">
        <h2 class="text-2xl font-bold text-slate-800 mb-4">Employee Attrition Risk</h2>
        <p class="mb-6 text-sm text-gray-600">This report identifies current employees who may be at a higher risk of leaving, based on historical data. Factors include tenure, department turnover rates, and time since last role change.</p>
        <div id="attrition-risk-loader" class="flex justify-center items-center h-48"><div id="loader"></div></div>
        <div id="attrition-risk-content" style="display: none;">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Employee Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Position</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Department</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Risk Level</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Key Factors</th>
                    </tr>
                </thead>
                <tbody id="attrition-risk-table-body" class="bg-white divide-y divide-gray-200"></tbody>
            </table>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
        <div class="p-4 sm:p-6 bg-white rounded-lg shadow-md">
            <h2 class="text-xl font-bold text-slate-800 mb-2">Time to Hire Prediction</h2>
            <p class="mb-4 text-sm text-gray-600">Predicted number of days to fill a position based on historical averages.</p>
            <div id="tth-prediction-loader" class="flex justify-center items-center h-48"><div id="loader"></div></div>
            <div id="tth-prediction-content" style="display: none; max-height: 300px; overflow-y: auto;">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Position</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Predicted Time to Hire</th>
                        </tr>
                    </thead>
                    <tbody id="tth-prediction-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
        <div class="p-4 sm:p-6 bg-white rounded-lg shadow-md">
            <h2 class="text-xl font-bold text-slate-800 mb-2">Source Quality Prediction</h2>
            <p class="mb-4 text-sm text-gray-600">Predicted hire rate for each recruitment source based on historical performance.</p>
            <div id="source-quality-loader" class="flex justify-center items-center h-48"><div id="loader"></div></div>
            <div id="source-quality-content" style="display: none; max-height: 300px; overflow-y: auto;">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Source</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Predicted Hire Rate</th>
                        </tr>
                    </thead>
                    <tbody id="source-quality-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="talent-insights-loader" class="flex justify-center items-center h-64 mt-8"><div id="loader"></div></div>
    <div id="talent-insights-content" style="display: none;">
        <div class="p-4 sm:p-6 bg-white rounded-lg shadow-md mt-8">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">Succession Pipeline</h2>
            <p class="mb-6 text-sm text-gray-600">This report identifies potential successors for key roles within the organization, as defined in the 'Succession Planning' sheet.</p>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Key Position</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Potential Successor</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Readiness</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Notes</th>
                        </tr>
                    </thead>
                    <tbody id="succession-plan-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
            <div class="p-4 sm:p-6 bg-white rounded-lg shadow-md">
                <h2 class="text-xl font-bold text-slate-800 mb-2">Ready for Promotion</h2>
                <p class="mb-4 text-sm text-gray-600">Employees with high performance and competency scores, and at least 1 year of tenure.</p>
                <div class="max-h-96 overflow-y-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Employee</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Performance Score</th>
                            </tr>
                        </thead>
                        <tbody id="promotion-ready-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
            <div class="p-4 sm:p-6 bg-white rounded-lg shadow-md">
                <h2 class="text-xl font-bold text-slate-800 mb-2">High Potentials</h2>
                <p class="mb-4 text-sm text-gray-600">Employees with the highest possible scores in both performance and competency.</p>
                <div class="max-h-96 overflow-y-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Employee</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Department</th>
                            </tr>
                        </thead>
                        <tbody id="high-potentials-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
  // --- GLOBAL VARIABLES ---
  var analyticsDataLoaded = false;
  var resignationDataLoaded = false;
  var employeeMovementDataLoaded = false;
  var analyticsFiltersPopulated = false;
  var resignationFiltersPopulated = false;
  var movementFiltersPopulated = false;
  var fullEmployeeData = [];
  var previousHeadcountData = {};
  var dropdownListData = {};
  var snapshotTimestamp = null;
  var currentUserEmail = null;
  var userCanEdit = false;
  var userCanApprove = false;
  var totalApprovedPlantilla = 0;
  var previousDateString = null;
  var employeeMap = new Map();
  var chart;
  var dataTable;
  var currentZoom = 1.0;
  var tooltipTimeout;
  var masterlistDataLoaded = false;
  var masterlistFiltersPopulated = false;
  var masterlistDataTable; 
  var masterlistFilterState = {};
  var predictiveDataLoaded = false;
  var competencyViewInitialized = false;
  var previewChart; // --- NEW PREVIEW VARIABLES ---
  var previewDataTable;
  var currentPreviewZoom = 1.0;
  var previewHighlightIds = [];
  var previewChangeDescription = '';

  // --- NEW: ATTACHMENT CONFIGURATION & LOGIC ---

const ATTACHMENT_CONFIG = {
  'Hiring of a new employee (newly created position)': [
    'Approved POMP (if applicable)',
    'Workload Assessment (Job Description)',
    'Email Approval from Department Head / Management'
  ],
  'Hiring of a new employee (replacement for vacancy)': [
    'Approved POMP (if applicable)',
    'Resignation Letter (if applicable)',
    'Approved Personnel Requisition Form (PRF)'
  ],
  'Promotion': [
    'Approved Personnel Action Form (PAF)'
  ],
  'Internal Transfer': [
    'Approved Personnel Action Form (PAF)'
  ],
  'Lateral Transfer': [
    'Approved Personnel Action Form (PAF)'
  ],
    'Change in Employment Status': [
    'Approved Personnel Action Form (PAF)'
  ],
  'Change in Reporting line': [
    'Approved Personnel Action Form (PAF)'
  ],
  'Job Title/Position Change (without promotion)': [
    'Approved Personnel Action Form (PAF)'
  ],
    'Name Correction/Update of Employee Information': [
    'Supporting Document (e.g., Birth Certificate, Marriage Certificate)'
  ],
  'Position on Hold/Cancelled/Deleted': [
    'Management Approval'
  ],
  'Regularization': [
    'Approved Personnel Action Form (PAF)',
    'Performance Evaluation Form'
  ],
  'Resignation/Separation': [
    'Resignation Letter',
    'Clearance Form (if applicable)'
  ]
};

/**
 * Generates the HTML for the dynamic attachment section.
 */
function generateAttachmentsHTML(requestType) {
  const requirements = ATTACHMENT_CONFIG[requestType] || [];
  
  if (requirements.length === 0) {
    // Fallback if no specific config exists (though your list covers all current types)
    return `
      <div class="md:col-span-2">
        <label class="block font-medium text-gray-700">Supporting Documents</label>
        <p class="text-xs text-gray-500 mb-2">Upload up to 5 files.</p>
        <input type="file" id="generic-upload" multiple class="dynamic-attachment-input block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
      </div>`;
  }

  let rowsHtml = requirements.map((reqText, index) => {
    const isOptional = reqText.toLowerCase().includes('(if applicable)');
    const isRequired = !isOptional;
    const labelHtml = isRequired 
      ? `${reqText} <span class="required-star">*</span>` 
      : reqText;
    
    // We add data-required attribute to easily check validation later
    return `
      <div class="attachment-row">
        <label class="attachment-label">${labelHtml}</label>
        <input type="file" 
               class="dynamic-attachment-input block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" 
               data-label="${reqText}"
               data-required="${isRequired}">
        <div class="error-message">This attachment is required.</div>
      </div>
    `;
  }).join('');

  return `
    <div class="md:col-span-2">
      <label class="block font-medium text-gray-800 mb-1">Required Attachments</label>
      <div class="attachment-group">
        ${rowsHtml}
      </div>
      <p id="global-file-error" class="text-red-500 text-xs mt-2" style="display:none;"></p>
      <p class="text-xs text-gray-400 mt-1 text-right">Total max files: 5</p>
    </div>
  `;
}

  // --- CONSTANTS & CONFIG ---
  var levelColors = { 1: '#000000', 2: '#f56565', 3: '#4299e1', 4: '#48bb78', 5: '#9f7aea', 6: '#ed8936', 'default': '#a0aec0' };
  var levelNames = { 1: 'Executive', 2: 'Director', 3: 'Managerial', 4: 'Supervisory', 5: 'Associate', 6: 'Jobcon' };
  var ICONS = { toggle: '<svg class="w-5 h-6 transition-transform transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>', filled: '<svg class="w-5 h-5 text-green-600 mr-2 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>', vacant: '<svg class="w-5 h-5 text-gray-400 mr-2 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>', previous: '<svg class="w-5 h-5 text-gray-500 mr-2 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>'};
  var statusColors = { 'New Hire': 'bg-new-hire', 'Filled Vacancy': 'bg-filled-vacancy', 'Internal Transfer': 'bg-internal-transfer', 'Promotion': 'bg-promotion', 'Lateral Transfer': 'bg-lateral-transfer' };
  var statusNotes = { 'New Hire': 'This employee is new to the company.', 'Filled Vacancy': 'This employee filled a previously vacant position.', 'Internal Transfer': 'This employee transferred from another role within the company.', 'Promotion': 'This employee was promoted from another role within the company.', 'Lateral Transfer': 'This employee transferred from a similar role within the company.' };
  var statusTagColors = { 'New Hire': '#22c55e', 'Filled Vacancy': '#3b82f6', 'Internal Transfer': '#8b5cf6', 'Promotion': '#f59e0b', 'Lateral Transfer': '#0ea5e9' };

  const ANALYTICS_FILTERS_CONFIG = [
    { id: 'division', containerId: 'analytics-division-filter-container', valueId: 'analytics-division-filter-value', defaultLabel: 'All Divisions', parent: null },
    { id: 'group', containerId: 'analytics-group-filter-container', valueId: 'analytics-group-filter-value', defaultLabel: 'All Groups', parent: 'division' },
    { id: 'department', containerId: 'analytics-department-filter-container', valueId: 'analytics-department-filter-value', defaultLabel: 'All Departments', parent: 'group' },
    { id: 'section', containerId: 'analytics-section-filter-container', valueId: 'analytics-section-filter-value', defaultLabel: 'All Sections', parent: 'department' }
  ];
  
  const RESIGNATION_FILTERS_CONFIG = [
    { id: 'division', containerId: 'resignation-division-filter-container', valueId: 'resignation-division-filter-value', defaultLabel: 'All Divisions', parent: null },
    { id: 'group', containerId: 'resignation-group-filter-container', valueId: 'resignation-group-filter-value', defaultLabel: 'All Groups', parent: 'division' },
    { id: 'department', containerId: 'resignation-department-filter-container', valueId: 'resignation-department-filter-value', defaultLabel: 'All Departments', parent: 'group' },
    { id: 'section', containerId: 'resignation-section-filter-container', valueId: 'resignation-section-filter-value', defaultLabel: 'All Sections', parent: 'department' }
  ];

  const MOVEMENT_FILTERS_CONFIG = [
    { id: 'division', containerId: 'movement-division-filter-container', valueId: 'movement-division-filter-value', defaultLabel: 'All Divisions', parent: null },
    { id: 'group', containerId: 'movement-group-filter-container', valueId: 'movement-group-filter-value', defaultLabel: 'All Groups', parent: 'division' },
    { id: 'department', containerId: 'movement-department-filter-container', valueId: 'movement-department-filter-value', defaultLabel: 'All Departments', parent: 'group' },
    { id: 'section', containerId: 'movement-section-filter-container', valueId: 'movement-section-filter-value', defaultLabel: 'All Sections', parent: 'department' }
  ];

  const MASTERLIST_FILTERS_CONFIG = [
    { id: 'Division', containerId: 'masterlist-Division-filter-container', defaultLabel: 'All Divisions', parent: null },
    { id: 'Group', containerId: 'masterlist-Group-filter-container', defaultLabel: 'All Groups', parent: 'Division' },
    { id: 'Department', containerId: 'masterlist-Department-filter-container', defaultLabel: 'All Departments', parent: 'Group' },
    { id: 'Section', containerId: 'masterlist-Section-filter-container', defaultLabel: 'All Sections', parent: 'Department' }
];

// --- COMPETENCY FILTERS CONFIGURATION ---
  const COMP_FILTERS_CONFIG = [
      { id: 'division', containerId: 'comp-division-filter-container', valueId: 'comp-division-filter-value', defaultLabel: 'All Divisions', parent: null },
      { id: 'group', containerId: 'comp-group-filter-container', valueId: 'comp-group-filter-value', defaultLabel: 'All Groups', parent: 'division' },
      { id: 'department', containerId: 'comp-department-filter-container', valueId: 'comp-department-filter-value', defaultLabel: 'All Departments', parent: 'group' },
      { id: 'section', containerId: 'comp-section-filter-container', valueId: 'comp-section-filter-value', defaultLabel: 'All Sections', parent: 'department' }
  ];

  /**
   * Populates the dynamic filters for the Competency View.
   * Filters the global `fullEmployeeData` based on selections and updates the Employee list.
   */
  function populateCompetencyFilters() {
      // Start with all employees who have an ID
      let sourceData = fullEmployeeData.filter(emp => emp.employeeId);

      // 1. Process Hierarchy Filters (Division -> Group -> Department -> Section)
      COMP_FILTERS_CONFIG.forEach(config => {
          const currentValue = document.getElementById(config.valueId).value;
          
          // Get unique options based on current filtered sourceData
          const options = [config.defaultLabel, ...new Set(sourceData.map(e => e[config.id]).filter(String).sort())];
          
          createSearchableDropdown(config.containerId, options, null, null, (selection) => {
              const newValue = (selection === config.defaultLabel) ? 'all' : selection;
              
              if (document.getElementById(config.valueId).value !== newValue) {
                  document.getElementById(config.valueId).value = newValue;
                  
                  // Reset children filters when a parent changes
                  let childIdToReset = config.id;
                  let childConfig = COMP_FILTERS_CONFIG.find(f => f.parent === childIdToReset);
                  while (childConfig) {
                      document.getElementById(childConfig.valueId).value = 'all';
                      childIdToReset = childConfig.id;
                      childConfig = COMP_FILTERS_CONFIG.find(f => f.parent === childIdToReset);
                  }
                  
                  populateCompetencyFilters(); // Recursively update child options
              }
          });

          setSearchableDropdownValue(config.containerId, currentValue === 'all' ? config.defaultLabel : currentValue);

          // Filter data for the next level down
          if (currentValue !== 'all') {
              sourceData = sourceData.filter(emp => emp[config.id] === currentValue);
          }
      });

      // 2. Process Employee Dropdown (The final filtered list)
      const employees = sourceData.map(emp => ({
          name: emp.employeeName,
          id: emp.employeeId
      })).sort((a, b) => a.name.localeCompare(b.name));

      createSearchableDropdown('comp-employee-filter-container', employees, 'name', 'id', (employeeId) => {
          const currentSelectValue = document.getElementById('competency-employee-select').value;
          
          // Only redraw if the selection actually changed
          if (currentSelectValue !== employeeId) {
              document.getElementById('competency-employee-select').value = employeeId;
              
              if (employeeId) {
                  drawCompetencyDashboard(employeeId);
              } else {
                  // Hide dashboard if selection is cleared
                  const idsToHide = ['competency-summary-container', 'competency-history-container', 
                                     'competency-charts-container', 'team-competency-section', 
                                     'individual-profile-content'];
                  idsToHide.forEach(id => {
                      const el = document.getElementById(id);
                      if(el) el.style.display = 'none';
                  });
              }
          }
      });
      
      // Update the text in the employee box if an ID is already selected (e.g., from Org Chart click)
      const currentEmpId = document.getElementById('competency-employee-select').value;
      if (currentEmpId) {
          const currentEmp = employees.find(e => e.id === currentEmpId);
          if (currentEmp) {
              setSearchableDropdownValue('comp-employee-filter-container', currentEmp.name);
          } else {
              // If the selected employee is no longer in the filtered list (e.g. user changed Division), clear the display
              setSearchableDropdownValue('comp-employee-filter-container', '');
          }
      }
  }

// --- HEATMAP FILTERS CONFIGURATION ---
  const HEATMAP_FILTERS_CONFIG = [
      { id: 'division', containerId: 'heatmap-division-filter-container', valueId: 'heatmap-division-filter-value', defaultLabel: 'All Divisions', parent: null },
      { id: 'group', containerId: 'heatmap-group-filter-container', valueId: 'heatmap-group-filter-value', defaultLabel: 'All Groups', parent: 'division' },
      { id: 'department', containerId: 'heatmap-department-filter-container', valueId: 'heatmap-department-filter-value', defaultLabel: 'All Departments', parent: 'group' },
      { id: 'section', containerId: 'heatmap-section-filter-container', valueId: 'heatmap-section-filter-value', defaultLabel: 'All Sections', parent: 'department' }
  ];

  /**
   * Populates the dynamic filters for the Team Heatmap.
   */
  function populateHeatmapFilters() {
      // Start with all employees who have an ID
      let sourceData = fullEmployeeData.filter(emp => emp.employeeId);

      HEATMAP_FILTERS_CONFIG.forEach(config => {
          const currentValue = document.getElementById(config.valueId).value;
          const options = [config.defaultLabel, ...new Set(sourceData.map(e => e[config.id]).filter(String).sort())];
          
          createSearchableDropdown(config.containerId, options, null, null, (selection) => {
              const newValue = (selection === config.defaultLabel) ? 'all' : selection;
              
              if (document.getElementById(config.valueId).value !== newValue) {
                  document.getElementById(config.valueId).value = newValue;
                  
                  // Reset children
                  let childIdToReset = config.id;
                  let childConfig = HEATMAP_FILTERS_CONFIG.find(f => f.parent === childIdToReset);
                  while (childConfig) {
                      document.getElementById(childConfig.valueId).value = 'all';
                      childIdToReset = childConfig.id;
                      childConfig = HEATMAP_FILTERS_CONFIG.find(f => f.parent === childIdToReset);
                  }
                  
                  populateHeatmapFilters(); // Recursive update
                  // Note: We DO NOT auto-draw the heatmap on filter change because it can be heavy.
                  // User must click "Generate Heatmap".
              }
          });

          setSearchableDropdownValue(config.containerId, currentValue === 'all' ? config.defaultLabel : currentValue);

          if (currentValue !== 'all') {
              sourceData = sourceData.filter(emp => emp[config.id] === currentValue);
          }
      });
  }

/**
   * Resets the filters for the Employee Competency Profile view.
   */
  function resetCompetencyFilters() {
      // 1. Reset Configured Filters (Division, Group, Dept, Section)
      COMP_FILTERS_CONFIG.forEach(config => {
          document.getElementById(config.valueId).value = 'all';
          
          // Reset visual text in the dropdown input
          const container = document.getElementById(config.containerId);
          if(container) {
               const input = container.querySelector('input.searchable-dropdown-input');
               if(input) input.value = config.defaultLabel;
          }
      });

      // 2. Reset Employee Filter Selection
      document.getElementById('competency-employee-select').value = '';
      const empContainer = document.getElementById('comp-employee-filter-container');
      if(empContainer) {
           const input = empContainer.querySelector('input.searchable-dropdown-input');
           if(input) input.value = '';
      }

      // 3. Re-populate filters to restore the full list of options
      populateCompetencyFilters();

      // 4. Hide the dashboard content since no employee is selected anymore
      const idsToHide = [
          'competency-dashboard-grid', 
          'competency-charts-container', 
          'competency-summary-container', 
          'competency-history-container'
      ];
      idsToHide.forEach(id => {
          const el = document.getElementById(id);
          if(el) el.style.display = 'none';
      });
  }

  /**
   * Resets the filters for the Team Heatmap view.
   */
  function resetHeatmapFilters() {
      // 1. Reset Configured Filters
      HEATMAP_FILTERS_CONFIG.forEach(config => {
          document.getElementById(config.valueId).value = 'all';
          
          // Reset visual text in the dropdown input
          const container = document.getElementById(config.containerId);
          if(container) {
               const input = container.querySelector('input.searchable-dropdown-input');
               if(input) input.value = config.defaultLabel;
          }
      });

      // 2. Re-populate filters to restore full lists
      populateHeatmapFilters();
      
      // 3. Clear the heatmap container and legend
      document.getElementById('heatmap-container').innerHTML = '';
      const legend = document.getElementById('heatmap-legend');
      if(legend) legend.style.display = 'none';
  }

  // Wrapper function called by the "Generate Heatmap" button
  function triggerHeatmapDraw() {
      const filters = {
          division: document.getElementById('heatmap-division-filter-value').value,
          group: document.getElementById('heatmap-group-filter-value').value,
          department: document.getElementById('heatmap-department-filter-value').value,
          section: document.getElementById('heatmap-section-filter-value').value
      };
      
      // Check if all are 'all'
      if (Object.values(filters).every(val => val === 'all')) {
          alert("Please select at least one filter (e.g., Division or Department) to generate the heatmap.");
          return;
      }

      drawTeamCompetencyHeatmap(filters);
  }

// --- START: NEW INITIALIZATION & LOGIN LOGIC ---
document.addEventListener("DOMContentLoaded", function() {
  const loginButtonContainer = document.getElementById('login-button-container');
  loginButtonContainer.innerHTML = `
    <div class="mt-8 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center">
      <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      Authenticating...
    </div>
  `;
  google.script.run.withSuccessHandler(handleLogin).checkUserAccess();
});

function handleLogin(response) {
  if (response.isAuthorized) {
    document.getElementById('login-view').style.display = 'none';
    document.getElementById('app-view').style.display = 'block';
    document.getElementById('user-info').textContent = 'Logged in as: ' + response.userEmail;
    // Now that the user is logged in, load the chart libraries and fetch data
    google.charts.load('current', { packages: ['orgchart', 'corechart'] });
    google.charts.setOnLoadCallback(fetchData);
  } else {
    document.getElementById('login-view').style.display = 'none';
    document.getElementById('denied-view').style.display = 'flex';
    document.getElementById('denied-email').textContent = response.userEmail;
  }
}
// --- END: NEW INITIALIZATION & LOGIN LOGIC ---

// --- START: NEW NAVIGATION FUNCTIONS ---

function showHomepage() {
  document.getElementById('tab-area').style.display = 'none';
  document.getElementById('homepage-view').style.display = 'block';
  
  // Deactivate any active tab content/views to prevent them from persisting on the homepage
  document.querySelectorAll('.tab-content.active').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab.active').forEach(el => el.classList.remove('active'));
}

// ADD THIS NEW FUNCTION

function navigateToView(viewType, defaultTabId) {
  document.getElementById('homepage-view').style.display = 'none';
  document.getElementById('tab-area').style.display = 'block';

  const mainTitle = document.getElementById('main-title');
  const tabNav = document.getElementById('tab-navigation');
  const headerControls = document.getElementById('header-controls');
  const myRequestsTab = document.getElementById('tab-my-requests');
  const approvalsTab = document.getElementById('tab-approvals');

  headerControls.style.display = (viewType === 'org') ? 'flex' : 'none';

  if (viewType === 'org') {
    // For org chart view, specifically manage tabs based on permissions
    mainTitle.style.display = 'none'; 
    tabNav.style.display = 'flex'; // Show the nav bar for tabs
    document.getElementById('tab-org-chart').style.display = 'flex';

    // Show/hide permission-based tabs
    myRequestsTab.style.display = userCanEdit ? 'none' : 'flex';
    approvalsTab.style.display = userCanApprove ? 'flex' : 'none';

    // Hide all other tab groups
    document.querySelectorAll('.analytics-view-tab, .predictive-view-tab, .competency-view-tab').forEach(t => t.style.display = 'none');

    // Default to approvals tab if user can approve and is landing on the org view
    if (userCanApprove) {
      defaultTabId = 'approvals';
    }

  } else {
    // Logic for other views remains the same
    if (viewType === 'predictive' || viewType === 'competency') {
      mainTitle.style.display = 'none';
      tabNav.style.display = 'none';
    } else { // This covers 'analytics' and any other future views
      mainTitle.style.display = 'none';
      tabNav.style.display = 'flex';
    }
    
    const viewClassMap = {
      'analytics': 'analytics-view-tab',
      'predictive': 'predictive-view-tab',
      'competency': 'competency-view-tab'
    };
    const targetClass = viewClassMap[viewType];
    
    document.querySelectorAll('#tab-navigation .tab').forEach(tab => {
        tab.style.display = tab.classList.contains(targetClass) ? 'flex' : 'none';
    });
  }

  switchTab(defaultTabId);
}

// --- END: NEW NAVIGATION FUNCTIONS ---

function switchTab(tabId) {
  try {
    // google.script.run.logUserActivity('Viewed Tab: ' + tabId); //
  } catch (e) {
    console.error("Failed to log tab activity:", e);
  }
  const activeClass = 'active';
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove(activeClass));
  document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));

  document.getElementById(`${tabId}-view`).classList.add(activeClass);

 // This check prevents an error for views without a physical tab.
    const tabElement = document.getElementById(`tab-${tabId}`);
    if (tabElement) {
      tabElement.classList.add(activeClass);
    }

  // Your existing data-loading logic
  if (tabId === 'demographics' && !analyticsDataLoaded) {
      if (!analyticsFiltersPopulated) populateAnalyticsFilters();
      drawAnalyticsCharts();
  } else if (tabId === 'resignation' && !resignationDataLoaded) {
      if (!resignationFiltersPopulated) populateResignationFilters();
      drawResignationCharts();
  } else if (tabId === 'employee-movement' && !employeeMovementDataLoaded) {
      if (!movementFiltersPopulated) populateMovementFilters();
      drawEmployeeMovementCharts();
  } else if (tabId === 'masterlist' && !masterlistDataLoaded) {
      initializeMasterlist();
  } else if (tabId === 'predictive' && !predictiveDataLoaded) {
      drawPredictiveInsights();
      drawHiringPredictions();
      drawTalentInsights(); // <-- ADD THIS LINE
  } else if (tabId === 'my-requests') {
    loadChangeRequestData(renderMyRequestsTable);
  } else if (tabId === 'approvals') {
    loadChangeRequestData(renderApprovalsTable);
  } else if (tabId === 'adoption' && !adoptionDataLoaded) {
      drawAdoptionDashboard();
  } else if (tabId === 'competency' && !competencyViewInitialized) {
      initializeCompetencyView();
  }
}


  function populateAnalyticsFilters() {
      let sourceData = fullEmployeeData;
      
      // Handle dependent location filters
      ANALYTICS_FILTERS_CONFIG.forEach(config => {
          const currentValue = document.getElementById(config.valueId).value;
          const options = [config.defaultLabel, ...new Set(sourceData.map(e => e[config.id]).filter(String).sort())];
          
          createSearchableDropdown(config.containerId, options, null, null, (selection) => {
              const newValue = (selection === config.defaultLabel) ? 'all' : selection;
              if (document.getElementById(config.valueId).value !== newValue) {
                  document.getElementById(config.valueId).value = newValue;
                  
                  // Reset children filters when a parent changes
                  let childIdToReset = config.id;
                  let childConfig = ANALYTICS_FILTERS_CONFIG.find(f => f.parent === childIdToReset);
                  while (childConfig) {
                      document.getElementById(childConfig.valueId).value = 'all';
                      childIdToReset = childConfig.id;
                      childConfig = ANALYTICS_FILTERS_CONFIG.find(f => f.parent === childIdToReset);
                  }
                  
                  // Repopulate all filters and redraw charts
                  populateAnalyticsFilters(); 
                  drawAnalyticsCharts(true);
              }
          });
          setSearchableDropdownValue(config.containerId, currentValue === 'all' ? config.defaultLabel : currentValue);

          if (currentValue !== 'all') {
              sourceData = sourceData.filter(emp => emp[config.id] === currentValue);
          }
      });

      // Handle non-dependent filters
      const lists = dropdownListData;
      const refreshCallback = () => drawAnalyticsCharts(true);
      createSearchableDropdown('analytics-joblevel-filter-container', ['All Job Levels', ...(lists.joblevel || [])], null, null, refreshCallback);
      createSearchableDropdown('analytics-pos-status-filter-container', ['All Statuses', 'Active', 'Inactive'], null, null, refreshCallback);
      createSearchableDropdown('analytics-gender-filter-container', ['All Genders', 'Male', 'Female'], null, null, refreshCallback);
      createSearchableDropdown('analytics-jobtitle-filter-container', ['All Job Titles', ...(lists.jobtitle || [])], null, null, refreshCallback);
      
      if (!analyticsFiltersPopulated) {
        document.getElementById('analytics-reset-filters-btn').addEventListener('click', resetAnalyticsFilters);
        analyticsFiltersPopulated = true;
      }
  }
  
  function resetAnalyticsFilters() {
      ANALYTICS_FILTERS_CONFIG.forEach(config => {
          document.getElementById(config.valueId).value = 'all';
      });
      // Also reset non-dependent filters
      const nonDependentFilters = [
          { id: 'analytics-joblevel-filter-container', value: 'All Job Levels' },
          { id: 'analytics-pos-status-filter-container', value: 'All Statuses' },
          { id: 'analytics-gender-filter-container', value: 'All Genders' },
          { id: 'analytics-jobtitle-filter-container', value: 'All Job Titles' }
      ];
      nonDependentFilters.forEach(f => {
          const input = document.querySelector(`#${f.id} .searchable-dropdown-input`);
          if (input) input.value = f.value;
      });
      
      populateAnalyticsFilters();
      drawAnalyticsCharts(true);
  }

  function drawAnalyticsCharts(forceRefresh = false) {
    if (analyticsDataLoaded && !forceRefresh) return;
    analyticsDataLoaded = true;
    
    // Show a loader in each chart div
    const chartDivs = ['status_chart_div', 'contract_chart_div', 'gender_chart_div', 'job_group_chart_div', 'los_chart_div', 'new_hires_chart_div', 'age_generation_chart_div'];
    chartDivs.forEach(id => {
        if (document.getElementById(id)) {
            document.getElementById(id).innerHTML = '<div class="flex justify-center items-center h-full"><div id="loader"></div></div>';
        }
    });
    if(document.querySelector('#analytics-headcount-card p')) document.querySelector('#analytics-headcount-card p').textContent = '--';

    const filters = {
      division: document.getElementById('analytics-division-filter-value').value,
      group: document.getElementById('analytics-group-filter-value').value,
      department: document.getElementById('analytics-department-filter-value').value,
      section: document.getElementById('analytics-section-filter-value').value,
      jobLevel: document.querySelector('#analytics-joblevel-filter-container .searchable-dropdown-input').value,
      positionStatus: document.querySelector('#analytics-pos-status-filter-container .searchable-dropdown-input').value,
      gender: document.querySelector('#analytics-gender-filter-container .searchable-dropdown-input').value,
      jobTitle: document.querySelector('#analytics-jobtitle-filter-container .searchable-dropdown-input').value,
    };

    google.script.run
      .withSuccessHandler(function(data) {
        const noDataHtml = '<div class="flex justify-center items-center h-full"><p class="text-gray-500">No data available for this selection.</p></div>';

        // Update Headcount Cards
        const headcountCard = document.querySelector('#analytics-headcount-card');
        const headcountTitle = headcountCard.querySelector('h3');
        const headcountValue = headcountCard.querySelector('p');
        const vacantCard = document.querySelector('#analytics-vacant-card');
        const vacantValue = vacantCard.querySelector('p');
        
        const allFiltersDefault = Object.values(filters).every(val => String(val).toLowerCase().startsWith('all'));

        if (allFiltersDefault) {
          headcountTitle.textContent = 'Total Filled';
          headcountValue.textContent = data.overallHeadcount;
          vacantValue.textContent = data.filteredPositionsCount - data.overallHeadcount;
        } else {
          headcountTitle.textContent = 'Filtered Filled';
          headcountValue.textContent = data.totalHeadcount;
          vacantValue.textContent = data.filteredPositionsCount - data.totalHeadcount;
        }

        const createPieChartData = (counts) => {
            const dataArray = [['Category', 'Count']];
            const total = Object.values(counts).reduce((sum, value) => sum + value, 0);
            if (total === 0) {
                dataArray.push(['No Data', 1]);
                return { data: google.visualization.arrayToDataTable(dataArray), isNoData: true, sortedKeys: [] };
            }
            const sortedKeys = Object.keys(counts).sort();
            for (const key of sortedKeys) {
                const value = counts[key];
                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                const label = `${key}: ${value} (${percentage}%)`;
                dataArray.push([label, value]);
            }
            return { data: google.visualization.arrayToDataTable(dataArray), isNoData: false, sortedKeys: sortedKeys };
        };

        // Draw Status Chart
        const statusChartDiv = document.getElementById('status_chart_div');
        if (Object.keys(data.statusCounts).length > 0) {
            const statusDataArray = [['Status', 'Count', { role: 'annotation' }]];
            Object.entries(data.statusCounts).sort((a,b) => a[0].localeCompare(b[0])).forEach(([key, value]) => statusDataArray.push([key, value, value]));
            const statusData = google.visualization.arrayToDataTable(statusDataArray);
            const statusChart = new google.visualization.ColumnChart(statusChartDiv);
            statusChart.draw(statusData, {
                is3D: true, legend: { position: 'none' }, vAxis: { minValue: 0 },
                annotations: { textStyle: { fontSize: 12, color: '#212121', auraColor: 'none' } },
                colors: ['#98FB98'], fontName: 'Roboto'
            });
        } else {
            statusChartDiv.innerHTML = noDataHtml;
        }

        // Draw Contract Type Chart
        const contractChartDiv = document.getElementById('contract_chart_div');
        if (Object.keys(data.contractCounts).length > 0) {
            const contractDataArray = [['Contract Type', 'Count', { role: 'annotation' }]];
            Object.entries(data.contractCounts).forEach(([key, value]) => contractDataArray.push([key, value, value]));
            const contractData = google.visualization.arrayToDataTable(contractDataArray);
            const contractChart = new google.visualization.ColumnChart(contractChartDiv);
            contractChart.draw(contractData, { 
                is3D: true, legend: { position: 'none' }, vAxis: { minValue: 0 },
                annotations: { textStyle: { fontSize: 12, color: '#212121', auraColor: 'none' } },
                colors: ['#008080'], fontName: 'Roboto'
            });
        } else {
            contractChartDiv.innerHTML = noDataHtml;
        }

        // Draw Gender Chart
        const genderChartDiv = document.getElementById('gender_chart_div');
        if (Object.keys(data.genderCounts).length > 0) {
            const genderChartDataResult = createPieChartData(data.genderCounts);
            const genderChart = new google.visualization.PieChart(genderChartDiv);
            const genderSlices = {};
            const femaleIndex = genderChartDataResult.sortedKeys.indexOf('Female');
            const maleIndex = genderChartDataResult.sortedKeys.indexOf('Male');
            if (femaleIndex !== -1) genderSlices[femaleIndex] = { color: '#ef4444' };
            if (maleIndex !== -1) genderSlices[maleIndex] = { color: '#3b82f6' };
            genderChart.draw(genderChartDataResult.data, { 
                is3D: true,
                legend: { position: 'labeled', textStyle: { color: 'black', bold: true, italic: true } },
                pieSliceText: 'none', tooltip: { text: 'value' },
                chartArea: {'width': '100%', 'height': '90%'}, slices: genderSlices, fontName: 'Roboto'
            });
        } else {
            genderChartDiv.innerHTML = noDataHtml;
        }

        // Draw Job Group Chart
        const jobGroupChartDiv = document.getElementById('job_group_chart_div');
        if (Object.keys(data.jobGroupCounts).length > 0) {
            const jobGroupDataArray = [['Job Group', 'Count', { role: 'annotation' }]];
            Object.entries(data.jobGroupCounts).sort((a,b) => a[0].localeCompare(b[0])).forEach(([key, value]) => jobGroupDataArray.push([key, value, value]));
            const jobGroupData = google.visualization.arrayToDataTable(jobGroupDataArray);
            const jobGroupChart = new google.visualization.ColumnChart(jobGroupChartDiv);
            jobGroupChart.draw(jobGroupData, { 
                is3D: true, legend: { position: 'none' }, vAxis: { minValue: 0 },
                annotations: { textStyle: { fontSize: 12, color: '#212121', auraColor: 'none' } },
                colors: ['#FFD1DC'], fontName: 'Roboto'
            });
        } else {
            jobGroupChartDiv.innerHTML = noDataHtml;
        }
        
        // Draw Length of Service Chart
        const losChartDiv = document.getElementById('los_chart_div');
        const totalLos = Object.values(data.losCounts).reduce((a, b) => a + b, 0);
        if (totalLos > 0) {
            const losOrder = ['< 1 Year', '1-3 Years', '3-5 Years', '5-10 Years', '10+ Years'];
            const losDataArray = [['Length of Service', 'Count', { role: 'annotation' }]];
            losOrder.forEach(key => {
                const value = data.losCounts[key] || 0;
                losDataArray.push([key, value, value]);
            });
            const losData = google.visualization.arrayToDataTable(losDataArray);
            const losChart = new google.visualization.ColumnChart(losChartDiv);
            losChart.draw(losData, { 
                is3D: true, legend: { position: 'none' }, vAxis: { minValue: 0 },
                annotations: { textStyle: { fontSize: 12, color: '#212121', auraColor: 'none' } },
                colors: ['#FFDB58'], fontName: 'Roboto'
            });
        } else {
            losChartDiv.innerHTML = noDataHtml;
        }

        // Draw New Hires Chart
        const newHiresChartDiv = document.getElementById('new_hires_chart_div');
        if (Object.keys(data.newHiresByMonth).length > 0) {
            const newHiresData = new google.visualization.DataTable();
            newHiresData.addColumn('string', 'Month');
            newHiresData.addColumn('number', 'New Hires');
            newHiresData.addColumn({ type: 'number', role: 'annotation' });
            const monthOrder = Array.from({length: 12}, (_, i) => {
                const d = new Date();
                d.setMonth(d.getMonth() - i, 1);
                return d.toLocaleString('default', { month: 'short' }) + ' ' + d.getFullYear();
            }).reverse();
            
            monthOrder.forEach(month => {
                const hires = data.newHiresByMonth[month] || 0;
                newHiresData.addRow([month, hires, hires]);
            });

            const newHiresChart = new google.visualization.ColumnChart(newHiresChartDiv);
            newHiresChart.draw(newHiresData, {
                is3D: true, colors: ['#10B981'], legend: { position: 'none' },
                vAxis: { title: 'Number of Hires', minValue: 0 },
                annotations: { textStyle: { fontSize: 12, color: '#212121', auraColor: 'none' } }, fontName: 'Roboto'
            });
        } else {
            newHiresChartDiv.innerHTML = noDataHtml;
        }

        // --- REVISED: Draw Age Generation Chart with consistent styling ---
        const ageChartDiv = document.getElementById('age_generation_chart_div');
        if (ageChartDiv) {
            const totalAges = Object.values(data.ageGenerationCounts).reduce((a, b) => a + b, 0);
            if (totalAges > 0) {
                // Use the same helper function as the gender chart
                const ageChartDataResult = createPieChartData(data.ageGenerationCounts);
                const ageChart = new google.visualization.PieChart(ageChartDiv);
                ageChart.draw(ageChartDataResult.data, {
                    is3D: true,
                    // Apply the same styling options
                    legend: { position: 'labeled', textStyle: { color: 'black', bold: true, italic: true } },
                    pieSliceText: 'none',
                    tooltip: { text: 'value' },
                    chartArea: {'width': '100%', 'height': '90%'},
                    fontName: 'Roboto',
                    colors: ['#f97316', '#9333ea', '#16a34a', '#3b82f6', '#64748b'] // Orange, Purple, Green, Blue, Gray
                });
            } else {
                ageChartDiv.innerHTML = noDataHtml;
            }
        }
        
      })
      .withFailureHandler(function(err) {
        document.getElementById('demographics-view').innerHTML = `<p class="text-red-500">Could not load analytics data. Error: ${err.message}</p>`;
      })
      .getAnalyticsData(filters);
  }

  function populateResignationFilters() {
    let sourceData = fullEmployeeData;
    
    // Handle dependent location filters
    RESIGNATION_FILTERS_CONFIG.forEach(config => {
        const currentValue = document.getElementById(config.valueId).value;
        const options = [config.defaultLabel, ...new Set(sourceData.map(e => e[config.id]).filter(String).sort())];
        
        createSearchableDropdown(config.containerId, options, null, null, (selection) => {
            const newValue = (selection === config.defaultLabel) ? 'all' : selection;
            if (document.getElementById(config.valueId).value !== newValue) {
                document.getElementById(config.valueId).value = newValue;
                
                let childIdToReset = config.id;
                let childConfig = RESIGNATION_FILTERS_CONFIG.find(f => f.parent === childIdToReset);
                while (childConfig) {
                    document.getElementById(childConfig.valueId).value = 'all';
                    childIdToReset = childConfig.id;
                    childConfig = RESIGNATION_FILTERS_CONFIG.find(f => f.parent === childIdToReset);
                }
                
                populateResignationFilters(); 
                drawResignationCharts(true);
            }
        });
        setSearchableDropdownValue(config.containerId, currentValue === 'all' ? config.defaultLabel : currentValue);

        if (currentValue !== 'all') {
            sourceData = sourceData.filter(emp => emp[config.id] === currentValue);
        }
    });

    // Handle non-dependent filters
    const lists = dropdownListData;
    const refreshCallback = () => drawResignationCharts(true);
    createSearchableDropdown('resignation-joblevel-filter-container', ['All Job Levels', ...(lists.joblevel || [])], null, null, refreshCallback);
    createSearchableDropdown('resignation-gender-filter-container', ['All Genders', 'Male', 'Female'], null, null, refreshCallback);
    createSearchableDropdown('resignation-jobtitle-filter-container', ['All Job Titles', ...(lists.jobtitle || [])], null, null, refreshCallback);
    
    const currentYear = new Date().getFullYear();
    const years = ['All Years', ...Array.from({length: 11}, (_, i) => (currentYear - i).toString())];
    const months = ['All Months', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    createSearchableDropdown('resignation-year-filter-container', years, null, null, refreshCallback);
    createSearchableDropdown('resignation-month-filter-container', months, null, null, refreshCallback);

    if (!resignationFiltersPopulated) {
      document.getElementById('resignation-reset-filters-btn').addEventListener('click', resetResignationFilters);
      resignationFiltersPopulated = true;
    }
  }

  function resetResignationFilters() {
      RESIGNATION_FILTERS_CONFIG.forEach(config => {
          document.getElementById(config.valueId).value = 'all';
      });
      
      // Also reset non-dependent filters to their default "All..." state
      document.querySelector('#resignation-joblevel-filter-container .searchable-dropdown-input').value = 'All Job Levels';
      document.querySelector('#resignation-gender-filter-container .searchable-dropdown-input').value = 'All Genders';
      document.querySelector('#resignation-jobtitle-filter-container .searchable-dropdown-input').value = 'All Job Titles';
      document.querySelector('#resignation-year-filter-container .searchable-dropdown-input').value = 'All Years';
      document.querySelector('#resignation-month-filter-container .searchable-dropdown-input').value = 'All Months';
      
      populateResignationFilters();
      drawResignationCharts(true);
  }

  function drawResignationCharts(forceRefresh = false) {
    if (resignationDataLoaded && !forceRefresh) return;
    resignationDataLoaded = true; 
    
    const chartDivs = ['monthly_turnover_chart_div', 'reason_chart_div', 'resignation_gender_chart_div', 'resignation_contract_chart_div', 'resignation_division_chart_div', 'resignation_job_group_chart_div', 'hires_leavers_chart_div', 'ytd_turnover_chart_div', 'retention_rate_chart_div', 'attrition_rate_chart_div'];
    chartDivs.forEach(id => {
        if (document.getElementById(id)) {
            document.getElementById(id).innerHTML = '<div class="flex justify-center items-center h-full"><div id="loader"></div></div>';
        }
    });

    const filters = {
      division: document.getElementById('resignation-division-filter-value').value,
      group: document.getElementById('resignation-group-filter-value').value,
      department: document.getElementById('resignation-department-filter-value').value,
      section: document.getElementById('resignation-section-filter-value').value,
      jobLevel: document.querySelector('#resignation-joblevel-filter-container .searchable-dropdown-input').value,
      gender: document.querySelector('#resignation-gender-filter-container .searchable-dropdown-input').value,
      jobTitle: document.querySelector('#resignation-jobtitle-filter-container .searchable-dropdown-input').value,
      year: document.querySelector('#resignation-year-filter-container .searchable-dropdown-input').value,
      month: document.querySelector('#resignation-month-filter-container .searchable-dropdown-input').value,
    };

    google.script.run
        .withSuccessHandler(function(data) {
            document.querySelector('#resignation-headcount-card p').textContent = data.filteredResignationsCount;
            document.querySelector('#resignation-hired-card p').textContent = data.yearlyHiresLeavers.hires;

            const createPieChartData = (counts) => {
                const dataArray = [['Category', 'Count']];
                const total = Object.values(counts).reduce((sum, value) => sum + value, 0);
                if (total === 0) {
                    dataArray.push(['No Data', 1]);
                    return { data: google.visualization.arrayToDataTable(dataArray), isNoData: true, sortedKeys: [] };
                }
                const sortedKeys = Object.keys(counts).sort();
                for (const key of sortedKeys) {
                    const value = counts[key];
                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                    const label = `${key}: ${value} (${percentage}%)`;
                    dataArray.push([label, value]);
                }
                return { data: google.visualization.arrayToDataTable(dataArray), isNoData: false, sortedKeys: sortedKeys };
            };

            const noDataHtml = '<div class="flex justify-center items-center h-full"><p class="text-gray-500">No data available for this selection.</p></div>';

            // Draw Reason for Leaving Chart
            const reasonChartDiv = document.getElementById('reason_chart_div');
            if (Object.keys(data.reasonCounts).length > 0) {
                const reasonDataArray = [['Reason', 'Count', { role: 'annotation' }]];
                Object.entries(data.reasonCounts).sort((a,b) => a[0].localeCompare(b[0])).forEach(([key, value]) => reasonDataArray.push([key, value, value]));
                const reasonData = google.visualization.arrayToDataTable(reasonDataArray);
                const reasonChart = new google.visualization.BarChart(reasonChartDiv);
                reasonChart.draw(reasonData, { is3D: true, colors: ['#6B7280'], legend: { position: 'none' }, annotations: { textStyle: { fontSize: 12, color: '#212121', auraColor: 'none' } }, fontName: 'Roboto' });
            } else {
                reasonChartDiv.innerHTML = noDataHtml;
            }

            // Draw Resignation by Gender
            const genderChartDiv = document.getElementById('resignation_gender_chart_div');
            if (Object.keys(data.resignationGenderCounts).length > 0) {
                const genderChartDataResult = createPieChartData(data.resignationGenderCounts);
                const genderChart = new google.visualization.PieChart(genderChartDiv);
                const genderSlices = {};
                const femaleIndex = genderChartDataResult.sortedKeys.indexOf('Female');
                const maleIndex = genderChartDataResult.sortedKeys.indexOf('Male');
                if (femaleIndex !== -1) genderSlices[femaleIndex] = { color: '#ef4444' };
                if (maleIndex !== -1) genderSlices[maleIndex] = { color: '#3b82f6' };
                genderChart.draw(genderChartDataResult.data, {
                    is3D: true, legend: { position: 'labeled', textStyle: { color: 'black', bold: true, italic: true } },
                    pieSliceText: 'none', tooltip: { text: 'value' }, chartArea: {'width': '100%', 'height': '90%'},
                    slices: genderSlices, fontName: 'Roboto'
                });
            } else {
                genderChartDiv.innerHTML = noDataHtml;
            }

            // Draw Resignation by Contract Type
            const contractChartDiv = document.getElementById('resignation_contract_chart_div');
            if (Object.keys(data.resignationContractCounts).length > 0) {
                const contractDataArray = [['Contract Type', 'Count', { role: 'annotation' }]];
                Object.entries(data.resignationContractCounts).sort((a,b) => a[0].localeCompare(b[0])).forEach(([key, value]) => contractDataArray.push([key, value, value]));
                const contractData = google.visualization.arrayToDataTable(contractDataArray);
                const contractChart = new google.visualization.BarChart(contractChartDiv);
                contractChart.draw(contractData, { is3D: true, colors: ['#10B981'], legend: { position: 'none' }, annotations: { textStyle: { fontSize: 12, color: '#212121', auraColor: 'none' } }, fontName: 'Roboto' });
            } else {
                contractChartDiv.innerHTML = noDataHtml;
            }
            
            // Draw Resignation by Division
            const divisionChartDiv = document.getElementById('resignation_division_chart_div');
            if (Object.keys(data.resignationDivisionCounts).length > 0) {
                const divisionDataArray = [['Division', 'Count', { role: 'annotation' }]];
                Object.entries(data.resignationDivisionCounts).sort((a,b) => a[0].localeCompare(b[0])).forEach(([key, value]) => divisionDataArray.push([key, value, value]));
                const divisionData = google.visualization.arrayToDataTable(divisionDataArray);
                const divisionChart = new google.visualization.ColumnChart(divisionChartDiv);
                divisionChart.draw(divisionData, { is3D: true, colors: ['#8B5CF6'], legend: { position: 'none' }, vAxis: { minValue: 0 }, annotations: { textStyle: { fontSize: 12, color: '#212121', auraColor: 'none' } }, fontName: 'Roboto' });
            } else {
                divisionChartDiv.innerHTML = noDataHtml;
            }

            // Draw Resignation by Job Group
            const jobGroupChartDiv = document.getElementById('resignation_job_group_chart_div');
            if (Object.keys(data.resignationJobGroupCounts).length > 0) {
                const jobGroupChartDataResult = createPieChartData(data.resignationJobGroupCounts);
                const jobGroupChart = new google.visualization.PieChart(jobGroupChartDiv);
                jobGroupChart.draw(jobGroupChartDataResult.data, {
                    is3D: true, legend: { position: 'labeled', textStyle: { color: 'black', bold: true, italic: true } },
                    pieSliceText: 'none', tooltip: { text: 'value' }, chartArea: {'width': '100%', 'height': '90%'},
                    colors: ['#F59E0B', '#14B8A6', '#EC4899', '#6366F1', '#84CC16'], fontName: 'Roboto'
                });
            } else {
                jobGroupChartDiv.innerHTML = noDataHtml;
            }
            
            // Draw Monthly Turnover Rate
            const turnoverChartDiv = document.getElementById('monthly_turnover_chart_div');
            const totalSeparations = data.monthlyTurnover.reduce((sum, item) => sum + item.separations, 0);
            if (totalSeparations > 0) {
                const turnoverData = new google.visualization.DataTable();
                turnoverData.addColumn('string', 'Month');
                turnoverData.addColumn('number', 'Separations');
                turnoverData.addColumn({type: 'string', role: 'annotation'});
                turnoverData.addColumn('number', 'Turnover Rate');
                data.monthlyTurnover.forEach(d => {
                    turnoverData.addRow([d.month, d.separations, d.separations.toString(), d.rate]);
                });
                const turnoverChart = new google.visualization.ComboChart(turnoverChartDiv);
                turnoverChart.draw(turnoverData, {
                    is3D: true, seriesType: 'bars', series: {1: {type: 'line', color: '#EF4444', targetAxisIndex: 1}},
                    vAxes: { 0: {title: 'Number of Separations', minValue: 0}, 1: {title: 'Rate (%)', minValue: 0, format: '#.##'}},
                    legend: { position: 'top' }, colors: ['#3B82F6'], fontName: 'Roboto'
                });
            } else {
                turnoverChartDiv.innerHTML = noDataHtml;
            }

            // Draw Yearly Hires and Leavers Chart
            const hiresLeaversChartDiv = document.getElementById('hires_leavers_chart_div');
            if (data.yearlyHiresLeavers.hires > 0 || data.yearlyHiresLeavers.leavers > 0) {
                const hiresLeaversCounts = { 'Hires': data.yearlyHiresLeavers.hires || 0, 'Leavers': data.yearlyHiresLeavers.leavers || 0 };
                const hiresLeaversChartDataResult = createPieChartData(hiresLeaversCounts);
                const hiresLeaversChart = new google.visualization.PieChart(hiresLeaversChartDiv);
                hiresLeaversChart.draw(hiresLeaversChartDataResult.data, {
                    is3D: true, legend: { position: 'labeled', textStyle: { color: 'black', bold: true, italic: true } },
                    pieSliceText: 'none', tooltip: { text: 'value' }, chartArea: {'width': '100%', 'height': '90%'},
                    colors: ['#22C55E', '#F97316'], fontName: 'Roboto'
                });
            } else {
                hiresLeaversChartDiv.innerHTML = noDataHtml;
            }

            // Draw YTD Turnover Chart
            const ytdTurnoverChartDiv = document.getElementById('ytd_turnover_chart_div');
            if (data.ytdTurnover > 0) {
                const ytdTurnoverData = google.visualization.arrayToDataTable([
                    ['Year', 'YTD Turnover Rate (%)', { role: 'annotation' }],
                    [filters.year || new Date().getFullYear().toString(), data.ytdTurnover, data.ytdTurnover.toFixed(2) + '%']
                ]);
                const ytdTurnoverChart = new google.visualization.ColumnChart(ytdTurnoverChartDiv);
                ytdTurnoverChart.draw(ytdTurnoverData, { is3D: true, colors: ['#D946EF'], legend: { position: 'none' }, vAxis: { title: 'Rate (%)', minValue: 0, format: '#.##' }, fontName: 'Roboto' });
            } else {
                ytdTurnoverChartDiv.innerHTML = noDataHtml;
            }

            // ===== START: NEW ATTRITION RATE CHART LOGIC =====
            const attritionRateChartDiv = document.getElementById('attrition_rate_chart_div');
            if (data.attritionRate > 0) {
              const attritionRateData = google.visualization.arrayToDataTable([
                  ['Year', 'YTD Attrition Rate (%)', { role: 'annotation' }],
                  [filters.year || new Date().getFullYear().toString(), data.attritionRate, data.attritionRate.toFixed(2) + '%']
                ]);
                const attritionRateChart = new google.visualization.ColumnChart(attritionRateChartDiv);
                attritionRateChart.draw(attritionRateData, { is3D: true, colors: ['#F97316'], legend: { position: 'none' }, vAxis: { title: 'Rate (%)', minValue: 0, format: '#.##' }, fontName: 'Roboto' });
            } else {
                attritionRateChartDiv.innerHTML = noDataHtml;
            }
            // ===== END: NEW ATTRITION RATE CHART LOGIC =====

            // Draw YTD Retention Rate Chart
            const retentionRateChartDiv = document.getElementById('retention_rate_chart_div');
            if (data.retentionRate > 0) {
                const retentionRateData = google.visualization.arrayToDataTable([
                    ['Year', 'YTD Retention Rate (%)', { role: 'annotation' }],
                    [filters.year || new Date().getFullYear().toString(), data.retentionRate, data.retentionRate.toFixed(2) + '%']
                ]);
                const retentionRateChart = new google.visualization.ColumnChart(retentionRateChartDiv);
                retentionRateChart.draw(retentionRateData, { is3D: true, colors: ['#22C55E'], legend: { position: 'none' }, vAxis: { title: 'Rate (%)', minValue: 0, format: '#.##' }, fontName: 'Roboto' });
            } else {
                retentionRateChartDiv.innerHTML = noDataHtml;
            }

        })
        .withFailureHandler(function(err) {
            document.getElementById('resignation-view').innerHTML = `<p class="text-red-500">Could not load resignation data. Error: ${err.message}</p>`;
        })
        .getResignationData(filters);
  }

  function populateMovementFilters() {
    let sourceData = fullEmployeeData;
    
    MOVEMENT_FILTERS_CONFIG.forEach(config => {
        const currentValue = document.getElementById(config.valueId).value;
        const options = [config.defaultLabel, ...new Set(sourceData.map(e => e[config.id]).filter(String).sort())];
        
        createSearchableDropdown(config.containerId, options, null, null, (selection) => {
            const newValue = (selection === config.defaultLabel) ? 'all' : selection;
            if (document.getElementById(config.valueId).value !== newValue) {
                document.getElementById(config.valueId).value = newValue;
                
                let childIdToReset = config.id;
                let childConfig = MOVEMENT_FILTERS_CONFIG.find(f => f.parent === childIdToReset);
                while (childConfig) {
                    document.getElementById(childConfig.valueId).value = 'all';
                    childIdToReset = childConfig.id;
                    childConfig = MOVEMENT_FILTERS_CONFIG.find(f => f.parent === childIdToReset);
                }
                
                populateMovementFilters(); 
                drawEmployeeMovementCharts(true);
            }
        });
        setSearchableDropdownValue(config.containerId, currentValue === 'all' ? config.defaultLabel : currentValue);

        if (currentValue !== 'all') {
            sourceData = sourceData.filter(emp => emp[config.id] === currentValue);
        }
    });

    const lists = dropdownListData;
    const refreshCallback = () => drawEmployeeMovementCharts(true);
    createSearchableDropdown('movement-joblevel-filter-container', ['All Job Levels', ...(lists.joblevel || [])], null, null, refreshCallback);
    createSearchableDropdown('movement-gender-filter-container', ['All Genders', 'Male', 'Female'], null, null, refreshCallback);
    createSearchableDropdown('movement-jobtitle-filter-container', ['All Job Titles', ...(lists.jobtitle || [])], null, null, refreshCallback);
    
    const currentYear = new Date().getFullYear();
    const years = ['All Years', ...Array.from({length: 11}, (_, i) => (currentYear - i).toString())];
    const months = ['All Months', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    createSearchableDropdown('movement-year-filter-container', years, null, null, refreshCallback);
    createSearchableDropdown('movement-month-filter-container', months, null, null, refreshCallback);

    if (!movementFiltersPopulated) {
      document.getElementById('movement-reset-filters-btn').addEventListener('click', resetMovementFilters);
      movementFiltersPopulated = true;
    }
  }

  function resetMovementFilters() {
      MOVEMENT_FILTERS_CONFIG.forEach(config => {
          document.getElementById(config.valueId).value = 'all';
      });
      
      document.querySelector('#movement-joblevel-filter-container .searchable-dropdown-input').value = 'All Job Levels';
      document.querySelector('#movement-gender-filter-container .searchable-dropdown-input').value = 'All Genders';
      document.querySelector('#movement-jobtitle-filter-container .searchable-dropdown-input').value = 'All Job Titles';
      document.querySelector('#movement-year-filter-container .searchable-dropdown-input').value = 'All Years';
      document.querySelector('#movement-month-filter-container .searchable-dropdown-input').value = 'All Months';
      
      populateMovementFilters();
      drawEmployeeMovementCharts(true);
  }

  // PASTE THIS ENTIRE CORRECTED FUNCTION
function drawEmployeeMovementCharts(forceRefresh = false) {
    if (employeeMovementDataLoaded && !forceRefresh) return;
    employeeMovementDataLoaded = true; 

    const chartDivs = ['promo_by_dept_chart_div', 'transfer_by_dept_chart_div', 'promotion_rate_chart_div', 'transfer_rate_chart_div'];
    chartDivs.forEach(id => {
        document.getElementById(id).innerHTML = '<div class="flex justify-center items-center h-full"><div id="loader"></div></div>';
    });

    const filters = {
      division: document.getElementById('movement-division-filter-value').value,
      group: document.getElementById('movement-group-filter-value').value,
      department: document.getElementById('movement-department-filter-value').value,
      section: document.getElementById('movement-section-filter-value').value,
      jobLevel: document.querySelector('#movement-joblevel-filter-container .searchable-dropdown-input').value,
      gender: document.querySelector('#movement-gender-filter-container .searchable-dropdown-input').value,
      jobTitle: document.querySelector('#movement-jobtitle-filter-container .searchable-dropdown-input').value,
      year: document.querySelector('#movement-year-filter-container .searchable-dropdown-input').value,
      month: document.querySelector('#movement-month-filter-container .searchable-dropdown-input').value,
    };

    google.script.run
        .withSuccessHandler(function(data) {
            const noDataHtml = '<div class="flex justify-center items-center h-full"><p class="text-gray-500">No data available for this selection.</p></div>';

            document.querySelector('#movement-promoted-card p').textContent = data.promotionCount;
            document.querySelector('#movement-transferred-card p').textContent = data.transferCount;

            // Promotions by Dept
            const promoDeptChartDiv = document.getElementById('promo_by_dept_chart_div');
            if (data.promotionCount > 0) {
                const promoDeptData = new google.visualization.DataTable();
                promoDeptData.addColumn('string', 'Department');
                promoDeptData.addColumn('number', 'Promotions');
                // Add annotation column for data labels
                promoDeptData.addColumn({type: 'string', role: 'annotation'}); 
                Object.entries(data.promotionsByDept).forEach(([dept, count]) => {
                    // Add the count as the label
                    promoDeptData.addRow([dept, count, count.toString()]); 
                });
                const promoDeptChart = new google.visualization.BarChart(promoDeptChartDiv);
                // Add annotations option to display labels
                promoDeptChart.draw(promoDeptData, { is3D: true, colors: ['#22C55E'], fontName: 'Roboto', legend: { position: 'none' }, annotations: { textStyle: { fontSize: 12, color: '#212121', auraColor: 'none' } } });
            } else {
                promoDeptChartDiv.innerHTML = noDataHtml;
            }

            // Transfers by Dept
            const transferDeptChartDiv = document.getElementById('transfer_by_dept_chart_div');
            if (data.transferCount > 0) {
                const transferDeptData = new google.visualization.DataTable();
                transferDeptData.addColumn('string', 'Department');
                transferDeptData.addColumn('number', 'Transfers');
                 // Add annotation column for data labels
                transferDeptData.addColumn({type: 'string', role: 'annotation'});
                Object.entries(data.transfersByDept).forEach(([dept, count]) => {
                    // Add the count as the label
                    transferDeptData.addRow([dept, count, count.toString()]);
                });
                const transferDeptChart = new google.visualization.BarChart(transferDeptChartDiv);
                // Add annotations option to display labels
                transferDeptChart.draw(transferDeptData, { is3D: true, colors: ['#3B82F6'], fontName: 'Roboto', legend: { position: 'none' }, annotations: { textStyle: { fontSize: 12, color: '#212121', auraColor: 'none' } } });
            } else {
                transferDeptChartDiv.innerHTML = noDataHtml;
            }

            // Promotion Rate
            const promoRateChartDiv = document.getElementById('promotion_rate_chart_div');
            if (data.promotionRate > 0) {
                // Add annotation column and value for the data label
                const promoRateData = google.visualization.arrayToDataTable([
                    ['Metric', 'Rate', { role: 'style' }, { role: 'annotation' }],
                    ['Promotion Rate', data.promotionRate, '#F59E0B', data.promotionRate.toFixed(2) + '%']
                ]);
                const promoRateChart = new google.visualization.ColumnChart(promoRateChartDiv);
                // Add annotations option to display labels
                promoRateChart.draw(promoRateData, { is3D: true, fontName: 'Roboto', vAxis: { title: 'Rate (%)', minValue: 0, format: '#.##' }, legend: { position: 'none' }, annotations: { textStyle: { fontSize: 12, color: '#212121', auraColor: 'none' } } });
            } else {
                promoRateChartDiv.innerHTML = noDataHtml;
            }

            // Transfer Rate
            const transferRateChartDiv = document.getElementById('transfer_rate_chart_div');
            if (data.transferRate > 0) {
                // Add annotation column and value for the data label
                const transferRateData = google.visualization.arrayToDataTable([
                    ['Metric', 'Rate', { role: 'style' }, { role: 'annotation' }],
                    ['Transfer Rate', data.transferRate, '#8B5CF6', data.transferRate.toFixed(2) + '%']
                ]);
                const transferRateChart = new google.visualization.ColumnChart(transferRateChartDiv);
                 // Add annotations option to display labels
                transferRateChart.draw(transferRateData, { is3D: true, fontName: 'Roboto', vAxis: { title: 'Rate (%)', minValue: 0, format: '#.##' }, legend: { position: 'none' }, annotations: { textStyle: { fontSize: 12, color: '#212121', auraColor: 'none' } } });
            } else {
                transferRateChartDiv.innerHTML = noDataHtml;
            }
        })
        .withFailureHandler(function(err) {
            document.getElementById('employee-movement-view').innerHTML = `<p class="text-red-500">Could not load employee movement data. Error: ${err.message}</p>`;
        })
        .getEmployeeMovementData(filters);
}

  function showLoader() { document.getElementById('loader-container').style.display = 'flex'; }
  function hideLoader() { document.getElementById('loader-container').style.display = 'none'; }
  
  function fetchData() {
    showLoader();
    google.script.run.withSuccessHandler(onDataFetched).withFailureHandler(onFetchError).getEmployeeData();
    google.script.run.withSuccessHandler(renderNotifications).getUpcomingDues();
  }

  function onDataFetched(data) {
    if (!data) {
      hideLoader();
      console.error('Error: Fetched data is null. The backend script may have encountered a critical error.');
      document.getElementById('chart_div').innerHTML = '<p class="text-red-600 p-4 font-bold">Error: Could not load data from the server. Please check logs.</p>';
      return;
    }
  
    fullEmployeeData = data.current;
    previousHeadcountData = data.previous;
    snapshotTimestamp = data.snapshotTimestamp;
    currentUserEmail = data.currentUserEmail;
    userCanEdit = data.canEdit;
    userCanApprove = data.canApprove;
    totalApprovedPlantilla = data.totalApprovedPlantilla;
    previousDateString = data.previousDateString;
    dropdownListData = data.dropdownListData;
    employeeMap = new Map(fullEmployeeData.map(emp => [emp.nodeId, emp]));

    if(userCanEdit) {
      document.getElementById('add-employee-btn').style.display = 'block';
    } else {
      document.getElementById('request-change-btn').style.display = 'block';
      document.getElementById('tab-my-requests').style.display = 'block';
    }
    if (userCanApprove) {
      document.getElementById('tab-approvals').style.display = 'block';
    }
    
    google.script.run.withSuccessHandler(updateNotificationBadges).getRequestCounts();

    populateLevelLegend();
    setupPageEventListeners();
    populateFilters(); // Populates Org Chart filters
    
    updateUI();

    // --- FIX START: Refresh Competency Filters with Loaded Data ---
    // If the user navigated to the Competency tab while data was still loading,
    // the dropdowns would have been empty. Now that fullEmployeeData is ready, we populate them.
    if (competencyViewInitialized) {
        console.log("Data arrived. Refreshing Competency filters...");
        populateCompetencyFilters(); // Refresh Individual Profile Filters
        populateHeatmapFilters();    // Refresh Team Heatmap Filters
    }
    // --- FIX END ---
  }

function updateNotificationBadges(counts) {
  const pendingRequestsBadge = document.getElementById('pending-requests-badge');
  const rejectedRequestsBadge = document.getElementById('rejected-requests-badge');
  const pendingApprovalsBadge = document.getElementById('pending-approvals-badge');

  const totalMyRequests = (counts.myRequestsPending || 0) + (counts.myRequestsRejected || 0);

  // Update "My Requests" tab badges
  if (totalMyRequests > 0) {
      if (counts.myRequestsPending > 0) {
          pendingRequestsBadge.textContent = counts.myRequestsPending;
          pendingRequestsBadge.style.display = 'inline-block';
      } else {
          pendingRequestsBadge.style.display = 'none';
      }
      if (counts.myRequestsRejected > 0) {
          rejectedRequestsBadge.textContent = counts.myRequestsRejected;
          rejectedRequestsBadge.style.display = 'inline-block';
      } else {
          rejectedRequestsBadge.style.display = 'none';
      }
  } else {
      pendingRequestsBadge.style.display = 'none';
      rejectedRequestsBadge.style.display = 'none';
  }

  // Update "Approvals" tab badge
  if (counts.approvals > 0) {
    pendingApprovalsBadge.textContent = counts.approvals;
    pendingApprovalsBadge.style.display = 'inline-block';
  } else {
    pendingApprovalsBadge.style.display = 'none';
  }
}

  function onFetchError(error) {
    hideLoader();
    console.error('Error fetching data:', error);
    document.getElementById('chart_div').innerHTML = '<p>Error: ' + error.message + '</p>';
  }

  // --- UI & DATA RENDERING ---

  function getDirectFilteredCount() {
  var division = document.getElementById('division-filter-value').value;
  var group = document.getElementById('group-filter-value').value;
  var department = document.getElementById('department-filter-value').value;
  var section = document.getElementById('section-filter-value').value;
  // --- NEW: Get the state of the checkbox ---
  var showInactive = document.getElementById('show-inactive-checkbox').checked;

  return fullEmployeeData.filter(function(emp) {
    // --- REVISED: Conditionally filter based on the checkbox ---
    const isActive = (emp.positionStatus || '').toLowerCase() !== 'inactive';
    if (!showInactive && !isActive) {
        return false; // If we're not showing inactive, and the position is inactive, hide it.
    }

    return (division === 'all' || emp.division === division) &&
           (group === 'all' || emp.group === group) &&
           (department === 'all' || emp.department === department) &&
           (section === 'all' || emp.section === section);
  });
}

  function updateUI() {
    showLoader();
    setTimeout(function() {
      try {
        const filteredData = getDirectFilteredCount();
        renderHeadcountCards(filteredData);
        renderSummary(filteredData);
        renderApprovalSection();
        drawChart(filteredData);
      } catch(e) {
        console.error("Error during UI update:", e);
        document.getElementById('overall-summary-content').innerHTML = `<p class="text-red-500">A critical error occurred while rendering the summary. Please check the console (F12) for details.</p>`;
        document.getElementById('chart_div').innerHTML = `<p class="text-red-500">A critical error occurred while rendering the chart. Please check the console (F12) for details.</p>`;
      } finally {
        hideLoader();
      }
    }, 10);
  }
  
  function getPlantillaForLevel(div, group, dept, sec) {
    if (!previousHeadcountData) return null;
    
    const get = (p, o) => p.reduce((xs, x) => (xs && xs[x]) ? xs[x] : null, o);

    if (sec && sec !== 'all') {
      for (const divKey in previousHeadcountData) {
        if (div !== 'all' && divKey !== div) continue;
        for (const groupKey in get([divKey, 'groups'], previousHeadcountData)) {
          if (group !== 'all' && groupKey !== group) continue;
          for (const deptKey in get([divKey, 'groups', groupKey, 'departments'], previousHeadcountData)) {
            if (dept !== 'all' && deptKey !== dept) continue;
            const sectionData = get([divKey, 'groups', groupKey, 'departments', deptKey, 'sections', sec], previousHeadcountData);
            if (sectionData) return sectionData.plantilla;
          }
        }
      }
      return null;
    }

    if (dept && dept !== 'all') {
      let total = 0;
      let found = false;
      for (const divKey in previousHeadcountData) {
        if (div !== 'all' && divKey !== div) continue;
        for (const groupKey in get([divKey, 'groups'], previousHeadcountData)) {
          if (group !== 'all' && groupKey !== group) continue;
          const deptData = get([divKey, 'groups', groupKey, 'departments', dept], previousHeadcountData);
          if (deptData) {
            total += deptData.plantilla || 0;
            found = true;
          }
        }
      }
      return found ? total : null;
    }
    
    if (group && group !== 'all') {
      let total = 0;
      let found = false;
      for (const divKey in previousHeadcountData) {
        if (div !== 'all' && divKey !== div) continue;
        const groupData = get([divKey, 'groups', group], previousHeadcountData);
        if (groupData) {
          total += groupData.plantilla || 0;
          found = true;
        }
      }
      return found ? total : null;
    }

    if (div && div !== 'all') {
      const divData = get([div], previousHeadcountData);
      return divData ? divData.plantilla : null;
    }

    return totalApprovedPlantilla;
  }

  function renderHeadcountCards(filteredData) {
    const filledCount = filteredData.filter(p => !!p.employeeId).length;
    const vacantCount = filteredData.length - filledCount;
    const headcountCard = document.getElementById('filtered-headcount-card');
    headcountCard.innerHTML =
      '<h3 class="font-bold text-lg mb-2">Filtered Headcount</h3>' +
      '<p class="text-3xl font-bold">' + filteredData.length + '</p>' +
      '<p class="text-sm mt-1">Filled: ' + filledCount + ', Vacant: ' + vacantCount + '</p>';
    const plantillaCard = document.getElementById('plantilla-headcount-card');

    const division = document.getElementById('division-filter-value').value;
    const group = document.getElementById('group-filter-value').value;
    const department = document.getElementById('department-filter-value').value;
    const section = document.getElementById('section-filter-value').value;

    const filteredPlantilla = getPlantillaForLevel(division, group, department, section);

    if (filteredPlantilla === null || filteredPlantilla === undefined) {
      plantillaCard.innerHTML =
      '<h3 class="font-bold text-lg mb-2">Approved Plantilla</h3>' +
      '<p class="text-3xl font-bold text-gray-400">N/A</p>' +
      '<p class="text-sm mt-1">No plantilla data for this filter.</p>';
      plantillaCard.className = 'bg-gray-100 border-l-4 border-gray-400 text-gray-800 p-4 rounded-md shadow';
    } else {
      const variance = filteredData.length - filteredPlantilla;
      let varianceText = '';
      let cardClass = '';
      if (variance > 0) {
        varianceText = '<p class="text-sm mt-1 font-bold">Over by ' + variance + '</p>';
        cardClass = 'bg-red-100 border-l-4 border-red-500 text-red-800 p-4 rounded-md shadow';
      } else if (variance < 0) {
        varianceText = '<p class="text-sm mt-1 font-bold">Under by ' + (-variance) + '</p>';
        cardClass = 'bg-green-100 border-l-4 border-green-500 text-green-800 p-4 rounded-md shadow';
      } else {
        varianceText = '<p class="text-sm mt-1 font-bold">Matches Plantilla</p>';
        cardClass = 'bg-gray-100 border-l-4 border-gray-500 text-gray-800 p-4 rounded-md shadow';
      }
      plantillaCard.innerHTML =
        '<h3 class="font-bold text-lg mb-2">Approved Plantilla</h3>' +
        '<p class="text-3xl font-bold">' + filteredPlantilla + '</p>' +
        varianceText;
      plantillaCard.className = cardClass;
    }
  }

function drawChart(filteredData) {
      var chartDataForDisplay = getChartData(filteredData);
      if (chartDataForDisplay.length === 0) {
          document.getElementById('chart_div').innerHTML = '<p class="text-center text-gray-500 pt-10">No positions match filter.</p>';
          return;
      }
      dataTable = new google.visualization.DataTable();
      dataTable.addColumn('string', 'Node ID');
      dataTable.addColumn('string', 'Reporting to ID');
      chartDataForDisplay.forEach(function(emp) {
          let nodeHtml;
          let actionsHtml = '';
          const isInactive = (emp.positionStatus || '').toUpperCase() === 'INACTIVE';

          let inactiveOverlayHtml = '';
          if (isInactive) {
              inactiveOverlayHtml = '<div class="inactive-overlay">INACTIVE</div>';
          }

          if (userCanEdit) {
              let primaryActionBtn = '';
              if (isInactive) {
                  primaryActionBtn = '<button title="Reactivate" onclick="event.stopPropagation(); reactivateEmployee(\'' + emp.positionId + '\')" class="action-btn">' +
                                        '<svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd"></path></svg>' +
                                      '</button>';
              } else {
                  primaryActionBtn = '<button title="Deactivate" onclick="event.stopPropagation(); deactivateEmployee(\'' + emp.positionId + '\')" class="action-btn">' +
                                        '<svg class="w-4 h-4 text-red-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>' +
                                      '</button>';
              }

              // --- NEW BUTTON ADDED HERE ---
              let competencyBtn = '';
              if (emp.employeeId) { // Only show for filled positions
                  competencyBtn = '<button title="View Competency Profile" onclick="event.stopPropagation(); viewCompetencyProfile(\'' + emp.employeeId + '\')" class="action-btn">' +
                                    '<svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>' +
                                  '</button>';
              }

              actionsHtml = '<div class="node-actions">' +
                              '<button title="Edit" onclick="event.stopPropagation(); openModal(\'edit\', \'' + emp.nodeId + '\')" class="action-btn">' +
                                '<svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM5 14l-1 4 4-1 7.586-7.586-2.828-2.828L5 14z"></path></svg>' +
                              '</button>' +
                              primaryActionBtn +
                              competencyBtn + // Add the new button to the list
                              '<button title="Job Description" onclick="event.stopPropagation(); openJdModal(\'' + emp.positionId + '\', \'' + (emp.employeeId || '') + '\', \'' + (emp.jobTitle || '') + '\')" class="action-btn">' +
                                '<svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a2 2 0 00-2 2v8a2 2 0 002 2h2a2 2 0 002-2V4a2 2 0 00-2-2H9z"></path><path d="M4 12a2 2 0 012-2h10a2 2 0 012 2v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5z"></path></svg>' +
                              '</button>' +
                            '</div>';
          }

          if (emp.employeeId) {
              let resignTag = '';
              if (emp.status.toUpperCase() === 'RESIGNED' && emp.resignationDate) {
                  resignTag = '<div style="position: absolute; top: 4px; left: 4px; background-color: #ef4444; color: white; padding: 2px 6px; border-radius: 9999px; font-size: 10px; font-weight: bold; z-index: 5;">RESIGNEE (Eff. ' + emp.resignationDate + ')</div>';
              }
              const contractTypeUpper = emp.stylingContractType ? emp.stylingContractType.toUpperCase() : '';
              let levelBorderClass = 'level-' + (emp.level || 'default') + '-border';
              let levelBgClass = 'level-' + (emp.level || 'default') + '-bg';
              let contractClass = '';
              if (contractTypeUpper === 'JREL' || contractTypeUpper === 'JPRO') {
                  levelBorderClass = 'contract-jrel-jpro-border';
                  levelBgClass = 'contract-jrel-jpro-bg';
                  contractClass = 'contract-dashed';
              } else if (contractTypeUpper === 'JREG') {
                  levelBorderClass = 'contract-jreg-border';
                  levelBgClass = 'contract-jreg-bg';
                  contractClass = 'contract-dashed';
              } else if (contractTypeUpper === 'OTHERS') {
                  levelBorderClass = 'contract-others-border';
                  levelBgClass = 'contract-others-bg';
                  contractClass = 'contract-dashed';
              }
              const photoUrl = emp.gender && emp.gender.toLowerCase() === 'female' ? 'https://i.imgur.com/dTvdfy0.png' : 'https://i.imgur.com/bIbZ89x.png';
              const deptSection = emp.section ? (emp.department + ' (' + emp.section + ')') : emp.department;
              const payrollBadge = emp.payrollType ? '<div class="badge bg-badge-payroll">' + emp.payrollType + '</div>' : '';
              const jobLevelBadge = emp.jobLevel ? '<div class="badge bg-badge-joblevel">' + emp.jobLevel + '</div>' : '';
              const contractBadge = emp.contractType ? '<div class="badge bg-badge-contract">' + emp.contractType + '</div>' : '';
              const competencyBadge = emp.competency ? '<div class="badge bg-badge-competency">' + emp.competency + '</div>' : '';
              const badgeHtml = '<div class="badge-grid">' + payrollBadge + jobLevelBadge + contractBadge + competencyBadge + '</div>';
              const normalizedStatus = toTitleCase(emp.status);
              const statusClass = statusColors[normalizedStatus] || '';
              const statusDot = statusClass && !resignTag ? '<div class="status-dot ' + statusClass + '"></div>' : '';
              
              nodeHtml = '<div class="node-card ' + levelBorderClass + ' ' + levelBgClass + ' ' + contractClass + '" onmouseover="showTooltip(event, \'' + emp.nodeId + '\')" onmouseout="hideTooltip()">' +
                            inactiveOverlayHtml + resignTag + statusDot + actionsHtml +
                            '<img src="' + photoUrl + '" onerror="this.onerror=null;this.src=\'https://i.imgur.com/RHvayzz.png\';">' +
                            '<div class="node-text">' +
                              '<div class="name">' + emp.employeeName + '</div>' +
                              '<div class="title">' + emp.jobTitle + '</div>' +
                              '<div class="dept">' + (deptSection || '') + '</div>' +
                            '</div>' +
                            badgeHtml +
                          '</div>';
          } else {
              nodeHtml = '<div class="vacant-card" onmouseover="showTooltip(event, \'' + emp.nodeId + '\')" onmouseout="hideTooltip()">' +
                            inactiveOverlayHtml + actionsHtml +
                            '<div class="name">VACANT</div>' +
                            '<div class="title">' + emp.jobTitle + '</div>' +
                          '</div>';
          }
          dataTable.addRow([{ v: emp.nodeId, f: nodeHtml }, emp.managerId]);
      });
      chart = new google.visualization.OrgChart(document.getElementById('chart_div'));
      chart.draw(dataTable, { allowHtml: true, allowCollapse: true });
    }

function showTooltip(event, nodeId) {
    clearTimeout(tooltipTimeout);
    var employee = employeeMap.get(nodeId); if (!employee) return;
    var tooltipDiv = document.getElementById('custom-tooltip');
    var contentHtml = '';
    var borderColor;
    var borderStyle = 'solid';

    if (employee.employeeId) {
      var contractTypeUpper = employee.stylingContractType ? employee.stylingContractType.toUpperCase() : '';
      if (contractTypeUpper === 'JREL' || contractTypeUpper === 'JPRO') {
        borderColor = '#f97316';
        borderStyle = 'dashed';
      } else if (contractTypeUpper === 'JREG') {
        borderColor = '#3b82f6';
        borderStyle = 'dashed';
      } else if (contractTypeUpper === 'OTHERS') {
        borderColor = '#6b7280';
        borderStyle = 'dashed';
      } else {
        borderColor = levelColors[employee.level] || levelColors.default;
        borderStyle = 'solid';
      }
      var photoUrl = employee.gender && employee.gender.toLowerCase() === 'female' ? 'https://i.imgur.com/dTvdfy0.png' : 'https://i.imgur.com/bIbZ89x.png';
      var imgBorderStyle = 'border-color:' + borderColor + ';';
      contentHtml = '<img src="' + photoUrl + '" style="' + imgBorderStyle + '" onerror="this.onerror=null;this.src=\'https://i.imgur.com/RHvayzz.png\';">' +
      '<p><strong>Position ID:</strong> ' + (employee.positionId || 'N/A') + '</p>' +
      '<p><strong>Emp. ID:</strong> ' + (employee.employeeId || 'N/A') + '</p>' +
      '<p><strong>Name:</strong> ' + (employee.employeeName || 'N/A') + '</p>' +
      '<p><strong>Date Hired:</strong> ' + (employee.dateHired || 'N/A') + '</p>' +
      '<p><strong>Job Title:</strong> ' + (employee.jobTitle || 'N/A') + '</p>' +
      '<p><strong>Division:</strong> ' + (employee.division || 'N/A') + '</p>' +
      '<p><strong>Group:</strong> ' + (employee.group || 'N/A') + '</p>' +
      '<p><strong>Department:</strong> ' + (employee.department || 'N/A') + '</p>' +
      '<p><strong>Section:</strong> ' + (employee.section || 'N/A') + '</p>' +
      '<p><strong>Reporting to:</strong> ' + (employee.managerName || 'N/A') + '</p>';
      
      let incumbentHtml = '<i>No history available</i>';
      if (employee.historicalNote) {
          if (employee.historicalNote.lastIncumbents && employee.historicalNote.lastIncumbents.length > 0) {
              incumbentHtml = employee.historicalNote.lastIncumbents[0];
              incumbentHtml += ` <span onclick="openHistoryModal('${employee.positionId}')" class="text-blue-600 hover:underline cursor-pointer" style="font-weight: bold;">(View History)</span>`;
          } else if (employee.historicalNote.isNewPosition) {
              incumbentHtml = '<i>Newly Created Position</i>';
          }
      }
      contentHtml += '<p><strong>Last Incumbent:</strong> ' + incumbentHtml + '</p>';
      
      if (employee.payrollType) contentHtml += '<p><strong>Payroll Type:</strong> ' + employee.payrollType + '</p>';
      if (employee.jobLevel) contentHtml += '<p><strong>Job Level:</strong> ' + employee.jobLevel + '</p>';
      if (employee.contractType) contentHtml += '<p><strong>Contract Type:</strong> ' + employee.contractType + '</p>';
      if (employee.contractEndDate) contentHtml += '<p><strong>Contract End:</strong> ' + employee.contractEndDate + '</p>';
      if (employee.competency) contentHtml += '<p><strong>Competency:</strong> ' + employee.competency + '</p>';
      
      if (employee.status.toUpperCase() === 'RESIGNED' && employee.resignationDate) {
        contentHtml += '<div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #e5e7eb;">' +
          '<p><strong>Status:</strong> <span style="color: #ef4444; font-weight: bold;">RESIGNEE</span></p>' +
          '<p><strong>Effective Date:</strong> ' + employee.resignationDate + '</p>' +
          '</div>';
      } else {
        var normalizedStatus = toTitleCase(employee.status);
        if (normalizedStatus && statusNotes[normalizedStatus]) {
          var tagColor = statusTagColors[normalizedStatus];
          var note = statusNotes[normalizedStatus];
          contentHtml += '<div id="tooltip-status-section" style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #e5e7eb;">' +
          '<div style="display: flex; align-items: center; font-weight: bold; color: ' + tagColor + ';">' +
          '<span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background-color: ' + tagColor + '; margin-right: 8px;"></span>' + normalizedStatus + '</div>' +
          '<p style="font-size: 11px; color: #6b7280; margin-top: 2px; padding-left: 18px;">' + note + '</p>';
          if (employee.historicalNote && employee.historicalNote.previousRole && ['Internal Transfer', 'Promotion', 'Lateral Transfer'].includes(normalizedStatus)) {
              contentHtml += '<p style="font-size: 11px; color: ' + tagColor + '; padding-left: 18px;"><i>' + employee.historicalNote.previousRole + '</i></p>';
          }
          contentHtml += '</div>';
        }
      }
    } else { // Vacant Node
      borderColor = '#9ca3af';
      borderStyle = 'dashed';
      contentHtml = '<p><strong>Position ID:</strong> ' + (employee.positionId || 'N/A') + '</p>' +
      '<p><strong>Position:</strong> VACANT</p>' +
      '<p><strong>Job Title:</strong> ' + (employee.jobTitle || 'N/A') + '</p>' +
      '<p><strong>Group:</strong> ' + (employee.group || 'N/A') + '</p>' +
      '<p><strong>Department:</strong> ' + (employee.department || 'N/A') + '</p>';
      
      let incumbentHtml = '<i>No history available</i>';
      if (employee.historicalNote && employee.historicalNote.lastIncumbents && employee.historicalNote.lastIncumbents.length > 0) {
          incumbentHtml = employee.historicalNote.lastIncumbents[0];
          incumbentHtml += ` <span onclick="openHistoryModal('${employee.positionId}')" class="text-blue-600 hover:underline cursor-pointer" style="font-weight: bold;">(View History)</span>`;
      }
      contentHtml += '<p><strong>Last Incumbent:</strong> ' + incumbentHtml + '</p>';
    }

    tooltipDiv.innerHTML = contentHtml;
    tooltipDiv.style.borderColor = borderColor;
    tooltipDiv.style.borderStyle = borderStyle;
    var tooltipHeight = tooltipDiv.offsetHeight;
    var yPos = event.pageY - tooltipHeight - 15;
    if (yPos < window.scrollY) {
      yPos = event.pageY + 20;
    }
    var xPos = event.pageX + 15;
    tooltipDiv.style.left = xPos + 'px';
    tooltipDiv.style.top = yPos + 'px';
    tooltipDiv.style.display = 'block';
  }

  function hideTooltip() {
    tooltipTimeout = setTimeout(function() {
      document.getElementById('custom-tooltip').style.display = 'none';
    }, 300);
  }

  function getChartData(filteredData) {
    var finalSet = new Set();
    filteredData.forEach(function(pos) {
      finalSet.add(pos);
    });
    var positionsToProcess = Array.from(finalSet);
    positionsToProcess.forEach(function(pos) {
      var current = pos;
      var path = new Set(); // Keep track of managers in this specific chain
      while (current && current.managerId) {
        if (path.has(current.managerId)) {
          console.error('Circular reference detected in reporting line for position:', pos.positionId, 'at manager:', current.managerId);
          break; // Break the loop to prevent freezing
        }
        path.add(current.managerId);

        var manager = employeeMap.get(current.managerId);
        if (manager && !finalSet.has(manager)) {
          finalSet.add(manager);
          current = manager;
        } else {
          break;
        }
      }
    });
    return Array.from(finalSet);
  }

  function renderSummary(filteredData) {
    var summary = {};
    var groupFilterValue = document.getElementById('group-filter-value').value;
    var departmentFilterValue = document.getElementById('department-filter-value').value;
    var sectionFilterValue = document.getElementById('section-filter-value').value;

    filteredData.forEach(function(pos) {
      if (!pos.division) return;
      var isFilled = !!pos.employeeId;
      var groupKey = pos.group || '';
      var deptKey = pos.department || '';
      var sectKey = pos.section || '';

      if (!summary[pos.division]) summary[pos.division] = { filled: 0, vacant: 0, groups: {} };
      if (!summary[pos.division].groups[groupKey]) summary[pos.division].groups[groupKey] = { filled: 0, vacant: 0, departments: {} };
      if (!summary[pos.division].groups[groupKey].departments[deptKey]) summary[pos.division].groups[groupKey].departments[deptKey] = { filled: 0, vacant: 0, sections: {} };
      if (!summary[pos.division].groups[groupKey].departments[deptKey].sections[sectKey]) summary[pos.division].groups[groupKey].departments[deptKey].sections[sectKey] = { filled: 0, vacant: 0 };
      
      if (isFilled) {
        summary[pos.division].filled++;
        summary[pos.division].groups[groupKey].filled++;
        summary[pos.division].groups[groupKey].departments[deptKey].filled++;
        summary[pos.division].groups[groupKey].departments[deptKey].sections[sectKey].filled++;
      } else {
        summary[pos.division].vacant++;
        summary[pos.division].groups[groupKey].vacant++;
        summary[pos.division].groups[groupKey].departments[deptKey].vacant++;
        summary[pos.division].groups[groupKey].departments[deptKey].sections[sectKey].vacant++;
      }
    });

    var getChangeIndicator = function (current, previous, forVacant) {
      if (typeof previous === 'undefined' || previous === null) return '';
      var delta = current - previous;
      if (isNaN(delta) || delta === 0) return '';
      var sign = delta > 0 ? '+' : '';
      var color = delta > 0 ? (forVacant ? 'text-red-600' : 'text-green-600') : (forVacant ? 'text-green-600' : 'text-red-600');
      return ` <span class="font-bold ${color}">(${sign}${delta})</span>`;
    };

    var container = document.getElementById('overall-summary-content');
    container.innerHTML = '';
    var gridContainer = document.createElement('div');
    gridContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';

    if (Object.keys(summary).length === 0) {
      container.innerHTML = '<p class="text-gray-500 col-span-full">No summary data for this filter.</p>';
      return;
    }

    const formattedPrevDate = previousDateString;

    var allCardsHtml = Object.keys(summary).sort().map(function (divName) {
      var divData = summary[divName];
      var prevDivData = (previousHeadcountData && previousHeadcountData[divName]) ? previousHeadcountData[divName] : {};
      var total = divData.filled + divData.vacant;
      var prevTotal = (prevDivData.filled || 0) + (prevDivData.vacant || 0);
      var plantilla = getPlantillaForLevel(divName, '', '', '');
      var plantillaStatus = '', plantillaClass = '';
      if (plantilla !== null && plantilla !== undefined) {
        if (total > plantilla) {
          plantillaStatus = `<span class="text-red-700 font-bold ml-2">(Over Plantilla by ${total - plantilla})</span>`;
          plantillaClass = 'plantilla-over';
        } else if (total === plantilla) {
          plantillaStatus = `<span class="text-slate-600 font-bold ml-2">(Plantilla: ${plantilla})</span>`;
          plantillaClass = 'plantilla-at';
        } else {
          plantillaStatus = `<span class="text-slate-500 font-medium ml-2">(Plantilla: ${plantilla})</span>`;
        }
      }

      var groupHtmlContent = Object.keys(divData.groups).sort().filter(groupName => groupName).map(function (groupName) {
        var groupData = divData.groups[groupName];
        var prevGroupData = (prevDivData.groups && prevDivData.groups[groupName]) ? prevDivData.groups[groupName] : {};
        var groupTotal = groupData.filled + groupData.vacant;
        var groupPlantilla = getPlantillaForLevel(divName, groupName, '', '');
        var groupPlantillaStatus = '', groupPlantillaClass = '';
        if (groupPlantilla !== null && groupPlantilla !== undefined) {
          if (groupTotal > groupPlantilla) { groupPlantillaStatus = `<span class="text-red-700 font-bold ml-2">(Over by ${groupTotal - groupPlantilla})</span>`; groupPlantillaClass = 'plantilla-over';}
          else if (groupTotal === groupPlantilla) { groupPlantillaStatus = `<span class="text-slate-600 font-bold ml-2">(Plantilla: ${groupPlantilla})</span>`; groupPlantillaClass = 'plantilla-at';}
          else { groupPlantillaStatus = `<span class="text-slate-500 font-medium ml-2">(Plantilla: ${groupPlantilla})</span>`; }
        }

        var departmentHtml = Object.keys(groupData.departments).sort().filter(deptName => deptName).map(function (deptName) {
          var deptData = groupData.departments[deptName];
          var prevDeptData = (prevGroupData.departments && prevGroupData.departments[deptName]) ? prevGroupData.departments[deptName] : {};
          var deptTotal = deptData.filled + deptData.vacant;
          var deptPlantilla = getPlantillaForLevel(divName, groupName, deptName, '');
          var deptPlantillaStatus = '', deptPlantillaClass = '';
          if (deptPlantilla !== null && deptPlantilla !== undefined) {
            if (deptTotal > deptPlantilla) { deptPlantillaStatus = `<span class="text-red-700 font-bold ml-2">(${deptTotal}/${deptPlantilla})</span>`; deptPlantillaClass = 'plantilla-over'; }
            else if (deptTotal === deptPlantilla) { deptPlantillaStatus = `<span class="text-slate-600 font-bold ml-2">(${deptTotal}/${deptPlantilla})</span>`; deptPlantillaClass = 'plantilla-at'; }
            else { deptPlantillaStatus = `<span class="text-slate-500 font-medium ml-2">(${deptTotal}/${deptPlantilla})</span>`; }
          }

          var sectionHtml = Object.keys(deptData.sections).sort().filter(secName => secName).map(function (secName) {
            var secData = deptData.sections[secName];
            var prevSecData = (prevDeptData.sections && prevDeptData.sections[secName]) ? prevDeptData.sections[secName] : {};
            var secTotal = secData.filled + secData.vacant;
            var secPlantilla = getPlantillaForLevel(divName, groupName, deptName, secName);
            var secPlantillaStatus = '', secPlantillaClass = '';
            if (secPlantilla !== null && secPlantilla !== undefined) {
              if (secTotal > secPlantilla) { secPlantillaStatus = `<span class="text-red-700 font-bold ml-2">(${secTotal}/${secPlantilla})</span>`; secPlantillaClass = 'plantilla-over'; }
              else if (secTotal === secPlantilla) { secPlantillaStatus = `<span class="text-slate-600 font-bold ml-2">(${secTotal}/${secPlantilla})</span>`; secPlantillaClass = 'plantilla-at'; }
              else { secPlantillaStatus = `<span class="text-slate-500 font-medium ml-2">(${secTotal}/${secPlantilla})</span>`; }
            }
            return `<div class="pl-8 pr-4 py-2 border-t border-slate-200 bg-slate-50 hover:bg-slate-100 rounded ${secPlantillaClass}">
                        <div class="text-xs text-gray-800 flex justify-between items-center">
                          <div><span class="font-medium">${secName}</span>${secPlantillaStatus}</div>
                          <span class="italic text-right">Filled: ${secData.filled}${getChangeIndicator(secData.filled, (prevSecData.filled || 0), false)}<br>Vacant: ${secData.vacant}${getChangeIndicator(secData.vacant, (prevSecData.vacant || 0), true)}</span>
                        </div>
                        ${formattedPrevDate ? `<div class="text-xs text-gray-500 mt-1"><span>Previous HC: ${(prevSecData.filled || 0) + (prevSecData.vacant || 0)}</span></div>` : ''}
                      </div>`;
          }).join('');
          
          var hasSections = Object.keys(deptData.sections).filter(k => k).length > 0;
          return `<div class="border-t"><details class="text-sm group" ${hasSections ? 'open' : ''}>
            <summary class="flex justify-between items-center cursor-pointer py-2 px-4 hover:bg-slate-100 rounded ${deptPlantillaClass}">
              <div>
                <span class="font-medium text-slate-700">${deptName}</span>${deptPlantillaStatus}
                ${formattedPrevDate ? `<div class="text-xs text-gray-500 mt-1"><span>Previous HC: ${(prevDeptData.filled || 0) + (prevDeptData.vacant || 0)}</span></div>` : ''}
              </div>
              <span class="flex items-center">
                <span class="text-xs text-gray-500 mr-2 italic text-right">Filled: ${deptData.filled}${(sectionFilterValue === 'all') ? getChangeIndicator(deptData.filled, (prevDeptData.filled || 0), false) : ''}<br>Vacant: ${deptData.vacant}${(sectionFilterValue === 'all') ? getChangeIndicator(deptData.vacant, (prevDeptData.vacant || 0), true) : ''}</span>
                <span class="transform transition-transform group-open:rotate-180">${hasSections ? ICONS.toggle : ''}</span>
              </span>
            </summary>
            <div>${sectionHtml}</div>
          </details></div>`;
        }).join('');

        var hasDepartments = Object.keys(groupData.departments).filter(k => k).length > 0;
        return `<div class="border-t"><details class="group" ${hasDepartments ? 'open' : ''}>
          <summary class="flex justify-between items-center cursor-pointer p-2 hover:bg-slate-100 rounded ${groupPlantillaClass}">
            <div>
              <span class="font-semibold text-blue-800">${groupName}</span>${groupPlantillaStatus}
              ${formattedPrevDate ? `<div class="text-xs text-gray-500 mt-1"><span>Previous HC: ${(prevGroupData.filled || 0) + (prevGroupData.vacant || 0)}</span></div>` : ''}
            </div>
            <span class="flex items-center">
              <span class="text-xs text-gray-500 mr-2 italic text-right">Filled: ${groupData.filled}${(departmentFilterValue === 'all') ? getChangeIndicator(groupData.filled, (prevGroupData.filled || 0), false) : ''}<br>Vacant: ${groupData.vacant}${(departmentFilterValue === 'all') ? getChangeIndicator(groupData.vacant, (prevGroupData.vacant || 0), true) : ''}</span>
              <span class="transform transition-transform group-open:rotate-180">${hasDepartments ? ICONS.toggle : ''}</span>
            </span>
          </summary>
          <div class="pl-4">${departmentHtml}</div>
        </details></div>`;
      }).join('');

      var totalChangeHtml = (groupFilterValue === 'all') ? getChangeIndicator(total, prevTotal, false) : '';
      var filledChangeHtml = (groupFilterValue === 'all') ? getChangeIndicator(divData.filled, prevDivData.filled, false) : '';
      var vacantChangeHtml = (groupFilterValue === 'all') ? getChangeIndicator(divData.vacant, prevDivData.vacant, true) : '';

      return `<details class="border rounded-lg shadow-sm bg-white group">
        <summary class="p-4 cursor-pointer ${plantillaClass} rounded-lg">
          <div class="flex justify-between items-center">
            <h4 class="font-bold text-lg text-indigo-800">${divName} (${total})${totalChangeHtml}${plantillaStatus}</h4>
            <span class="transform transition-transform group-open:rotate-180">${ICONS.toggle}</span>
          </div>
          ${formattedPrevDate ? `<div class="flex items-center text-sm text-gray-500 mt-1 px-4">${ICONS.previous}<span>Previous Headcount as of ${formattedPrevDate}: ${prevTotal}</span></div>` : ''}
        </summary>
        <div class="border-t">
          <div class="p-4 space-y-2">
            <div class="flex items-center">${ICONS.filled}<span>Filled Positions:</span><span class="ml-auto font-bold">${divData.filled}${filledChangeHtml}</span></div>
            <div class="flex items-center">${ICONS.vacant}<span>Vacant Positions:</span><span class="ml-auto font-bold">${divData.vacant}${vacantChangeHtml}</span></div>
          </div>
          <div class="border-t">
            <h5 class="px-4 pt-2 pb-1 font-bold text-sm text-slate-700">Group Breakdown</h5>
            ${groupHtmlContent}
          </div>
        </div>
      </details>`;
    }).join('');

    gridContainer.innerHTML = allCardsHtml;
    container.appendChild(gridContainer);
  }

  function populateLevelLegend() {
    var legendContainer = document.getElementById('level-legend');
    legendContainer.innerHTML = '';
    var levelBgColors = { 1: '#f3f4f6', 2: '#fee2e2', 3: '#dbeafe', 4: '#dcfce7', 5: '#f3e8ff', 6: '#fff7ed', 'default': '#f1f5f9' };
    for (var level in levelColors) {
      if (levelColors.hasOwnProperty(level) && level !== 'default') {
        var color = levelColors[level];
        var name = levelNames[level] || 'Level ' + level;
        var borderStyle = 'solid';
        var bgColor = levelBgColors[level] || levelBgColors.default;
        if (level == 6) {
          color = '#000000';
          bgColor = '#ffffff';
          borderStyle = 'dashed';
        }
        legendContainer.innerHTML += '<div class="flex items-center"><div class="w-4 h-4 mr-2 border-2" style="border-color: ' + color + '; background-color: ' + bgColor + '; border-style: ' + borderStyle + ';"></div>' + name + '</div>';
      }
    }
    legendContainer.innerHTML += '<div class="flex items-center"><div class="w-4 h-4 mr-2 border-2 border-dashed" style="border-color: #9ca3af; background-color: #f9fafb;"></div>Vacant</div>';
  }

  /**
 * REVISED NOTIFICATION FUNCTION
 * Renders separate, side-by-side cards for "Upcoming" and "Overdue" notifications.
 * Dynamically adjusts layout if only one card is present.
 */
function renderNotifications(data) {
  const container = document.getElementById('notifications-container');
  container.innerHTML = ''; // Clear previous notifications

  const { upcoming, overdue } = data || {};

  const hasUpcoming = upcoming && upcoming.length > 0;
  const hasOverdue = overdue && overdue.length > 0;

  // If there are no notifications at all, do nothing
  if (!hasUpcoming && !hasOverdue) {
    return;
  }

  let upcomingHtml = '';
  let overdueHtml = '';

  // Build Upcoming Reminders card (Left)
  if (hasUpcoming) {
    const listItems = upcoming.map(item => `<li class="ml-4 list-disc">${item}</li>`).join('');
    // If it's the only card, it should span the full width
    const colSpanClass = hasOverdue ? '' : 'md:col-span-2';
    upcomingHtml = `
      <div class="${colSpanClass}">
        <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-md shadow-md h-full" role="alert">
          <div class="flex">
            <div class="py-1"><svg class="fill-current h-6 w-6 text-yellow-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M2.93 17.07A10 10 0 1 1 17.07 2.93 10 10 0 0 1 2.93 17.07zM9 5v6h2V5H9zm0 8v2h2v-2H9z"/></svg></div>
            <div>
              <p class="font-bold">Upcoming Reminders</p>
              <ul class="mt-2 text-sm">${listItems}</ul>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  // Build Action Required card (Right)
  if (hasOverdue) {
    const listItems = overdue.map(item => `<li class="ml-4 list-disc">${item}</li>`).join('');
    // If it's the only card, it should span the full width
    const colSpanClass = hasUpcoming ? '' : 'md:col-span-2';
    overdueHtml = `
      <div class="${colSpanClass}">
        <div class="bg-red-100 border-l-4 border-red-500 text-red-800 p-4 rounded-md shadow-md h-full" role="alert">
          <div class="flex">
            <div class="py-1"><svg class="fill-current h-6 w-6 text-red-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M10 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16zM9 9a1 1 0 0 0 2 0V7a1 1 0 1 0-2 0v2zm0 4a1 1 0 1 0 2 0 1 1 0 0 0-2 0z"/></svg></div>
            <div>
              <p class="font-bold">Action Required (Overdue)</p>
              <ul class="mt-2 text-sm">${listItems}</ul>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  // Set the container's HTML with the cards in the correct order
  container.innerHTML = upcomingHtml + overdueHtml;
}


  function renderApprovalSection() {
    const container = document.getElementById('approval-section');
    const department = document.getElementById('department-filter-value').value;
    if (department === 'all') {
      container.innerHTML = '<p class="text-gray-500">Please select a specific department to view its approval status.</p>';
      return;
    }
    container.innerHTML = '<p>Loading approval status...</p>';
    google.script.run
      .withSuccessHandler(function(data) {
        renderApprovalBoxes(data, department);
      })
      .withFailureHandler(function(err) {
        container.innerHTML = '<p class="text-red-500">Could not retrieve approval data. Error: ' + err.message + '</p>';
      })
      .getApprovalData(department);
  }
  
  function renderApprovalBoxes(data, department) {
      const container = document.getElementById('approval-section');
      if (!data) {
          container.innerHTML = `<p class="text-red-500">Could not retrieve approval data. Please try again.</p>`;
          return;
      }
      const { approvers, approvalStatus } = data;
      if (!approvalStatus || !approvalStatus['Snapshot Date']) {
          container.innerHTML = `<p class="text-gray-500">No approval record found for ${department}. Please run a new snapshot.</p>`;
          return;
      }
      
      const roles = ['Prepared By', 'Reviewed By', 'Noted By', 'Approved By'];
      let previousRoleSigned = true;
      let buttonHasBeenShown = false;

      const boxesHtml = roles.map(role => {
          const approverEmail = approvers[role];
          const signedName = approvalStatus[role];
          const signedDate = approvalStatus[role.replace(' ', ' Date')];
          const formattedDate = signedDate ? new Date(signedDate).toLocaleDateString() : '';
          
          let contentHtml = '';
          if (signedName) {
              contentHtml = `
                  <div class="flex-grow flex items-center justify-center"><p class="text-lg font-bold text-slate-800">${signedName}</p></div>
                  <p class="text-xs text-gray-500 mt-1">${formattedDate}</p>
              `;
              previousRoleSigned = true;
          } else {
              let buttonHtml = '';
              if (previousRoleSigned && !buttonHasBeenShown && currentUserEmail === approverEmail) {
                  const escapedRole = role.replace(/'/g, "\\'");
                  const escapedDepartment = department.replace(/'/g, "\\'");
                  buttonHtml = `<button onclick="signApproval('${escapedRole}', '${escapedDepartment}')" class="mt-2 w-full bg-blue-600 text-white py-1 rounded hover:bg-blue-700 text-sm">Sign as ${role}</button>`;
                  buttonHasBeenShown = true;
              }
              contentHtml = `
                  <div class="flex-grow flex items-center justify-center"><p class="text-gray-400 text-sm">Pending Signature</p></div>
                  ${buttonHtml}
              `;
              previousRoleSigned = false;
          }
          
          return `
              <div class="border rounded-lg p-3 text-center flex flex-col">
                  <div class="text-sm font-bold text-gray-600 mb-2">${role}</div>
                  ${contentHtml}
              </div>
          `;
      }).join('');

      container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">${boxesHtml}</div>`;
  }

  function signApproval(role, department) {
    if (!confirm('Are you sure you want to sign for the ' + department + ' department as "' + role + '"? This action cannot be undone.')) {
      return;
    }
    showLoader();
    google.script.run
      .withSuccessHandler(function(responseMessage) {
        hideLoader();
        alert(responseMessage);
        renderApprovalSection();
      })
      .withFailureHandler(function(error) {
        hideLoader();
        alert('Error: ' + error.message);
      })
      .recordApproval(role, department);
  }

  // --- FILTERS AND EVENT LISTENERS (REFACTORED) ---

  // Configuration for the filter hierarchy
  const FILTERS_CONFIG = [
      { id: 'division', containerId: 'division-filter-container', valueId: 'division-filter-value', defaultLabel: 'All Divisions', parent: null },
      { id: 'group', containerId: 'group-filter-container', valueId: 'group-filter-value', defaultLabel: 'All Groups', parent: 'division' },
      { id: 'department', containerId: 'department-filter-container', valueId: 'department-filter-value', defaultLabel: 'All Departments', parent: 'group' },
      { id: 'section', containerId: 'section-filter-container', valueId: 'section-filter-value', defaultLabel: 'All Sections', parent: 'department' }
  ];

  /**
   * Populates all filter dropdowns based on the current state of parent filters.
   * This is the core logic for the dependent dropdowns. It is designed to be called
   * to refresh the entire filter set.
   */
  function populateFilters() {
      let sourceData = fullEmployeeData;
      FILTERS_CONFIG.forEach(config => {
          const currentValue = document.getElementById(config.valueId).value;
          const options = [config.defaultLabel, ...new Set(sourceData.map(e => e[config.id]).filter(String).sort())];
          
          // Re-create the dropdown with the new filtered options.
          // The callback is the key part that drives the dependent logic.
          createSearchableDropdown(config.containerId, options, null, null, (selection) => {
              const newValue = (selection === config.defaultLabel) ? 'all' : selection;
              if (document.getElementById(config.valueId).value !== newValue) {
                  document.getElementById(config.valueId).value = newValue;
                  
                  // When a filter changes, reset all its children's values to 'all'.
                  let childIdToReset = config.id;
                  let childConfig = FILTERS_CONFIG.find(f => f.parent === childIdToReset);
                  while (childConfig) {
                      document.getElementById(childConfig.valueId).value = 'all';
                      childIdToReset = childConfig.id;
                      childConfig = FILTERS_CONFIG.find(f => f.parent === childIdToReset);
                  }
                  
                  populateFilters(); // Re-populate all filters to update children based on new selections.
                  updateUI();
              }
          });
          // Set the displayed value in the dropdown to the current value.
          setSearchableDropdownValue(config.containerId, currentValue === 'all' ? config.defaultLabel : currentValue);

          // Filter the data for the next dropdown in the hierarchy.
          if (currentValue !== 'all') {
              sourceData = sourceData.filter(emp => emp[config.id] === currentValue);
          }
      });
  }
  
  /**
   * Sets up the main event listeners for the page (e.g., the reset button).
   */
  function setupPageEventListeners() {
    document.getElementById('reset-filters-btn').addEventListener('click', resetFilters);
    document.getElementById('show-inactive-checkbox').addEventListener('change', updateUI);
    
    // Add event listeners for the new refresh buttons
    document.getElementById('refresh-my-requests').addEventListener('click', refreshChangeRequestData);
    document.getElementById('refresh-approvals').addEventListener('click', refreshChangeRequestData);

}

  /**
   * Resets all filters to their default "All" state and updates the UI.
   */
  function resetFilters() {
      FILTERS_CONFIG.forEach(config => {
          document.getElementById(config.valueId).value = 'all';
      });
      populateFilters();
      updateUI();
  }
  function zoom(amount) { currentZoom = Math.max(0.2, currentZoom + amount); document.getElementById('chart_div').style.transform = 'scale(' + currentZoom + ')'; }
  function toTitleCase(str) { if (!str) return ''; return str.toLowerCase().replace(/\b\w/g, function(c) { return c.toUpperCase(); }); }

  function exportChart(format) {
    const chartContainer = document.getElementById('chart_div');

    // --- REVISED TITLE AND FILENAME LOGIC ---
    // Read values directly from the searchable dropdown input fields
    const divisionName = document.querySelector('#division-filter-container .searchable-dropdown-input').value;
    const groupName = document.querySelector('#group-filter-container .searchable-dropdown-input').value;
    const deptName = document.querySelector('#department-filter-container .searchable-dropdown-input').value;
    const sectionName = document.querySelector('#section-filter-container .searchable-dropdown-input').value;

    let titleText = "Company Organizational Chart";
    let fileNameLead = "OrgChart"; // The most specific part of the name for the file

    if (sectionName && sectionName !== 'All Sections') {
        titleText = `Section: ${sectionName}`;
        fileNameLead = sectionName;
    } else if (deptName && deptName !== 'All Departments') {
        titleText = `Department: ${deptName}`;
        fileNameLead = deptName;
    } else if (groupName && groupName !== 'All Groups') {
        titleText = `Group: ${groupName}`;
        fileNameLead = groupName;
    } else if (divisionName && divisionName !== 'All Divisions') {
        titleText = `Division: ${divisionName}`;
        fileNameLead = divisionName;
    }
    
    const fileName = `${fileNameLead.replace(/ /g, '_')}_${new Date().toISOString().slice(0,10)}.${format}`;

    showSavingOverlay();
    const savingText = document.getElementById('saving-text');
    savingText.textContent = 'Preparing Export...';

    // --- CLONING LOGIC MODIFIED FOR TITLE ---
    const cloneContainer = document.createElement('div');
    cloneContainer.style.position = 'absolute';
    cloneContainer.style.left = '-9999px';
    cloneContainer.style.top = '0px';
    cloneContainer.style.zIndex = '-1';
    cloneContainer.style.padding = '20px';
    cloneContainer.style.backgroundColor = 'white';

    const captureWrapper = document.createElement('div');

    const titleElement = document.createElement('h1');
    titleElement.textContent = titleText;
    titleElement.style.fontSize = '28px';
    titleElement.style.fontWeight = 'bold';
    titleElement.style.textAlign = 'center';
    titleElement.style.marginBottom = '24px';
    titleElement.style.fontFamily = 'Roboto, sans-serif';

    const chartClone = chartContainer.cloneNode(true);
    chartClone.style.transform = '';
    
    captureWrapper.appendChild(titleElement);
    captureWrapper.appendChild(chartClone);
    
    cloneContainer.appendChild(captureWrapper);
    document.body.appendChild(cloneContainer);
    
    setTimeout(() => {
        html2canvas(captureWrapper, {
            useCORS: true,
            scale: 2,
        }).then(canvas => {
            if (format === 'png') {
                const link = document.createElement('a');
                link.download = fileName;
                link.href = canvas.toDataURL('image/png');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const imgData = canvas.toDataURL('image/png');
                const canvasWidth = canvas.width;
                const canvasHeight = canvas.height;
                const orientation = canvasWidth > canvasHeight ? 'l' : 'p';
                const pdf = new jsPDF(orientation, 'px', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const margin = 40;
                const availableWidth = pdfWidth - (margin * 2);
                const availableHeight = pdfHeight - (margin * 2);
                const widthScale = availableWidth / canvasWidth;
                const heightScale = availableHeight / canvasHeight;
                const scale = Math.min(widthScale, heightScale);
                const finalImgWidth = canvasWidth * scale;
                const finalImgHeight = canvasHeight * scale;
                const x = (pdfWidth - finalImgWidth) / 2;
                const y = (pdfHeight - finalImgHeight) / 2;
                pdf.addImage(imgData, 'PNG', x, y, finalImgWidth, finalImgHeight);
                pdf.save(fileName);
            }
        }).catch(err => {
            console.error("Export failed:", err);
            alert("An error occurred during the export. Please check the console for details.");
        }).finally(() => {
            document.body.removeChild(cloneContainer);
            hideSavingOverlay();
            savingText.textContent = 'Saving...';
        });
    }, 250);
  }

  // --- MODAL & DATA MANAGEMENT FUNCTIONS ---

  // PASTE THIS NEW FUNCTION
function handleEmployeeIdBlur(event) {
  const employeeId = event.target.value.trim();
  // Only run if the employeeId is not empty and a date of birth is not already filled in
  if (employeeId && !document.getElementById('dateofbirth').value) {
    // Show a subtle indicator that something is happening
    document.getElementById('dateofbirth').style.backgroundColor = '#f3f4f6'; // Light gray
    google.script.run
      .withSuccessHandler(function(dob) {
        if (dob) {
          document.getElementById('dateofbirth').value = dob;
        }
        // Reset background color after the check is complete
        document.getElementById('dateofbirth').style.backgroundColor = ''; 
      })
      .getDateOfBirth(employeeId);
  }
}

  function openModal(mode, nodeId) {
    const form = document.getElementById('employee-form');
    form.reset();
    document.getElementById('form-mode').value = mode;

    document.getElementById('employeename').addEventListener('input', handleEmployeeNameInput);
    document.getElementById('startdateinposition').addEventListener('input', syncNewHireDate);
    
    document.getElementById('effective-date-wrapper').style.display = 'none';
    document.getElementById('effectivedate').required = false;
    document.getElementById('start-date-wrapper').style.display = 'none';
    document.getElementById('startdateinposition').required = false;
    document.getElementById('contract-end-date-wrapper').style.display = 'none';
    document.getElementById('contractenddate').required = false;
    document.getElementById('datehired').required = false;

    document.getElementById('employeeid').addEventListener('blur', handleEmployeeIdBlur); // <-- ADD THIS LINE

    let statusOptions = [...(dropdownListData.status || [])];
    if (!statusOptions.includes('VACANT')) statusOptions.push('VACANT');
    if (!statusOptions.includes('PROMOTION')) statusOptions.push('PROMOTION');
    if (!statusOptions.includes('INTERNAL TRANSFER')) statusOptions.push('INTERNAL TRANSFER');
    statusOptions.sort();

    createSearchableDropdown('jobtitle-dropdown-container', dropdownListData.jobtitle || [], null, null, (sel) => { document.getElementById('jobtitle').value = sel; });
    createSearchableDropdown('level-dropdown-container', dropdownListData.level || [], null, null, (sel) => { document.getElementById('level').value = sel; });
    createSearchableDropdown('payrolltype-dropdown-container', dropdownListData.payrolltype || [], null, null, (sel) => { document.getElementById('payrolltype').value = sel; });
    createSearchableDropdown('joblevel-dropdown-container', dropdownListData.joblevel || [], null, null, (sel) => { document.getElementById('joblevel').value = sel; });
    createSearchableDropdown('contracttype-dropdown-container', dropdownListData.contracttype || [], null, null, (sel) => { 
        document.getElementById('contracttype').value = sel; 
        const endDateWrapper = document.getElementById('contract-end-date-wrapper');
        const endDateInput = document.getElementById('contractenddate');
        if (sel && sel.toUpperCase() === 'JPRO') {
            endDateWrapper.style.display = 'block';
            endDateInput.required = true;
        } else {
            endDateWrapper.style.display = 'none';
            endDateInput.required = false;
            endDateInput.value = '';
        }
    });
    createSearchableDropdown('competency-dropdown-container', dropdownListData.competency || [], null, null, (sel) => { document.getElementById('competency').value = sel; });
    createSearchableDropdown('status-dropdown-container', statusOptions, null, null, (sel) => { 
      document.getElementById('status').value = sel; 
      const selUpper = sel ? sel.toUpperCase() : '';
      
      const effectiveDateWrapper = document.getElementById('effective-date-wrapper');
      const effectiveDateLabel = document.getElementById('effective-date-label');
      const effectiveDateInput = document.getElementById('effectivedate');
      const showResignedDate = selUpper === 'RESIGNED';
      const showVacantDate = selUpper === 'VACANT' && document.getElementById('form-mode').value === 'edit';
      const reasonWrapper = document.getElementById('reasonforleaving-wrapper');
      const reasonInput = document.getElementById('reasonforleaving');

      if (showResignedDate) {
        effectiveDateLabel.innerHTML = 'Effective Resignation Date <span class="text-red-500">*</span>';
        effectiveDateWrapper.style.display = 'block';
        effectiveDateInput.required = true;
        reasonWrapper.style.display = 'block';
        reasonInput.required = true;
      } else if (showVacantDate) {
        effectiveDateLabel.innerHTML = 'Effective Date Position Became Vacant <span class="text-red-500">*</span>';
        effectiveDateWrapper.style.display = 'block';
        effectiveDateInput.required = true;
        reasonWrapper.style.display = 'none';
        reasonInput.required = false;
      } else {
        effectiveDateWrapper.style.display = 'none';
        effectiveDateInput.required = false;
        reasonWrapper.style.display = 'none';
        reasonInput.required = false;
      }

      if (selUpper === 'VACANT') {
        document.getElementById('employeeid').value = '';
        document.getElementById('employeename').value = '';
        document.getElementById('datehired').value = '';
        document.getElementById('dateofbirth').value = '';
        document.getElementById('contractenddate').value = '';
        setSearchableDropdownValue('gender-dropdown-container', '');
      }

      const startDateWrapper = document.getElementById('start-date-wrapper');
      const startDateInput = document.getElementById('startdateinposition');
      const statusesRequiringStartDate = ['NEW HIRE', 'PROBATIONARY', 'REGULAR', 'PROMOTION', 'INTERNAL TRANSFER', 'LATERAL TRANSFER', 'FILLED VACANCY'];
      const showStartDateField = statusesRequiringStartDate.includes(selUpper);
      startDateWrapper.style.display = showStartDateField ? 'block' : 'none';
      startDateInput.required = showStartDateField;

      if (selUpper === 'REGULAR') {
          const mode = document.getElementById('form-mode').value;
          if (mode === 'edit') {
              const positionId = document.getElementById('positionid').value;
              google.script.run
                  .withSuccessHandler(function(startDate) {
                      if (startDate) {
                          startDateInput.value = startDate;
                      } else {
                          const dateHired = document.getElementById('datehired').value;
                          if(dateHired) startDateInput.value = dateHired;
                      }
                  })
                  .getStartDateForLastMovement(positionId);
          } else {
               const dateHired = document.getElementById('datehired').value;
               if(dateHired) startDateInput.value = dateHired;
          }
      }
      
      const dateHiredInput = document.getElementById('datehired');
      const statusesRequiringDateHired = ['REGULAR', 'PROBATIONARY', 'PROMOTION', 'INTERNAL TRANSFER', 'LATERAL TRANSFER', 'RESIGNED', 'NEW HIRE'];
      if (statusesRequiringDateHired.includes(selUpper)) {
          dateHiredInput.required = true;
          const employeeId = document.getElementById('employeeid').value;
          if (mode === 'edit' && employeeId && !dateHiredInput.value) {
              google.script.run
                  .withSuccessHandler(function(hiredDate) {
                      if (hiredDate) dateHiredInput.value = hiredDate;
                  })
                  .getDateHired(employeeId);
          }
      } else {
          dateHiredInput.required = false;
      }
    });

    createSearchableDropdown('gender-dropdown-container', ['Male', 'Female'], null, null, (sel) => { document.getElementById('gender').value = sel; });
    createSearchableDropdown('reasonforleaving-dropdown-container', dropdownListData.reasonforleaving || [], null, null, (sel) => { document.getElementById('reasonforleaving').value = sel; });
    createSearchableDropdown('positionstatus-dropdown-container', ['Active', 'Inactive'], null, null, (sel) => { document.getElementById('positionstatus').value = sel; });
    createSearchableDropdown('reportingto-dropdown-container', dropdownListData.managers || [], 'name', 'id', handleManagerSelection);
    createSearchableDropdown('division-dropdown-container', dropdownListData.divisions || [], null, null, (sel) => updateDependentDropdowns('division', sel));
    createSearchableDropdown('group-dropdown-container', [], null, null, (sel) => updateDependentDropdowns('group', sel));
    createSearchableDropdown('department-dropdown-container', [], null, null, (sel) => updateDependentDropdowns('department', sel));
    createSearchableDropdown('section-dropdown-container', [], null, null, (sel) => { document.getElementById('section').value = sel; handleIdGeneration(); });

    if (mode === 'add') {
      document.getElementById('modal-title').textContent = 'Add New Position';
      document.getElementById('positionid').value = 'Select Division/Section...';
      document.getElementById('original-status').value = '';
    } else {
      document.getElementById('modal-title').textContent = 'Edit Position / Employee';
      const employee = employeeMap.get(nodeId);
      if (!employee) {
        alert('Could not find employee data.');
        return;
      }
      document.getElementById('original-status').value = employee.status || '';
      document.getElementById('positionid').value = employee.positionId || '';
      document.getElementById('employeeid').value = employee.employeeId || '';
      document.getElementById('employeename').value = employee.employeeName || '';
      document.getElementById('datehired').value = employee.dateHired || '';
      document.getElementById('dateofbirth').value = employee.dateOfBirth || '';
      document.getElementById('contractenddate').value = employee.contractEndDate || '';
      setSearchableDropdownValue('reportingto-dropdown-container', employee.managerName || '');
      document.getElementById('reportingtoid').value = employee.managerEmployeeId || '';
      document.getElementById('reportingtoid_display').value = employee.managerEmployeeId || '';
      document.getElementById('reportingto').value = employee.managerName || '';
      setSearchableDropdownValue('jobtitle-dropdown-container', employee.jobTitle || '');
      setSearchableDropdownValue('level-dropdown-container', employee.level || '');
      setSearchableDropdownValue('payrolltype-dropdown-container', employee.payrollType || '');
      setSearchableDropdownValue('joblevel-dropdown-container', employee.jobLevel || '');
      setSearchableDropdownValue('contracttype-dropdown-container', employee.contractType || '');
      const contractTypeInput = document.querySelector('#contracttype-dropdown-container .searchable-dropdown-input');
      if (contractTypeInput) setTimeout(() => contractTypeInput.dispatchEvent(new Event('change')), 0);
      setSearchableDropdownValue('competency-dropdown-container', employee.competency || '');
      setSearchableDropdownValue('status-dropdown-container', employee.status || '');
      setSearchableDropdownValue('gender-dropdown-container', employee.gender || '');
      setSearchableDropdownValue('positionstatus-dropdown-container', employee.positionStatus || '');
      setSearchableDropdownValue('division-dropdown-container', employee.division || '', true);
      updateDependentDropdowns('division', employee.division, employee);
    }
    document.getElementById('employee-modal').style.display = 'flex';
}
  
  function syncNewHireDate(event) {
    const status = document.getElementById('status').value;
    if (status && status.toUpperCase() === 'NEW HIRE') {
        document.getElementById('datehired').value = event.target.value;
    }
  }

  function closeModal() {
    document.getElementById('employee-modal').style.display = 'none';
    document.getElementById('employeename').removeEventListener('input', handleEmployeeNameInput);
    document.getElementById('startdateinposition').removeEventListener('input', syncNewHireDate);
    document.getElementById('employeeid').removeEventListener('blur', handleEmployeeIdBlur); // <-- ADD THIS LINE
  }
  
  function openHistoryModal(positionId) {
    const modal = document.getElementById('history-modal');
    const title = document.getElementById('history-modal-title');
    const tableBody = document.getElementById('history-table-body');
    
    title.textContent = `Incumbency History for ${positionId}`;
    tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4">Loading history...</td></tr>`;
    modal.style.display = 'flex';
    
    google.script.run
      .withSuccessHandler(populateHistoryModal)
      .withFailureHandler(err => {
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-red-500">Error loading history: ${err.message}</td></tr>`;
      })
      .getDetailedIncumbencyHistory(positionId);
  }

  function populateHistoryModal(historyData) {
    const tableBody = document.getElementById('history-table-body');
    tableBody.innerHTML = '';
    
    if (!historyData || historyData.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-gray-500">No incumbency history found for this position.</td></tr>`;
      return;
    }

    historyData.forEach(record => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${record.name}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.startDate}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.endDate}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.tenure}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400 italic">${record.employeeHireDate}</td>
      `;
      tableBody.appendChild(row);
    });
  }


  function closeHistoryModal() {
    document.getElementById('history-modal').style.display = 'none';
  }

  function openJdModal(positionId, employeeId, jobTitle) {
    const modal = document.getElementById('jd-modal');
    const title = document.getElementById('jd-modal-title');
    const contentArea = document.getElementById('jd-content-area');

    title.textContent = `Job Description for ${jobTitle} (${positionId})`;

    // HTML for the two buttons
    let buttonsHtml = `
        <p class="mb-4">Please select which version of the job description you would like to view:</p>
        <div class="flex justify-center gap-4">
            <button onclick="showJdFile('${positionId}', '${employeeId}', '${jobTitle}', 'general')" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                Job Description
            </button>
            <button onclick="showJdFile('${positionId}', '${employeeId}', '${jobTitle}', 'incumbent')" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700" ${!employeeId ? 'disabled' : ''} title="${!employeeId ? 'This position is vacant' : ''}">
                JD with Incumbent Signature
            </button>
        </div>
    `;

    contentArea.innerHTML = buttonsHtml;
    modal.style.display = 'flex';
}

function showJdFile(positionId, employeeId, jobTitle, type) {
    const contentArea = document.getElementById('jd-content-area');
    contentArea.innerHTML = '<div class="flex justify-center items-center h-full"><div id="loader"></div><p class="ml-4">Finding file in Google Drive...</p></div>';

    google.script.run
        .withSuccessHandler(function(url) {
            if (url && url.startsWith('http')) {
                // Embed the PDF using an iframe for better compatibility
                contentArea.innerHTML = `<iframe src="${url}" style="width:100%; height:60vh; border:none;"></iframe>`;
            } else if (url && url.startsWith('Error:')) {
                 contentArea.innerHTML = `<p class="text-red-500 text-center font-bold">An error occurred: ${url.substring(7)}</p>`;
            }
            else {
                contentArea.innerHTML = '<p class="text-center text-gray-600 font-bold">Sorry, the requested job description file could not be found in Google Drive.</p>';
            }
        })
        .withFailureHandler(function(err) {
            contentArea.innerHTML = `<p class="text-red-500 text-center font-bold">Failed to retrieve file URL. Error: ${err.message}</p>`;
        })
        .getJdFileUrl(positionId, employeeId, jobTitle, type);
}


function closeJdModal() {
    const modal = document.getElementById('jd-modal');
    const contentArea = document.getElementById('jd-content-area');
    contentArea.innerHTML = ''; // Clear the content (buttons or PDF)
    modal.style.display = 'none';
}

function showSavingOverlay(message) {
  const savingText = document.getElementById('saving-text');
  savingText.textContent = message || 'Saving...'; // Use the message or default to "Saving..."
  document.getElementById('saving-overlay').style.display = 'flex';
}

  function hideSavingOverlay() {
    document.getElementById('saving-overlay').style.display = 'none';
  }

  function saveEmployee() {
    const data = {
      formmode: document.getElementById('form-mode').value,
      positionid: document.getElementById('positionid').value,
      employeeid: document.getElementById('employeeid').value,
      employeename: document.getElementById('employeename').value,
      reportingtoid: document.getElementById('reportingtoid').value,
      reportingto: document.getElementById('reportingto').value,
      division: document.getElementById('division').value,
      group: document.getElementById('group').value,
      department: document.getElementById('department').value,
      section: document.getElementById('section').value,
      jobtitle: document.getElementById('jobtitle').value,
      level: document.getElementById('level').value,
      payrolltype: document.getElementById('payrolltype').value,
      joblevel: document.getElementById('joblevel').value,
      contracttype: document.getElementById('contracttype').value,
      contractenddate: document.getElementById('contractenddate').value,
      competency: document.getElementById('competency').value,
      status: document.getElementById('status').value,
      effectivedate: document.getElementById('effectivedate').value,
      gender: document.getElementById('gender').value,
      positionstatus: document.getElementById('positionstatus').value,
      datehired: document.getElementById('datehired').value,
      dateofbirth: document.getElementById('dateofbirth').value,
      startdateinposition: document.getElementById('startdateinposition').value,
      reasonforleaving: document.getElementById('reasonforleaving').value
    };
    const originalStatus = document.getElementById('original-status').value;

    if (!data.positionid || data.positionid.startsWith('Select') || data.positionid.startsWith('ERROR')) {
      alert('Please ensure a valid Position ID is generated.');
      return;
    }
    if (!data.jobtitle || !data.division || !data.department || !data.section) {
      alert('Please fill in all required fields (*).');
      return;
    }

    if (!data.reportingtoid) {
        const rootNodes = fullEmployeeData.filter(emp => !emp.managerId && emp.employeeId);
        const isEditingTheSingleRootNode = (data.formmode === 'edit' && rootNodes.length === 1 && rootNodes[0].employeeId === data.employeeid);
        const isAddingFirstNode = (data.formmode === 'add' && fullEmployeeData.length === 0);
        if (!isEditingTheSingleRootNode && !isAddingFirstNode && data.status.toUpperCase() !== 'VACANT') {
            alert('The "Reporting To" field is required.');
            return;
        }
    }
    
    const mode = data.formmode;
    if (mode === 'edit' && data.employeeid && data.status.toUpperCase() === 'VACANT' && originalStatus.toUpperCase() !== 'RESIGNED') {
      alert('Incorrect Workflow for Resignation!\n\nTo ensure accurate incumbency history, you must perform this action in two steps:\n\n1. First, change this employee\'s status to "Resigned" and save.\n2. After saving, edit the position again to make it "VACANT".\n\nPlease change the status to "Resigned" for now.');
      return;
    }

    if ((data.status.toUpperCase() === 'VACANT' || data.status.toUpperCase() === 'RESIGNED') && mode === 'edit' && !data.effectivedate) {
      alert('Please provide the Effective Date for this status change.');
      return;
    }
    
    if (data.status.toUpperCase() === 'RESIGNED' && !data.reasonforleaving) {
        alert('Please select a "Reason for Leaving" before saving.');
        return;
    }
    
    if (data.contracttype && data.contracttype.toUpperCase() === 'JPRO' && !data.contractenddate) {
        alert('Please provide the Contract End Date for JPRO employees.');
        return;
    }

    const statusUpper = data.status ? data.status.toUpperCase() : '';
    const statusesRequiringStartDate = ['NEW HIRE', 'PROBATIONARY', 'REGULAR', 'PROMOTION', 'INTERNAL TRANSFER', 'LATERAL TRANSFER', 'FILLED VACANCY'];
    if (statusesRequiringStartDate.includes(statusUpper) && !data.startdateinposition) {
      alert('Please provide the Start Date in Position for this status.');
      return;
    }

    showSavingOverlay();

    google.script.run
      .withSuccessHandler(response => {
        document.getElementById('loader').style.display = 'none';
        document.getElementById('saving-text').textContent = 'Success!';
        
        setTimeout(() => {
          closeModal();
          hideSavingOverlay();
          fetchData();
        }, 1000);
      })
      .withFailureHandler(error => {
        hideSavingOverlay();
        alert('Error: ' + error.message);
      })
      .saveEmployeeData(data, mode);
}

  function deactivateEmployee(positionId) {
    if (!confirm(`Are you sure you want to deactivate position ${positionId}? This will mark it as 'Inactive' and remove it from the active chart.`)) {
      return;
    }
    showLoader();
    google.script.run
      .withSuccessHandler(response => {
        fetchData();
      })
      .withFailureHandler(error => {
        hideLoader();
        alert('Error: ' + error.message);
      })
      .deactivatePosition(positionId);
  }

// ADD THIS NEW FUNCTION
function reactivateEmployee(positionId) {
  if (!confirm(`Are you sure you want to reactivate position ${positionId}? This will mark it as 'Active' and it will reappear in the default chart view.`)) {
    return;
  }
  showLoader();
  google.script.run
    .withSuccessHandler(response => {
      fetchData(); // Refresh all data to show the change
    })
    .withFailureHandler(error => {
      hideLoader();
      alert('Error: ' + error.message);
    })
    .reactivatePosition(positionId);
}

  function updateDependentDropdowns(level, selectedValue, employeeToLoad) {
    document.getElementById(level).value = selectedValue;

    if (level === 'division') {
      const groups = [...new Set(fullEmployeeData.filter(e => e.division === selectedValue).map(e => e.group).filter(String))].sort();
      createSearchableDropdown('group-dropdown-container', groups, null, null, (sel) => updateDependentDropdowns('group', sel));
      createSearchableDropdown('department-dropdown-container', [], null, null, (sel) => updateDependentDropdowns('department', sel));
      createSearchableDropdown('section-dropdown-container', [], null, null, (sel) => { document.getElementById('section').value = sel; handleIdGeneration(); });
      if(employeeToLoad) {
        setSearchableDropdownValue('group-dropdown-container', employeeToLoad.group || '', true);
        updateDependentDropdowns('group', employeeToLoad.group, employeeToLoad);
      }
    } else if (level === 'group') {
      const depts = [...new Set(fullEmployeeData.filter(e => e.group === selectedValue).map(e => e.department).filter(String))].sort();
      createSearchableDropdown('department-dropdown-container', depts, null, null, (sel) => updateDependentDropdowns('department', sel));
      createSearchableDropdown('section-dropdown-container', [], null, null, (sel) => { document.getElementById('section').value = sel; handleIdGeneration(); });
      if(employeeToLoad) {
        setSearchableDropdownValue('department-dropdown-container', employeeToLoad.department || '', true);
        updateDependentDropdowns('department', employeeToLoad.department, employeeToLoad);
      }
    } else if (level === 'department') {
      const sects = [...new Set(fullEmployeeData.filter(e => e.department === selectedValue).map(e => e.section).filter(String))].sort();
      createSearchableDropdown('section-dropdown-container', sects, null, null, (sel) => { document.getElementById('section').value = sel; handleIdGeneration(); });
      if(employeeToLoad) {
        setSearchableDropdownValue('section-dropdown-container', employeeToLoad.section || '', true);
        document.getElementById('section').value = employeeToLoad.section || '';
      }
    }
    handleIdGeneration();
  }

  function handleManagerSelection(selectedItem) {
    document.getElementById('reportingtoid').value = selectedItem || '';
    document.getElementById('reportingtoid_display').value = selectedItem || '';
    const managerNameInput = document.querySelector('#reportingto-dropdown-container input');
    document.getElementById('reportingto').value = managerNameInput.value;
  }

  function handleEmployeeNameInput(event) {
    if (event.target.value.trim().toUpperCase() === 'VACANT') {
      const mode = document.getElementById('form-mode').value;
      setSearchableDropdownValue('status-dropdown-container', 'VACANT');
      document.getElementById('status').value = 'VACANT';
      
      const showEffectiveDateField = (mode === 'edit');
      document.getElementById('effective-date-wrapper').style.display = showEffectiveDateField ? 'block' : 'none';
      document.getElementById('effectivedate').required = showEffectiveDateField;
    }
  }

  function handleIdGeneration() {
    const mode = document.getElementById('form-mode').value;
    if (mode !== 'add') return;

    const division = document.getElementById('division').value;
    const section = document.getElementById('section').value;

    if (division && section) {
      document.getElementById('positionid').value = 'Generating...';
      google.script.run
      .withSuccessHandler(newId => {
        document.getElementById('positionid').value = newId;
      })
      .generateNewPositionId(division, section);
    }
  }

  /**
 * Creates a searchable dropdown component.
 * @param {string} containerId - The ID of the element to contain the dropdown.
 * @param {Array<string|Object>} items - The list of items to display.
 * @param {string|null} displayKey - If items are objects, the key for the display text.
 * @param {string|null} valueKey - If items are objects, the key for the data value.
 * @param {function} onSelectCallback - The function to call when an item is selected.
 */
function createSearchableDropdown(containerId, items, displayKey, valueKey, onSelectCallback) {
  const container = document.getElementById(containerId);
  const hiddenInputName = containerId.replace('-dropdown-container', '');
  const hiddenInput = document.getElementById(hiddenInputName);

  container.innerHTML = '';
  const input = document.createElement('input');
  input.type = 'text';
  input.className = 'searchable-dropdown-input';
  input.placeholder = 'Type to search...';

  input.addEventListener('change', () => {
    if (onSelectCallback) {
      const selectedItem = items.find(item => (displayKey ? item[displayKey] : item) === input.value);
      const dataValue = selectedItem ? (valueKey ? selectedItem[valueKey] : selectedItem) : input.value;
      onSelectCallback(dataValue);
    }
  });

  input.onblur = () => {
    setTimeout(() => {
      const listIsVisible = list.style.display === 'block';
      if (listIsVisible) return;
      if (input.value === '') {
        if (hiddenInput) hiddenInput.value = '';
        if (containerId === 'reportingto-dropdown-container') {
          document.getElementById('reportingtoid').value = '';
          document.getElementById('reportingtoid_display').value = '';
        }
      }
    }, 200);
  };

  const list = document.createElement('div');
  list.className = 'searchable-dropdown-list';

  items.forEach(item => {
    const option = document.createElement('div');
    const displayValue = displayKey ? item[displayKey] : item;
    const dataValue = valueKey ? item[valueKey] : item;

    option.textContent = displayValue;
    option.dataset.value = dataValue;
    
    // --- REVISION START ---
    // Switched from 'onclick' to 'onmousedown'.
    // This resolves a race condition where the input's 'blur' and 'change' events would fire
    // with the partial, typed text (e.g., "CSD") before the 'click' event could register
    // the selection of the full text (e.g., "04 CSD"). 'onmousedown' fires before 'blur',
    // ensuring the correct value is set and propagated first.
    option.onmousedown = () => {
      input.value = displayValue;
      list.style.display = 'none';
      if (hiddenInput) hiddenInput.value = dataValue;
      if (onSelectCallback) onSelectCallback(dataValue);
    };
    // --- REVISION END ---

    list.appendChild(option);
  });

  container.append(input, list);

  input.onkeyup = () => {
    const filter = input.value.toUpperCase();
    const options = list.getElementsByTagName('div');
    // Ensure the dropdown list is visible when the user is typing.
    list.style.display = 'block';
    for (let i = 0; i < options.length; i++) {
      options[i].style.display = options[i].textContent.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
    }
  };

  input.onfocus = () => list.style.display = 'block';
  document.addEventListener('click', (e) => {
    if (!container.contains(e.target)) list.style.display = 'none';
  });
}

  function setSearchableDropdownValue(containerId, value) {
    const container = document.getElementById(containerId);
    const input = container.querySelector('input.searchable-dropdown-input');
    const hiddenInput = document.getElementById(containerId.replace('-dropdown-container', ''));
    if (input) input.value = value || '';
    if (hiddenInput) hiddenInput.value = value || '';
  }

function initializeMasterlist() {
        if (masterlistFiltersPopulated) return;

        MASTERLIST_FILTERS_CONFIG.forEach(config => {
            masterlistFilterState[config.id] = 'All';
        });
        const nonDependentFilters = ['Job Level', 'Gender', 'Job Title'];
        nonDependentFilters.forEach(filterName => {
            masterlistFilterState[filterName.replace(/\s/g, '')] = 'All';
        });

        populateMasterlistFilters();

        document.getElementById('masterlist-reset-filters-btn').addEventListener('click', () => {
            Object.keys(masterlistFilterState).forEach(key => masterlistFilterState[key] = 'All');
            populateMasterlistFilters();
            drawMasterlistTable(true); // Reset should immediately redraw
        });

        // --- NEW: Event listener for the Apply button ---
        document.getElementById('masterlist-apply-filters-btn').addEventListener('click', () => {
            drawMasterlistTable(true);
        });
        
        masterlistFiltersPopulated = true;
        drawMasterlistTable();
    }

    function populateMasterlistFilters() {
        let sourceData = fullEmployeeData;

        MASTERLIST_FILTERS_CONFIG.forEach(config => {
            const currentValue = masterlistFilterState[config.id] || 'All';
            const options = ['All', ...new Set(sourceData.map(e => e[config.id.toLowerCase()]).filter(String).sort())];
            
            createSearchableDropdown(config.containerId, options, null, null, (selection) => {
                const newValue = (selection === 'All' || !selection) ? 'All' : selection;
                
                if (masterlistFilterState[config.id] !== newValue) {
                    masterlistFilterState[config.id] = newValue;
                    
                    let childIdToReset = config.id;
                    let childConfig = MASTERLIST_FILTERS_CONFIG.find(f => f.parent === childIdToReset);
                    while (childConfig) {
                        masterlistFilterState[childConfig.id] = 'All';
                        childIdToReset = childConfig.id;
                        childConfig = MASTERLIST_FILTERS_CONFIG.find(f => f.parent === childIdToReset);
                    }
                    
                    // --- REVISED: We only repopulate the dropdowns, we DON'T redraw the table ---
                    populateMasterlistFilters();
                }
            });

            setSearchableDropdownValue(config.containerId, currentValue);

            if (currentValue !== 'All') {
                sourceData = sourceData.filter(emp => emp[config.id.toLowerCase()] === currentValue);
            }
        });

        const nonDependentFilters = ['Job Level', 'Gender', 'Job Title'];
        nonDependentFilters.forEach(filterName => {
            const listKey = filterName.toLowerCase().replace(/\s/g, '');
            const idSafeFilterName = filterName.replace(/\s/g, '');
            const options = ['All', ...(dropdownListData[listKey] || [])];

            createSearchableDropdown(`masterlist-${idSafeFilterName}-filter-container`, options, null, null, (selection) => {
                const newValue = (selection === 'All' || !selection) ? 'All' : selection;
                masterlistFilterState[idSafeFilterName] = newValue;
                // --- REVISED: No automatic redraw here either ---
            });
            setSearchableDropdownValue(`masterlist-${idSafeFilterName}-filter-container`, masterlistFilterState[idSafeFilterName] || 'All');
        });
    }

    function drawMasterlistTable(forceRefresh = false) {
        if (masterlistDataLoaded && !forceRefresh) return;
        showSavingOverlay('Loading Masterlist...');

        // This function now reads from the state object, not the DOM
        const filters = {
            'Division': masterlistFilterState['Division'],
            'Group': masterlistFilterState['Group'],
            'Department': masterlistFilterState['Department'],
            'Section': masterlistFilterState['Section'],
            'Job Level': masterlistFilterState['JobLevel'],
            'Gender': masterlistFilterState['Gender'],
            'Job Title': masterlistFilterState['JobTitle']
        };

        google.script.run
            .withSuccessHandler(data => {
                if (!data || !data.headers) {
                    hideSavingOverlay();
                    alert('An unexpected error occurred. Please check logs.');
                    return;
                }
                if (masterlistDataTable) {
                    masterlistDataTable.destroy();
                }
                const table = $('#masterlist-table');
                table.empty();

                masterlistDataTable = table.DataTable({
                    data: data.rows,
                    columns: data.headers.map(h => ({ title: h })),
                    responsive: false,
                    scrollX: true,
                    dom: 'Bfrtip',
                    buttons: [
                        'colvis',
                        {
                            extend: 'pdfHtml5',
                            text: 'Export as PDF',
                            orientation: 'landscape',
                            title: 'Employee Masterlist Export',
                            exportOptions: {
                                columns: ':visible'
                            }
                        },
                        {
                            text: 'Export as Sheet',
                            action: function ( e, dt, node, config ) {
                                exportFilteredSheet();
                            }
                        }
                    ],
                    language: {
                        emptyTable: "No data available in table",
                        zeroRecords: "No matching records found"
                    }
                });
                
                masterlistDataLoaded = true;
                hideSavingOverlay();
            })
            .withFailureHandler(err => {
                hideSavingOverlay();
                alert('Error loading masterlist: ' + err.message);
            })
            .getMasterlistData(filters);
    }

function exportFilteredSheet() {
    if (!masterlistDataTable) {
        alert("The masterlist table has not been loaded yet.");
        return;
    }
    showSavingOverlay('Generating Sheet...');

    const filters = {
        'Division': document.querySelector('#masterlist-Division-filter-container .searchable-dropdown-input').value,
        'Group': document.querySelector('#masterlist-Group-filter-container .searchable-dropdown-input').value,
        'Department': document.querySelector('#masterlist-Department-filter-container .searchable-dropdown-input').value,
        'Section': document.querySelector('#masterlist-Section-filter-container .searchable-dropdown-input').value,
        'Job Level': document.querySelector('#masterlist-JobLevel-filter-container .searchable-dropdown-input').value,
        'Gender': document.querySelector('#masterlist-Gender-filter-container .searchable-dropdown-input').value,
        'Job Title': document.querySelector('#masterlist-JobTitle-filter-container .searchable-dropdown-input').value
    };

    const visibleColumns = [];
    masterlistDataTable.columns(':visible').every(function() {
        visibleColumns.push( $(this.header()).text() );
    });

    google.script.run
        .withSuccessHandler(url => {
            hideSavingOverlay();
            window.open(url, '_blank');
        })
        .withFailureHandler(err => {
            hideSavingOverlay();
            alert('Error generating sheet: ' + err.message);
        })
        .generateFilteredMasterlist({filters: filters, visibleColumns: visibleColumns});
}

// --- START: NEW PREDICTIVE INSIGHTS SCRIPT ---

function drawPredictiveInsights() {
  predictiveDataLoaded = true;
  document.getElementById('attrition-risk-loader').style.display = 'flex';
  document.getElementById('attrition-risk-content').style.display = 'none';

  google.script.run
    .withSuccessHandler(function(data) {
      const tableBody = document.getElementById('attrition-risk-table-body');
      tableBody.innerHTML = ''; // Clear previous results

      if (data.error) {
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-red-500">Error: ${data.error}</td></tr>`;
      } else if (data.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-gray-500">No significant attrition risks identified based on current data.</td></tr>`;
      } else {
        data.forEach(employee => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${employee.name}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${employee.position}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${employee.department}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-red-600">${employee.score}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${employee.factors}</td>
          `;
          tableBody.appendChild(row);
        });
      }

      document.getElementById('attrition-risk-loader').style.display = 'none';
      document.getElementById('attrition-risk-content').style.display = 'block';
    })
    .withFailureHandler(function(err) {
      const tableBody = document.getElementById('attrition-risk-table-body');
      tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-red-500">Failed to load predictive data. Error: ${err.message}</td></tr>`;
      document.getElementById('attrition-risk-loader').style.display = 'none';
      document.getElementById('attrition-risk-content').style.display = 'block';
    })
    .getAttritionRiskData();
}

// --- END: NEW PREDICTIVE INSIGHTS SCRIPT ---

// --- START: NEW PREDICTIVE INSIGHTS SCRIPT ---

function drawPredictiveInsights() {
  predictiveDataLoaded = true;
  document.getElementById('attrition-risk-loader').style.display = 'flex';
  document.getElementById('attrition-risk-content').style.display = 'none';

  google.script.run
    .withSuccessHandler(function(data) {
      const tableBody = document.getElementById('attrition-risk-table-body');
      tableBody.innerHTML = ''; 

      if (data.error) {
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-red-500">Error: ${data.error}</td></tr>`;
      } else if (data.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-gray-500">No significant attrition risks identified based on current data.</td></tr>`;
      } else {
        data.forEach(employee => {
          const row = document.createElement('tr');
          let riskLevelHtml = '';
          if (employee.score >= 5) {
              riskLevelHtml = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">High</span>';
          } else if (employee.score >= 3) {
              riskLevelHtml = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Medium</span>';
          } else {
              riskLevelHtml = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Low</span>';
          }

          row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${employee.name}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${employee.position}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${employee.department}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold">${riskLevelHtml}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${employee.factors}</td>
          `;
          tableBody.appendChild(row);
        });
      }

      document.getElementById('attrition-risk-loader').style.display = 'none';
      document.getElementById('attrition-risk-content').style.display = 'block';
    })
    .withFailureHandler(function(err) {
      const tableBody = document.getElementById('attrition-risk-table-body');
      tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-red-500">Failed to load predictive data. Error: ${err.message}</td></tr>`;
      document.getElementById('attrition-risk-loader').style.display = 'none';
      document.getElementById('attrition-risk-content').style.display = 'block';
    })
    .getAttritionRiskData();
}

function drawHiringPredictions() {
  document.getElementById('tth-prediction-loader').style.display = 'flex';
  document.getElementById('tth-prediction-content').style.display = 'none';
  document.getElementById('source-quality-loader').style.display = 'flex';
  document.getElementById('source-quality-content').style.display = 'none';

  google.script.run
    .withSuccessHandler(function(data) {
      const tthTableBody = document.getElementById('tth-prediction-table-body');
      tthTableBody.innerHTML = '';
      if (data.error || Object.keys(data.timeToHire).length === 0) {
        tthTableBody.innerHTML = `<tr><td colspan="2" class="text-center p-4 text-gray-500">No hiring data available to make predictions.</td></tr>`;
      } else {
        const sortedPositions = Object.entries(data.timeToHire).sort((a, b) => b[1] - a[1]);
        sortedPositions.forEach(([position, days]) => {
          const row = tthTableBody.insertRow();
          row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${position}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 font-bold">${days} days</td>
          `;
        });
      }

      const sourceTableBody = document.getElementById('source-quality-table-body');
      sourceTableBody.innerHTML = '';
      if (data.error || Object.keys(data.sourceQuality).length === 0) {
        sourceTableBody.innerHTML = `<tr><td colspan="2" class="text-center p-4 text-gray-500">No source data available to make predictions.</td></tr>`;
      } else {
        const sortedSources = Object.entries(data.sourceQuality).sort((a, b) => b[1].rate - a[1].rate);
        sortedSources.forEach(([source, stats]) => {
          const row = sourceTableBody.insertRow();
          row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${source}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 font-bold">${stats.rate}% <span class="text-xs text-gray-500 font-normal">(${stats.hires}/${stats.applications} hires)</span></td>
          `;
        });
      }

      document.getElementById('tth-prediction-loader').style.display = 'none';
      document.getElementById('tth-prediction-content').style.display = 'block';
      document.getElementById('source-quality-loader').style.display = 'none';
      document.getElementById('source-quality-content').style.display = 'block';
    })
    .withFailureHandler(err => {
        document.getElementById('tth-prediction-table-body').innerHTML = `<tr><td colspan="2" class="text-center p-4 text-red-500">Error: ${err.message}</td></tr>`;
        document.getElementById('source-quality-table-body').innerHTML = `<tr><td colspan="2" class="text-center p-4 text-red-500">Error: ${err.message}</td></tr>`;
    })
    .getHiringPredictions();
}

// --- END: NEW PREDICTIVE INSIGHTS SCRIPT ---

function drawTalentInsights() {
  document.getElementById('talent-insights-loader').style.display = 'flex';
  document.getElementById('talent-insights-content').style.display = 'none';

  google.script.run
    .withSuccessHandler(function(data) {
      if (data.error) {
          document.getElementById('talent-insights-content').innerHTML = `<p class="text-red-500 p-4"><b>Error:</b> ${data.error}</p>`;
          document.getElementById('talent-insights-loader').style.display = 'none';
          document.getElementById('talent-insights-content').style.display = 'block';
          return;
      }

      // Populate Succession Plan Table
      const successionBody = document.getElementById('succession-plan-table-body');
      successionBody.innerHTML = '';
      if (data.successionPlan.length > 0) {
        data.successionPlan.forEach(item => {
          const row = successionBody.insertRow();
          row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.keyPosition}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${item.successorName}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.readiness}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.notes}</td>
          `;
        });
      } else {
        successionBody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-gray-500">No succession plans defined.</td></tr>`;
      }

      // Populate Promotion Ready Table
      const promotionBody = document.getElementById('promotion-ready-table-body');
      promotionBody.innerHTML = '';
      if (data.promotionReady.length > 0) {
        data.promotionReady.forEach(emp => {
          const row = promotionBody.insertRow();
          row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"><div>${emp.name}</div><div class="text-xs text-gray-500">${emp.jobTitle}</div></td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-700 font-bold">${emp.performance}</td>
          `;
        });
      } else {
        promotionBody.innerHTML = `<tr><td colspan="2" class="text-center p-4 text-gray-500">No employees currently meet the criteria for promotion.</td></tr>`;
      }

      // Populate High Potentials Table
      const highPotentialBody = document.getElementById('high-potentials-table-body');
      highPotentialBody.innerHTML = '';
      if (data.highPotentials.length > 0) {
        data.highPotentials.forEach(emp => {
          const row = highPotentialBody.insertRow();
          row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"><div>${emp.name}</div><div class="text-xs text-gray-500">${emp.jobTitle}</div></td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${emp.department}</td>
          `;
        });
      } else {
        highPotentialBody.innerHTML = `<tr><td colspan="2" class="text-center p-4 text-gray-500">No high-potential employees identified.</td></tr>`;
      }

      document.getElementById('talent-insights-loader').style.display = 'none';
      document.getElementById('talent-insights-content').style.display = 'block';
    })
    .withFailureHandler(function(err) {
      document.getElementById('talent-insights-content').innerHTML = `<p class="text-red-500 p-4"><b>Error:</b> Failed to load talent data. ${err.message}</p>`;
      document.getElementById('talent-insights-loader').style.display = 'none';
      document.getElementById('talent-insights-content').style.display = 'block';
    })
    .getTalentAnalyticsData();
}

var chartInstances = {}; // To keep track of charts and destroy them before redrawing

function initializeCompetencyView() {
    console.log("Initializing Competency View...");
    competencyViewInitialized = true;
    google.charts.load('current', {packages:['gauge']});

    // --- 1. Setup Dynamic Filters (Individual & Heatmap) ---
    if (typeof fullEmployeeData !== 'undefined' && fullEmployeeData.length > 0) {
        populateCompetencyFilters();
        populateHeatmapFilters();
    } else {
        setTimeout(() => {
             if (typeof fullEmployeeData !== 'undefined') {
                 populateCompetencyFilters();
                 populateHeatmapFilters();
             }
        }, 1000);
    }

    // --- 2. Setup View Toggles (With Dynamic Title Change) ---
    const individualProfileButton = document.getElementById('show-individual-profile');
    const teamHeatmapButton = document.getElementById('show-team-heatmap');
    
    const individualProfileDropdownView = document.getElementById('individual-profile-view');
    const individualProfileContentView = document.getElementById('individual-profile-content');
    const teamHeatmapView = document.getElementById('team-competency-section');
    const sectionTitle = document.getElementById('competency-card-title'); // <--- NEW TARGET

    if (individualProfileButton && teamHeatmapButton) {
        individualProfileButton.addEventListener('click', () => {
            // Update View
            individualProfileDropdownView.style.display = 'block';
            individualProfileContentView.style.display = 'block';
            teamHeatmapView.style.display = 'none';
            
            // Update Title
            if(sectionTitle) sectionTitle.textContent = "Employee Competency Profile";

            // Update Buttons
            individualProfileButton.classList.add('bg-white', 'shadow', 'text-blue-700');
            individualProfileButton.classList.remove('text-gray-600', 'hover:bg-gray-300');
            teamHeatmapButton.classList.add('text-gray-600', 'hover:bg-gray-300');
            teamHeatmapButton.classList.remove('bg-white', 'shadow', 'text-blue-700');
        });

        teamHeatmapButton.addEventListener('click', () => {
            // Update View
            individualProfileDropdownView.style.display = 'none';
            individualProfileContentView.style.display = 'none';
            teamHeatmapView.style.display = 'block';

            // Update Title
            if(sectionTitle) sectionTitle.textContent = "Team Competency Heatmap";
            
            // Update Buttons
            teamHeatmapButton.classList.add('bg-white', 'shadow', 'text-blue-700');
            teamHeatmapButton.classList.remove('text-gray-600', 'hover:bg-gray-300');
            individualProfileButton.classList.add('text-gray-600', 'hover:bg-gray-300');
            individualProfileButton.classList.remove('bg-white', 'shadow', 'text-blue-700');
        });
    }

    // --- 4. Initial Visibility ---
    if (individualProfileDropdownView) individualProfileDropdownView.style.display = 'block';
    if (individualProfileContentView) individualProfileContentView.style.display = 'block';
    if (document.getElementById('heatmap-legend')) document.getElementById('heatmap-legend').style.display = 'none';
}

function openRequestModal() {
  // --- FIX: RESET EDIT MODE ARTIFACTS ---
  // 1. Clear the hidden Request ID so we don't overwrite existing rows
  const hiddenId = document.getElementById('edit-request-id');
  if (hiddenId) hiddenId.value = '';

  // 2. Reset Submit Button Text & Color
  const submitBtn = document.querySelector('#request-form button[onclick="submitRequest()"]');
  if (submitBtn) {
      submitBtn.textContent = "Submit Request";
      submitBtn.classList.remove('bg-yellow-600');
      submitBtn.classList.add('bg-blue-600');
  }

  // 3. Clear "Previous documents attached" message/flag
  const form = document.getElementById('request-form');
  if (form) delete form.dataset.hasAttachments;
  
  const oldMsg = document.getElementById('existing-docs-msg');
  if (oldMsg) oldMsg.remove();

  // --- OPEN MODAL LOGIC ---
  document.getElementById('request-modal').style.display = 'flex';
  document.getElementById('request-fields').innerHTML = ''; // Clear old fields
  document.getElementById('request-form').reset(); // Reset form inputs
  
  // Re-attach event listener
  const typeSelect = document.getElementById('request-type');
  // Remove old listener to prevent duplicates, then add new one
  typeSelect.removeEventListener('change', handleRequestTypeChange); 
  typeSelect.addEventListener('change', handleRequestTypeChange);

  // Load Approvers
  const approverSelect = document.getElementById('approver-email-select');
  approverSelect.innerHTML = '<option value="">Loading approvers...</option>';
  
  google.script.run
    .withSuccessHandler(approvers => {
      approverSelect.innerHTML = '<option value="">-- Select an Approver --</option>';
      if (approvers && approvers.length > 0) {
        approvers.forEach(approver => {
          const option = document.createElement('option');
          option.value = approver.email;
          option.textContent = approver.email;
          approverSelect.appendChild(option);
        });
      } else {
        approverSelect.innerHTML = '<option value="">No approvers found</option>';
      }
    })
    .withFailureHandler(err => {
      approverSelect.innerHTML = `<option value="">Error: ${err.message}</option>`;
    })
    .getApproverList();
}

function closeRequestModal() {
  document.getElementById('request-modal').style.display = 'none';
  
  // Reset Edit Mode Variables
  const hiddenId = document.getElementById('edit-request-id');
  if(hiddenId) hiddenId.value = '';
  
  const submitBtn = document.querySelector('#request-form button[onclick="submitRequest()"]');
  if(submitBtn) {
      submitBtn.textContent = "Submit Request";
      submitBtn.classList.remove('bg-yellow-600');
      submitBtn.classList.add('bg-blue-600');
  }

  // Clean up DOM
  document.getElementById('request-type').removeEventListener('change', handleRequestTypeChange);
  document.getElementById('request-fields').innerHTML = '';
  document.getElementById('request-form').reset();
  
  const oldMsg = document.getElementById('existing-docs-msg');
  if (oldMsg) oldMsg.remove();
}

// --- NEW: DYNAMIC REQUEST FILTER LOGIC ---

/**
 * Initializes the 5-level filter logic for the Request Modal.
 * This replaces the simple employee dropdown initialization.
 */
// --- NEW: DYNAMIC REQUEST FILTER LOGIC (UPDATED) ---

function initializeRequestFilterSystem() {
  // Initial population of Division data
  const divisions = [...new Set(fullEmployeeData.map(e => e.division).filter(String))].sort();
  
  // Helper to visually reset downstream dropdowns to empty boxes
  const resetToEmpty = (id) => {
    // Re-create the dropdown with an empty list []
    createSearchableDropdown(id, [], null, null, null);
    
    // Optional: Clear the actual input value and add a visual indicator indicating it's waiting for data
    const container = document.getElementById(id);
    const input = container.querySelector('.searchable-dropdown-input');
    if(input) {
        input.value = '';
        input.placeholder = "Select prev. filter first..."; // Helpful hint
        container.setAttribute('data-empty', 'true'); // For CSS styling
    }
  };

  // --- DEFINE HANDLERS (Reverse Order) ---

  // 4. Section -> Employee Handler
  function handleSectionChange(division, group, dept, section) {
    const employees = fullEmployeeData
      .filter(e => e.division === division && e.group === group && e.department === dept && e.section === section && e.employeeId)
      .map(e => ({ name: e.employeeName, id: e.employeeId }))
      .sort((a, b) => a.name.localeCompare(b.name));

    // Populate Employee Dropdown
    createSearchableDropdown('req-filter-employee', employees, 'name', 'id', (empId) => {
       autoPopulateRequestFields(empId);
       document.getElementById('req-filter-employee').removeAttribute('data-empty');
    });
    document.getElementById('req-filter-employee').removeAttribute('data-empty');
  }

  // 3. Department -> Section Handler
  function handleDeptChange(division, group, dept) {
    const sections = [...new Set(fullEmployeeData
      .filter(e => e.division === division && e.group === group && e.department === dept)
      .map(e => e.section).filter(String))].sort();

    // Populate Section Dropdown
    createSearchableDropdown('req-filter-section', sections, null, null, (selectedSec) => handleSectionChange(division, group, dept, selectedSec));
    document.getElementById('req-filter-section').removeAttribute('data-empty');

    // Reset Employee
    resetToEmpty('req-filter-employee');
  }

  // 2. Group -> Department Handler
  function handleGroupChange(division, group) {
    const depts = [...new Set(fullEmployeeData
      .filter(e => e.division === division && e.group === group)
      .map(e => e.department).filter(String))].sort();

    // Populate Department Dropdown
    createSearchableDropdown('req-filter-department', depts, null, null, (selectedDept) => handleDeptChange(division, group, selectedDept));
    document.getElementById('req-filter-department').removeAttribute('data-empty');

    // Reset downstream
    resetToEmpty('req-filter-section');
    resetToEmpty('req-filter-employee');
  }

  // --- INITIALIZATION ---

  // 1. Initialize Division (with data)
  createSearchableDropdown('req-filter-division', divisions, null, null, (selectedDiv) => {
    // Filter Groups based on Division
    const groups = [...new Set(fullEmployeeData
      .filter(e => e.division === selectedDiv)
      .map(e => e.group).filter(String))].sort();
    
    // Populate Group Dropdown
    createSearchableDropdown('req-filter-group', groups, null, null, (selectedGrp) => handleGroupChange(selectedDiv, selectedGrp));
    document.getElementById('req-filter-group').removeAttribute('data-empty');

    // Reset downstream
    resetToEmpty('req-filter-department');
    resetToEmpty('req-filter-section');
    resetToEmpty('req-filter-employee');
  });

  //  KEY CHANGE HERE: Immediately initialize the rest as empty boxes 
  resetToEmpty('req-filter-group');
  resetToEmpty('req-filter-department');
  resetToEmpty('req-filter-section');
  resetToEmpty('req-filter-employee');
}


/**
 * Auto-populates the request form based on the selected Employee ID.
 */
function autoPopulateRequestFields(employeeId) {
  const employee = fullEmployeeData.find(e => String(e.employeeId).trim() === String(employeeId).trim());
  
  if (!employee) return;

  // Common fields mapping (ID -> Value)
  const fieldMap = {
    'request-EmployeeID': employee.employeeId,
    'request-DateHired': employee.dateHired,
    'request-DateOfBirth': employee.dateOfBirth,
    'request-Gender': employee.gender,
    'current-position-id': employee.positionId,
    'current-reporting-to': employee.managerName,
    'current-job-title': employee.jobTitle,
    'current-name': employee.employeeName,
    
    // --- NEW: Map additional fields for Resignation ---
    'request-Division': employee.division,
    'request-Group': employee.group,
    'request-Department': employee.department,
    'request-Section': employee.section,
    'request-JobTitle': employee.jobTitle,
    'request-Level': employee.level,
    'request-JobLevel': employee.jobLevel,
    'request-ContractType': employee.contractType
  };

  // Fill fields if they exist in the DOM
  for (const [id, value] of Object.entries(fieldMap)) {
    const el = document.getElementById(id);
    if (el) {
       el.value = value || '';
    }
  }

  // Special handling for the Dropdown Input itself
  const empInput = document.querySelector('#req-filter-employee .searchable-dropdown-input');
  if (empInput) empInput.value = employee.employeeName;
}


function handleRequestTypeChange() {
  const requestType = document.getElementById('request-type').value;
  const fieldsContainer = document.getElementById('request-fields');
  fieldsContainer.innerHTML = '';

  if (!requestType) return;

  const FILTER_HTML = `
      <div><label class="block font-medium">Filter by Division</label><div id="req-filter-division" class="searchable-dropdown"></div></div>
      <div><label class="block font-medium">Filter by Group</label><div id="req-filter-group" class="searchable-dropdown"></div></div>
      <div><label class="block font-medium">Filter by Department</label><div id="req-filter-department" class="searchable-dropdown"></div></div>
      <div><label class="block font-medium">Filter by Section</label><div id="req-filter-section" class="searchable-dropdown"></div></div>
      <div class="md:col-span-2"><label class="block font-medium text-blue-700">Select Employee to Auto-Fill Request Details</label><div id="req-filter-employee" class="searchable-dropdown"></div></div>
      <div class="md:col-span-2 border-b border-gray-200 my-2"></div>
  `;

  const EMPLOYEE_DETAILS_HTML = `
      <div><label class="block font-medium">Employee ID</label><input type="text" id="request-EmployeeID" name="EmployeeID" readonly class="mt-1 p-2 w-full border rounded bg-gray-100"></div>
      <div><label class="block font-medium">Date Hired</label><input type="text" id="request-DateHired" name="DateHired" readonly class="mt-1 p-2 w-full border rounded bg-gray-100"></div>
      <div><label class="block font-medium">Date of Birth</label><input type="text" id="request-DateOfBirth" name="DateOfBirth" readonly class="mt-1 p-2 w-full border rounded bg-gray-100"></div>
      <div><label class="block font-medium">Gender</label><input type="text" id="request-Gender" name="Gender" readonly class="mt-1 p-2 w-full border rounded bg-gray-100"></div>
  `;

  const RESIGNATION_DETAILS_HTML = `
      <div><label class="block font-medium">Division</label><input type="text" id="request-Division" name="Division" readonly class="mt-1 p-2 w-full border rounded bg-gray-100"></div>
      <div><label class="block font-medium">Group</label><input type="text" id="request-Group" name="Group" readonly class="mt-1 p-2 w-full border rounded bg-gray-100"></div>
      <div><label class="block font-medium">Department</label><input type="text" id="request-Department" name="Department" readonly class="mt-1 p-2 w-full border rounded bg-gray-100"></div>
      <div><label class="block font-medium">Section</label><input type="text" id="request-Section" name="Section" readonly class="mt-1 p-2 w-full border rounded bg-gray-100"></div>
      <div><label class="block font-medium">Job Title</label><input type="text" id="request-JobTitle" name="JobTitle" readonly class="mt-1 p-2 w-full border rounded bg-gray-100"></div>
      <div><label class="block font-medium">Level</label><input type="text" id="request-Level" name="Level" readonly class="mt-1 p-2 w-full border rounded bg-gray-100"></div>
      <div><label class="block font-medium">Job Level</label><input type="text" id="request-JobLevel" name="JobLevel" readonly class="mt-1 p-2 w-full border rounded bg-gray-100"></div>
      <div><label class="block font-medium">Contract Type</label><input type="text" id="request-ContractType" name="ContractType" readonly class="mt-1 p-2 w-full border rounded bg-gray-100"></div>
  `;

  const attachmentsHtml = generateAttachmentsHTML(requestType);
  let fieldsHtml = '';
  let shouldUseFilters = false;

  switch (requestType) {
    case 'Lateral Transfer':
    case 'Promotion':
    case 'Internal Transfer':
      shouldUseFilters = true;
      fieldsHtml = `
        ${FILTER_HTML}
        ${EMPLOYEE_DETAILS_HTML}
        <div><label class="block font-medium">Current Position ID</label><input type="text" id="current-position-id" name="CurrentPositionID" readonly class="mt-1 p-2 w-full border rounded bg-gray-100"></div>
        <div><label class="block font-medium">New Position ID</label><div id="new-position-dropdown" class="searchable-dropdown"></div></div>
        <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="block font-medium">New Reporting To</label><input type="text" id="request-NewReportingTo" name="NewReportingTo" readonly class="mt-1 p-2 w-full border rounded bg-gray-100"></div>
            <div><label class="block font-medium">New Reporting To ID</label><input type="text" id="request-NewReportingToId" name="NewReportingToId" readonly class="mt-1 p-2 w-full border rounded bg-gray-100"></div>
        </div>
        <div><label class="block font-medium">Effective Date</label><input type="date" id="effective-date-request" name="EffectiveDate" class="mt-1 p-2 w-full border rounded"></div>
        <div class="md:col-span-2"><label class="block font-medium">Justification</label><textarea id="justification" name="Justification" class="mt-1 p-2 w-full border rounded"></textarea></div>
        ${attachmentsHtml} 
      `;
      break;

    case 'Hiring of a new employee (newly created position)':
      shouldUseFilters = false;
      fieldsHtml = `
        <div class="md:col-span-2 font-bold text-indigo-700">Position Details</div>
        <div><label class="block font-medium">Division</label><div id="request-division-dropdown" class="searchable-dropdown"></div></div>
        <div><label class="block font-medium">Group</label><div id="request-group-dropdown" class="searchable-dropdown"></div></div>
        <div><label class="block font-medium">Department</label><div id="request-department-dropdown" class="searchable-dropdown"></div></div>
        <div><label class="block font-medium">Section</label><div id="request-section-dropdown" class="searchable-dropdown"></div></div>
        <div><label class="block font-medium">New Position Job Title</label><div id="new-job-title-dropdown" class="searchable-dropdown"></div></div>
        <div><label class="block font-medium">New Position Level</label><div id="new-level-dropdown" class="searchable-dropdown"></div></div>
        <div><label class="block font-medium">Reporting To</label><div id="reporting-to-request-dropdown" class="searchable-dropdown"></div></div>
        <div><label class="block font-medium">Reporting To Employee ID</label><input type="text" id="reporting-to-id-request" name="ReportingToId" readonly class="mt-1 p-2 w-full border rounded bg-gray-100"></div>
        <div class="md:col-span-2 mt-4"><label class="block font-medium">Justification</label><textarea id="justification" name="Justification" class="mt-1 p-2 w-full border rounded" rows="3"></textarea></div>
        ${attachmentsHtml}
      `;
      break;

    case 'Hiring of a new employee (replacement for vacancy)':
      shouldUseFilters = false;
      fieldsHtml = `
        <div class="md:col-span-2 font-bold text-indigo-700">Position to be Filled</div>
        <div class="md:col-span-2"><label class="block font-medium">Vacant Position ID</label><div id="vacant-position-dropdown" class="searchable-dropdown"></div></div>
        <div><label class="block font-medium">Job Title</label><input type="text" id="request-job-title" readonly class="mt-1 p-2 w-full border rounded bg-gray-100"></div>
        <div><label class="block font-medium">Reporting To</label><input type="text" id="request-reporting-to" readonly class="mt-1 p-2 w-full border rounded bg-gray-100"></div>
        <div><label class="block font-medium">Reporting To ID</label><input type="text" id="request-reporting-to-id" readonly class="mt-1 p-2 w-full border rounded bg-gray-100"></div>
        <div><label class="block font-medium">Division</label><input type="text" id="request-division" readonly class="mt-1 p-2 w-full border rounded bg-gray-100"></div>
        <div><label class="block font-medium">Group</label><input type="text" id="request-group" readonly class="mt-1 p-2 w-full border rounded bg-gray-100"></div>
        <div><label class="block font-medium">Department</label><input type="text" id="request-department" readonly class="mt-1 p-2 w-full border rounded bg-gray-100"></div>
        <div><label class="block font-medium">Section</label><input type="text" id="request-section" readonly class="mt-1 p-2 w-full border rounded bg-gray-100"></div>
        <div><label class="block font-medium">Level</label><input type="text" id="request-level" readonly class="mt-1 p-2 w-full border rounded bg-gray-100"></div>
        <div><label class="block font-medium">Effective Vacancy Date</label><input type="date" id="effective-date-request-readonly" readonly class="mt-1 p-2 w-full border rounded bg-gray-100"></div>
        <div class="md:col-span-2 mt-4 font-bold text-indigo-700">Request Details</div>
        <div class="md:col-span-2"><label class="block font-medium">Justification</label><textarea id="justification" name="Justification" class="mt-1 p-2 w-full border rounded"></textarea></div>
        ${attachmentsHtml}
      `;
      break;

    case 'Resignation/Separation':
      shouldUseFilters = true;
      fieldsHtml = `
        ${FILTER_HTML}
        ${EMPLOYEE_DETAILS_HTML}
        ${RESIGNATION_DETAILS_HTML}
        <div><label class="block font-medium">New Status</label><div id="new-status-dropdown" class="searchable-dropdown"></div></div>
        <div><label class="block font-medium">Reason for Leaving</label><div id="reason-leaving-request-dropdown" class="searchable-dropdown"></div></div>
        <div><label class="block font-medium">Effective Date</label><input type="date" id="effective-date-request" name="EffectiveDate" class="mt-1 p-2 w-full border rounded"></div>
        <div class="md:col-span-2"><label class="block font-medium">Remarks/Justification</label><textarea id="justification" name="Justification" class="mt-1 p-2 w-full border rounded"></textarea></div>
        ${attachmentsHtml}
      `;
      break;

    case 'Change in Employment Status':
    case 'Regularization':
      shouldUseFilters = true;
      fieldsHtml = `
        ${FILTER_HTML}
        ${EMPLOYEE_DETAILS_HTML}
        <div><label class="block font-medium">New Status</label><div id="new-status-dropdown" class="searchable-dropdown"></div></div>
        <div><label class="block font-medium">Effective Date</label><input type="date" id="effective-date-request" name="EffectiveDate" class="mt-1 p-2 w-full border rounded"></div>
        <div class="md:col-span-2"><label class="block font-medium">Remarks/Justification</label><textarea id="justification" name="Justification" class="mt-1 p-2 w-full border rounded"></textarea></div>
        ${attachmentsHtml}
      `;
      break;

    case 'Change in Reporting line':
      shouldUseFilters = true;
      fieldsHtml = `
        ${FILTER_HTML}
        ${EMPLOYEE_DETAILS_HTML}
        <div><label class="block font-medium">Current Reporting To</label><input type="text" id="current-reporting-to" readonly class="mt-1 p-2 w-full border rounded bg-gray-100"></div>
        <div><label class="block font-medium">New Reporting To</label><div id="new-reporting-to-dropdown" class="searchable-dropdown"></div></div>
        <div><label class="block font-medium">Effective Date</label><input type="date" id="effective-date-request" name="EffectiveDate" class="mt-1 p-2 w-full border rounded"></div>
        <div class="md:col-span-2"><label class="block font-medium">Remarks/Justification</label><textarea id="justification" name="Justification" class="mt-1 p-2 w-full border rounded"></textarea></div>
        ${attachmentsHtml}
      `;
      break;

    case 'Job Title/Position Change (without promotion)':
      shouldUseFilters = true;
      fieldsHtml = `
        ${FILTER_HTML}
        ${EMPLOYEE_DETAILS_HTML}
        <div><label class="block font-medium">Current Job Title</label><input type="text" id="current-job-title" readonly class="mt-1 p-2 w-full border rounded bg-gray-100"></div>
        <div><label class="block font-medium">New Job Title</label><div id="new-job-title-dropdown" class="searchable-dropdown"></div></div>
        <div><label class="block font-medium">Effective Date</label><input type="date" id="effective-date-request" name="EffectiveDate" class="mt-1 p-2 w-full border rounded"></div>
        <div class="md:col-span-2"><label class="block font-medium">Remarks/Justification</label><textarea id="justification" name="Justification" class="mt-1 p-2 w-full border rounded"></textarea></div>
        ${attachmentsHtml}
      `;
      break;

    case 'Name Correction/Update of Employee Information':
      shouldUseFilters = true;
      fieldsHtml = `
        ${FILTER_HTML}
        ${EMPLOYEE_DETAILS_HTML}
        <div><label class="block font-medium">Current Name</label><input type="text" id="current-name" readonly class="mt-1 p-2 w-full border rounded bg-gray-100"></div>
        <div><label class="block font-medium">New/Corrected Name</label><input type="text" id="new-employee-name" name="NewName" class="mt-1 p-2 w-full border rounded"></div>
        <div class="md:col-span-2"><label class="block font-medium">Remarks/Justification</label><textarea id="justification" name="Justification" class="mt-1 p-2 w-full border rounded"></textarea></div>
        ${attachmentsHtml}
      `;
      break;

    case 'Position on Hold/Cancelled/Deleted':
      shouldUseFilters = false; 
      fieldsHtml = `
        <div class="md:col-span-2"><label class="block font-medium">Position ID</label><div id="position-id-dropdown" class="searchable-dropdown"></div></div>
        <div class="md:col-span-2"><label class="block font-medium">Action</label>
            <select name="Action" class="mt-1 p-2 w-full border rounded">
                <option>On Hold</option>
                <option>Cancelled</option>
                <option>Deleted</option>
            </select>
        </div>
        <div class="md:col-span-2"><label class="block font-medium">Remarks/Justification</label><textarea id="justification" name="Justification" class="mt-1 p-2 w-full border rounded"></textarea></div>
        ${attachmentsHtml}
      `;
      break;

    default:
        fieldsHtml = '<p class="text-gray-500 md:col-span-2">This request type is not yet implemented.</p>';
        break;
  }
  
  fieldsContainer.innerHTML = fieldsHtml;

  if (shouldUseFilters) initializeRequestFilterSystem();

  // --- RE-INITIALIZATION LOGIC ---
  if (requestType.includes('Transfer') || requestType.includes('Promotion')) {
    // --- FIX: Filter for VACANT positions only ---
    const vacantPositions = fullEmployeeData.filter(p => !p.employeeId).map(p => p.positionId);
    
    createSearchableDropdown('new-position-dropdown', vacantPositions, null, null, (positionId) => {
        const input = document.querySelector('#new-position-dropdown .searchable-dropdown-input');
        input.name = "NewPositionID"; input.value = positionId;
        const selectedPosition = fullEmployeeData.find(p => p.positionId === positionId);
        if (selectedPosition) {
            document.getElementById('request-NewReportingTo').value = selectedPosition.managerName || '';
            document.getElementById('request-NewReportingToId').value = selectedPosition.managerEmployeeId || '';
        }
    });

    // --- BLUR LISTENER: Allows searching whole DB if user types manual ID ---
    const newPosInput = document.querySelector('#new-position-dropdown .searchable-dropdown-input');
    if (newPosInput) {
        newPosInput.addEventListener('blur', function() {
            const typedId = this.value;
            const selectedPosition = fullEmployeeData.find(p => p.positionId === typedId);
            if (selectedPosition) {
                document.getElementById('request-NewReportingTo').value = selectedPosition.managerName || '';
                document.getElementById('request-NewReportingToId').value = selectedPosition.managerEmployeeId || '';
            } else {
                document.getElementById('request-NewReportingTo').value = '';
                document.getElementById('request-NewReportingToId').value = '';
            }
        });
    }
  }

  if (requestType.includes('newly created')) {
    createSearchableDropdown('new-job-title-dropdown', dropdownListData.jobtitle || [], null, null, (val) => { document.querySelector('#new-job-title-dropdown .searchable-dropdown-input').name = "NewJobTitle"; });
    createSearchableDropdown('new-level-dropdown', dropdownListData.level || [], null, null, (val) => { document.querySelector('#new-level-dropdown .searchable-dropdown-input').name = "NewLevel"; });
    createSearchableDropdown('reporting-to-request-dropdown', dropdownListData.managers || [], 'name', 'id', (id) => { document.getElementById('reporting-to-id-request').value = id; });
    createSearchableDropdown('request-division-dropdown', dropdownListData.divisions || [], null, null, (sel) => updateRequestLocationDropdowns('division', sel));
    createSearchableDropdown('request-group-dropdown', [], null, null, (sel) => updateRequestLocationDropdowns('group', sel));
    createSearchableDropdown('request-department-dropdown', [], null, null, (sel) => updateRequestLocationDropdowns('department', sel));
    createSearchableDropdown('request-section-dropdown', [], null, null, null);
  }
  if (requestType.includes('replacement')) {
    const vacantPositions = fullEmployeeData.filter(p => !p.employeeId).map(p => p.positionId);
    createSearchableDropdown('vacant-position-dropdown', vacantPositions, null, null, (positionId) => {
      const position = fullEmployeeData.find(p => p.positionId === positionId);
      if (position) {
        document.getElementById('request-job-title').value = position.jobTitle || '';
        document.getElementById('request-reporting-to').value = position.managerName || '';
        document.getElementById('request-reporting-to-id').value = position.managerEmployeeId || ''; 
        document.getElementById('request-division').value = position.division || '';
        document.getElementById('request-group').value = position.group || '';
        document.getElementById('request-department').value = position.department || '';
        document.getElementById('request-section').value = position.section || '';
        document.getElementById('request-level').value = position.level || '';
        google.script.run.withSuccessHandler(info => { if (info && info.dateBecameVacant) document.getElementById('effective-date-request-readonly').value = info.dateBecameVacant; }).getLastIncumbentInfo(positionId);
      }
    });
  }
  
  if (requestType.includes('Status') || requestType.includes('Regularization') || requestType.includes('Resignation') || requestType.includes('Separation')) {
      createSearchableDropdown('new-status-dropdown', dropdownListData.status || [], null, null, (val) => { document.querySelector('#new-status-dropdown .searchable-dropdown-input').name = "NewStatus"; });
      
      if (requestType.includes('Resignation') || requestType.includes('Separation')) {
          createSearchableDropdown('reason-leaving-request-dropdown', dropdownListData.reasonforleaving || [], null, null, (val) => {
              const input = document.querySelector('#reason-leaving-request-dropdown .searchable-dropdown-input');
              input.name = "ReasonForLeaving";
          });
      }
  }
  
  if (requestType.includes('Reporting line')) {
      createSearchableDropdown('new-reporting-to-dropdown', dropdownListData.managers || [], 'name', 'name', (val) => { document.querySelector('#new-reporting-to-dropdown .searchable-dropdown-input').name = "NewReportingToName"; });
  }
  if (requestType.includes('Job Title/Position Change')) {
      createSearchableDropdown('new-job-title-dropdown', dropdownListData.jobtitle || [], null, null, (val) => { document.querySelector('#new-job-title-dropdown .searchable-dropdown-input').name = "NewJobTitle"; });
  }
  if (requestType.includes('Position on Hold')) {
      const allPositions = fullEmployeeData.map(p => p.positionId);
      createSearchableDropdown('position-id-dropdown', allPositions, null, null, (val) => { document.querySelector('#position-id-dropdown .searchable-dropdown-input').name = "PositionID"; });
  }
}

function submitRequest() {
  const requestType = document.getElementById('request-type').value;
  if (!requestType) { alert('Please select a request type.'); return; }

  const approver = document.getElementById('approver-email-select').value;
  // --- FIX: Prevent submission if no approver selected ---
  if (!approver || approver === "") { 
    alert('Please select an approver before submitting.'); 
    return; 
  }

  if (requestType.includes('Position on Hold') || requestType.includes('Cancelled') || requestType.includes('Deleted')) {
      const posId = document.querySelector('#position-id-dropdown .searchable-dropdown-input')?.value;
      const action = document.querySelector('select[name="Action"]')?.value;
      if (!posId || !action) { alert('Please select both a Position ID and an Action.'); return; }
  }

  if (requestType.includes('Promotion') || requestType.includes('Transfer')) {
      const newPosId = document.querySelector('#new-position-dropdown .searchable-dropdown-input')?.value;
      if (!newPosId) { alert('Please select a New Position ID.'); return; }
  }

  // File Validation
  const form = document.getElementById('request-form');
  const hasExistingFiles = form.dataset.hasAttachments === 'true';
  
  const attachmentInputs = document.querySelectorAll('.dynamic-attachment-input');
  let collectedFiles = [];
  let missingRequired = false;

  document.querySelectorAll('.error-message').forEach(el => el.classList.remove('show-error'));
  document.querySelectorAll('.dynamic-attachment-input').forEach(el => el.classList.remove('input-error'));
  document.getElementById('global-file-error').style.display = 'none';

  attachmentInputs.forEach(input => {
    const file = input.files[0];
    const isRequired = input.dataset.required === 'true';

    if (isRequired && !file && !hasExistingFiles) {
      input.classList.add('input-error');
      if(input.nextElementSibling && input.nextElementSibling.classList.contains('error-message')) {
          input.nextElementSibling.classList.add('show-error');
      }
      missingRequired = true;
    }

    if (file) collectedFiles.push(file);
  });

  if (missingRequired) {
    alert("Please upload all required attachments.");
    return;
  }

  showSavingOverlay('Processing Request...');

  const filePromises = Array.from(attachmentInputs).map(input => {
    const file = input.files[0];
    if (!file) return Promise.resolve(null); 
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        resolve({
          name: file.name,
          mimeType: file.type,
          content: e.target.result.split(',')[1],
          label: input.dataset.label
        });
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  });

  Promise.all(filePromises).then(fileContents => {
    const validFiles = fileContents.filter(file => file !== null);

    let empName = document.querySelector('#req-filter-employee .searchable-dropdown-input')?.value;
    if (!empName) empName = document.querySelector('#employee-request-dropdown .searchable-dropdown-input')?.value;

    const hiddenIdInput = document.getElementById('edit-request-id');
    const existingRequestId = hiddenIdInput ? hiddenIdInput.value : null;

    const requestData = {
      RequestID: existingRequestId,
      RequestType: requestType,
      ApproverEmail: document.getElementById('approver-email-select').value, // This now grabs the correctly selected approver
      Justification: document.getElementById('justification')?.value,
      EffectiveDate: document.getElementById('effective-date-request')?.value,
      files: validFiles,
      EmployeeName: empName,
      EmployeeID: document.getElementById('request-EmployeeID')?.value,
      DateHired: document.getElementById('request-DateHired')?.value,
      DateOfBirth: document.getElementById('request-DateOfBirth')?.value,
      Gender: document.getElementById('request-Gender')?.value,
      Division: document.querySelector('#request-division-dropdown .searchable-dropdown-input')?.value || document.getElementById('request-Division')?.value,
      Group: document.querySelector('#request-group-dropdown .searchable-dropdown-input')?.value || document.getElementById('request-Group')?.value,
      Department: document.querySelector('#request-department-dropdown .searchable-dropdown-input')?.value || document.getElementById('request-Department')?.value,
      Section: document.querySelector('#request-section-dropdown .searchable-dropdown-input')?.value || document.getElementById('request-Section')?.value,
      JobTitle: document.querySelector('#new-job-title-dropdown .searchable-dropdown-input')?.value || document.getElementById('request-JobTitle')?.value,
      Level: document.querySelector('#new-level-dropdown .searchable-dropdown-input')?.value || document.getElementById('request-Level')?.value,
      JobLevel: document.getElementById('request-JobLevel')?.value,
      ContractType: document.getElementById('request-ContractType')?.value,
      CurrentPositionID: document.getElementById('current-position-id')?.value || document.querySelector('#position-id-dropdown .searchable-dropdown-input')?.value,
      NewPositionID: document.querySelector('#new-position-dropdown .searchable-dropdown-input')?.value,
      NewReportingTo: document.getElementById('request-NewReportingTo')?.value,
      NewReportingToId: document.getElementById('request-NewReportingToId')?.value,
      NewJobTitle: document.querySelector('#new-job-title-dropdown .searchable-dropdown-input')?.value, 
      NewLevel: document.querySelector('#new-level-dropdown .searchable-dropdown-input')?.value, 
      ReportingToId: document.getElementById('reporting-to-id-request')?.value,
      ReportingTo: document.querySelector('#reporting-to-request-dropdown .searchable-dropdown-input')?.value,
      NewStatus: document.querySelector('#new-status-dropdown .searchable-dropdown-input')?.value, 
      ReasonForLeaving: document.querySelector('#reason-leaving-request-dropdown .searchable-dropdown-input')?.value || document.querySelector('#new-status-dropdown .searchable-dropdown-input')?.value,
      VacantPositionID: document.querySelector('#vacant-position-dropdown .searchable-dropdown-input')?.value,
      NewEmployeeName: document.getElementById('new-employee-name')?.value,
      NewEmployeeID: document.getElementById('new-employee-id')?.value,
      NewReportingToName: document.querySelector('#new-reporting-to-dropdown .searchable-dropdown-input')?.value,
      Action: document.querySelector('select[name="Action"]')?.value
    };
    
    if (requestType === 'Hiring of a new employee (replacement for vacancy)') {
        requestData.NewJobTitle = document.getElementById('request-job-title')?.value;
        requestData.ReportingTo = document.getElementById('request-reporting-to')?.value;
        requestData.ReportingToId = document.getElementById('request-reporting-to-id')?.value;
        requestData.Division = document.getElementById('request-division')?.value;
        requestData.Group = document.getElementById('request-group')?.value;
        requestData.Department = document.getElementById('request-department')?.value;
        requestData.Section = document.getElementById('request-section')?.value;
        requestData.NewLevel = document.getElementById('request-level')?.value;
    }
    
    google.script.run
      .withSuccessHandler(() => {
        hideSavingOverlay();
        alert('Request submitted successfully!');
        closeRequestModal();
        if (typeof refreshChangeRequestData === 'function') { refreshChangeRequestData(); }
      })
      .withFailureHandler((err) => {
        hideSavingOverlay();
        alert('Error submitting request: ' + err.message);
      })
      .submitChangeRequest(requestData);
      
  }).catch(error => {
    hideSavingOverlay();
    alert('Error reading files: ' + error.message);
  });
}

function drawTeamCompetencyHeatmap(filters) {
    const loader = document.getElementById('heatmap-loader');
    const container = document.getElementById('heatmap-container');
    const legend = document.getElementById('heatmap-legend');
    
    loader.style.display = 'flex';
    container.innerHTML = '';
    if(legend) legend.style.display = 'none'; 

    google.script.run
        .withSuccessHandler(data => {
            loader.style.display = 'none';
            if (data.error) {
                container.innerHTML = `<p class="text-red-500 text-center mt-4">${data.error}</p>`;
                return;
            }
            if (data.employeeScores.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center mt-4">No employees found matching these filters.</p>';
                return;
            }

            if(legend) legend.style.display = 'flex';

            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200 border text-xs';

            const thead = document.createElement('thead');
            thead.className = 'bg-gray-50';
            
            let headerHtml = '<tr><th class="sticky-col px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider border-r align-bottom shadow-sm">Employee Name</th>';
            
            data.headers.forEach(headerObj => {
                let badgeClass = "bg-gray-100 text-gray-800";
                if (headerObj.category === "CORE") badgeClass = "bg-blue-100 text-blue-800";
                if (headerObj.category === "LEADERSHIP") badgeClass = "bg-purple-100 text-purple-800";
                if (headerObj.category === "TECHNICAL") badgeClass = "bg-teal-100 text-teal-800";

                headerHtml += `<th class="p-2 border-l font-medium text-gray-500 uppercase text-center" style="min-width: 120px; vertical-align: bottom;">
                    <span class="inline-block px-2 py-0.5 rounded text-[10px] font-bold mb-1 ${badgeClass}">${headerObj.category}</span><br>
                    ${headerObj.name}
                </th>`;
            });
            
            headerHtml += '</tr>';
            thead.innerHTML = headerHtml;
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            tbody.className = 'bg-white divide-y divide-gray-200';
            
            data.employeeScores.forEach(employee => {
                let rowHtml = `<tr><td class="sticky-col px-6 py-3 whitespace-nowrap font-medium text-gray-900 border-r shadow-sm">${employee.name}</td>`;
                
                employee.scores.forEach(score => {
                    const color = getHeatmapColor(score);
                    const textColor = (score === "" || score === 0) ? '#9ca3af' : 'white'; 
                    rowHtml += `<td class="px-2 py-3 whitespace-nowrap text-center font-bold" style="background-color: ${color}; color: ${textColor}; border: 1px solid #fff;">${score}</td>`;
                });
                rowHtml += '</tr>';
                tbody.innerHTML += rowHtml;
            });
            table.appendChild(tbody);

            container.appendChild(table);
        })
        .withFailureHandler(err => {
            loader.style.display = 'none';
            container.innerHTML = `<p class="text-red-500">An error occurred: ${err.message}</p>`;
        })
        .getTeamCompetencyHeatmap(filters);
}

function getHeatmapColor(score) {
    // FIX: If score is empty/blank, return a neutral color (Light Gray)
    if (!score) return '#f3f4f6'; 
    
    if (score >= 4) return '#16a34a'; // Dark Green
    if (score >= 3) return '#22c55e'; // Green
    if (score >= 2) return '#facc15'; // Yellow
    if (score >= 1) return '#f97316'; // Orange
    return '#ef4444'; // Red (only for actual low scores like 0.5)
}

function drawCompetencyDashboard(employeeId) {
    // Show Loader
    document.getElementById('competency-charts-loader').style.display = 'flex';
    
    // Hide Main Containers
    document.getElementById('competency-dashboard-grid').style.display = 'none';
    document.getElementById('competency-charts-container').style.display = 'none';

    // Destroy previous charts to avoid glitches
    Object.values(chartInstances).forEach(chart => chart.destroy());
    chartInstances = {};

    google.script.run.withSuccessHandler(analytics => {
        if (analytics.error) {
            alert('Error fetching competency analytics: ' + analytics.error);
            document.getElementById('competency-charts-loader').style.display = 'none';
            return;
        }

        // 1. Render the Top 4-Column Grid
        renderOverallScoreGauge(analytics.overall);
        renderStrengthsAndGaps(analytics.strengths, analytics.gaps);
        renderHistoricalChart(analytics.history);

        // 2. Render the Bottom Detailed Sections
        renderRadarCharts(analytics.radarData);

        // 3. Reveal Everything
        document.getElementById('competency-charts-loader').style.display = 'none';
        document.getElementById('competency-dashboard-grid').style.display = 'grid';
        document.getElementById('competency-charts-container').style.display = 'flex';

    }).getCompetencyAnalytics(employeeId);
}

// --- NEW HELPER FUNCTIONS ---

// REVISED - This function now sets the gauge's maximum value to 4.
    function renderOverallScoreGauge(overall) {
        const data = google.visualization.arrayToDataTable([
          ['Label', 'Value'],
          ['Score', overall.actual]
        ]);
        
        const requiredScore = overall.required;
        // Adjusted color ranges for a 0-4 scale
        const redFrom = 0;
        const redTo = requiredScore - 1;
        const yellowFrom = requiredScore - 1;
        const yellowTo = requiredScore + 0.5;
        const greenFrom = requiredScore + 0.5;
        const greenTo = 4;

        const options = {
          width: 250, height: 250,
          redFrom: redFrom, redTo: redTo,
          yellowFrom: yellowFrom, yellowTo: yellowTo,
          greenFrom: greenFrom, greenTo: greenTo,
          minorTicks: 4,
          // --- FIX: Set the maximum value and ticks to 4 ---
          max: 4,
          majorTicks: ['0', '1', '2', '3', '4']
        };

        const chart = new google.visualization.Gauge(document.getElementById('gauge-chart-div'));
        chart.draw(data, options);
    }

function renderStrengthsAndGaps(strengths, gaps) {
    const strengthsList = document.getElementById('strengths-list');
    const gapsList = document.getElementById('gaps-list');
    strengthsList.innerHTML = '';
    gapsList.innerHTML = '';

    if (strengths.length > 0) {
        strengths.forEach(item => {
            const li = document.createElement('li');
            li.className = 'flex items-center text-sm';
            li.innerHTML = `<svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg> 
                            <span class="font-semibold">${item.name}</span> <span class="ml-auto text-green-600 font-bold">+${item.gap.toFixed(2)}</span>`;
            strengthsList.appendChild(li);
        });
    } else {
        strengthsList.innerHTML = '<p class="text-gray-500 text-center">No significant strengths identified.</p>';
    }

    if (gaps.length > 0) {
        gaps.forEach(item => {
            const li = document.createElement('li');
            li.className = 'flex items-center text-sm';
            li.innerHTML = `<svg class="w-5 h-5 text-red-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17l5-5m0 0l-5-5m5 5H6"></path></svg> 
                            <span class="font-semibold">${item.name}</span> <span class="ml-auto text-red-600 font-bold">${item.gap.toFixed(2)}</span>`;
            gapsList.appendChild(li);
        });
    } else {
        gapsList.innerHTML = '<p class="text-gray-500 text-center">No significant development areas identified.</p>';
    }
}

// FINAL CORRECTED - 3-Section Layout with Deep Dive Restored
function renderRadarCharts(radarData) {

    // Helper to render one full category row
    const renderCategoryRow = (containerId, title, data) => {
        const container = document.getElementById(containerId);
        if (!container) return;

        // Hide section if no data
        if (!data || data.labels.length === 0) {
            container.style.display = 'none';
            return;
        }
        container.style.display = 'block';

        // Create Numeric Labels for the Chart (1, 2, 3...)
        const numericLabels = data.labels.map((_, i) => (i + 1).toString());

        // Build the HTML Structure
        let html = `
            <h3 class="text-xl font-bold text-slate-800 mb-6 border-b pb-2">${title}</h3>
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                
                <div class="lg:col-span-4">
                    <h4 class="font-bold text-xs text-gray-500 uppercase mb-3 tracking-wider">1. Competency List</h4>
                    <div class="border rounded-lg overflow-hidden bg-white">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-100 text-gray-600 font-bold">
                                <tr>
                                    <th class="p-3 border-b w-10 text-center">#</th>
                                    <th class="p-3 border-b">Competency Name</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                ${data.labels.map((label, i) => `
                                    <tr class="hover:bg-blue-50 transition-colors cursor-pointer" 
                                        onclick="triggerDeepDive('${label.replace(/'/g, "\\'")}')" 
                                        title="Click to Deep Dive">
                                        <td class="p-2 text-center font-bold text-slate-500 bg-gray-50 border-r">${i+1}</td>
                                        <td class="p-2 text-slate-700 font-medium">${label}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="lg:col-span-5">
                    <h4 class="font-bold text-xs text-gray-500 uppercase mb-3 tracking-wider">2. Score Analysis</h4>
                    <div class="border rounded-lg overflow-hidden bg-white">
                        <table class="w-full text-sm text-center">
                            <thead class="bg-gray-100 text-gray-600 font-bold">
                                <tr>
                                    <th class="p-3 border-b w-10">#</th>
                                    <th class="p-3 border-b text-blue-600" title="Required Score">Req</th>
                                    <th class="p-3 border-b text-red-600" title="Actual Score">Act</th>
                                    <th class="p-3 border-b text-green-600" title="Team Average">Team</th>
                                    <th class="p-3 border-b text-gray-600" title="Gap">Gap</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                ${data.labels.map((label, i) => {
                                    const req = data.required[i];
                                    const act = data.actual[i];
                                    const team = data.team[i];
                                    const gap = (act - req).toFixed(1);
                                    
                                    // Color logic: Red for negative gap, Green for positive
                                    const gapColor = gap < 0 ? 'text-red-600 font-bold bg-red-50' : 'text-green-600 font-medium';
                                    const gapSign = gap > 0 ? '+' : '';
                                    
                                    return `
                                    <tr class="hover:bg-gray-50 cursor-pointer" 
                                        onclick="triggerDeepDive('${label.replace(/'/g, "\\'")}')"
                                        title="Click to Deep Dive">
                                        <td class="p-2 font-bold text-gray-400 bg-gray-50 border-r">${i+1}</td>
                                        <td class="p-2 border-r text-slate-600">${req}</td>
                                        <td class="p-2 border-r font-bold text-slate-800">${act}</td>
                                        <td class="p-2 border-r text-green-700 font-medium">${team}</td>
                                        <td class="p-2 ${gapColor}">${gapSign}${gap}</td>
                                    </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="lg:col-span-3 flex flex-col">
                    <h4 class="font-bold text-xs text-gray-500 uppercase mb-3 tracking-wider text-center">3. Visualization</h4>
                    <div class="relative flex-grow flex items-center justify-center" style="min-height: 250px;">
                        <canvas id="chart-${containerId}"></canvas>
                    </div>
                </div>
            </div>
        `;

        container.innerHTML = html;

        // --- Render the Chart ---
        const ctx = document.getElementById(`chart-${containerId}`).getContext('2d');
        
        if (chartInstances[containerId]) {
            chartInstances[containerId].destroy();
        }

        chartInstances[containerId] = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: numericLabels, // Uses 1, 2, 3...
                datasets: [{
                    label: 'Actual',
                    data: data.actual,
                    fill: true,
                    backgroundColor: 'rgba(239, 68, 68, 0.2)',
                    borderColor: 'rgb(239, 68, 68)',
                    pointBackgroundColor: 'rgb(239, 68, 68)',
                    borderWidth: 2,
                    pointRadius: 4, // Made points slightly bigger for easier clicking
                    pointHoverRadius: 6
                }, {
                    label: 'Required',
                    data: data.required,
                    fill: true,
                    backgroundColor: 'rgba(59, 130, 246, 0.2)',
                    borderColor: 'rgb(59, 130, 246)',
                    pointBackgroundColor: 'rgb(59, 130, 246)',
                    borderWidth: 2,
                    pointRadius: 3
                }, {
                    label: 'Team Avg',
                    data: data.team,
                    fill: false,
                    borderColor: 'rgb(22, 163, 74)', // Green
                    pointBackgroundColor: 'rgb(22, 163, 74)',
                    borderWidth: 2,
                    borderDash: [4, 4],
                    pointRadius: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        position: 'bottom', 
                        labels: { boxWidth: 10, font: { size: 11 }, padding: 15 } 
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                const index = context[0].dataIndex;
                                return `${index + 1}. ${data.labels[index]}`;
                            }
                        }
                    }
                },
                scales: {
                    r: {
                        angleLines: { display: true, color: '#e5e7eb' },
                        grid: { color: '#e5e7eb' },
                        suggestedMin: 0,
                        suggestedMax: 4,
                        ticks: { display: false, stepSize: 1 },
                        pointLabels: {
                            font: { size: 12, weight: 'bold' },
                            color: '#64748b'
                        }
                    }
                },
                // --- RESTORED ONCLICK EVENT ---
                onClick: (event, elements) => {
                    if (!elements.length) return;
                    
                    const index = elements[0].index;
                    const competencyName = data.labels[index]; // Map index back to real name
                    
                    triggerDeepDive(competencyName);
                },
                onHover: (event, chartElement) => {
                    event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                }
            }
        });
    };

    // Helper to call the modal logic safely
    window.triggerDeepDive = (competencyName) => {
        const employeeId = document.getElementById('competency-employee-select').value;
        if (employeeId && competencyName) {
            openDeepDiveModal(employeeId, competencyName);
        }
    };

    // Render all 3 Categories
    renderCategoryRow('core-section', 'Core Competencies', radarData.core);
    renderCategoryRow('leadership-section', 'Leadership Competencies', radarData.leadership);
    renderCategoryRow('technical-section', 'Technical Competencies', radarData.technical);
}

function renderHistoricalChart(history) {
    const canvasId = 'historical-competency-chart';
    const canvas = document.getElementById(canvasId);
    
    // Handle empty history
    if (!history || history.datasets.length === 0 || history.datasets.every(d => d.data.length < 2)) {
         // Instead of hiding the whole container (which breaks the grid),
         // we display a "No Data" message on the canvas parent.
         const parent = canvas.parentElement;
         parent.innerHTML = '<p class="text-gray-400 text-sm text-center italic mt-10">No historical data available.</p>';
         return;
    }

    const ctx = canvas.getContext('2d');
    
    if (chartInstances[canvasId]) {
        chartInstances[canvasId].destroy();
    }

    // Colors: Blue & Red
    const colors = [
        { border: '#3b82f6', bg: 'rgba(59, 130, 246, 0.1)' }, 
        { border: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)' } 
    ];
    
    const datasets = history.datasets.map((dataset, index) => ({
        label: dataset.label,
        data: dataset.data,
        borderColor: colors[index % colors.length].border,
        backgroundColor: colors[index % colors.length].bg,
        borderWidth: 2,
        tension: 0.4,
        fill: true,
        pointRadius: 3,
        pointBackgroundColor: '#fff'
    }));

    chartInstances[canvasId] = new Chart(ctx, {
        type: 'line',
        data: {
            labels: history.labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, // Fits the container height (approx 220px)
            plugins: {
              legend: { 
                  display: true, 
                  position: 'bottom', // Move legend to bottom for narrow columns
                  labels: { boxWidth: 8, font: { size: 10 }, usePointStyle: true } 
              },
              tooltip: { mode: 'index', intersect: false }
            },
            scales: {
                x: {
                    display: true,
                    grid: { display: false },
                    ticks: { font: { size: 10 } } // Smaller font for years
                },
                y: {
                    display: true,
                    beginAtZero: false,
                    suggestedMin: 1,
                    suggestedMax: 4,
                    ticks: { stepSize: 1, display: false }, // Hide Y-axis numbers to save space
                    grid: { borderDash: [5, 5] }
                }
            }
        }
    });
}

function openDeepDiveModal(employeeId, competencyName) {
    const modal = document.getElementById('competency-deep-dive-modal');
    document.getElementById('deep-dive-modal-title').textContent = `Deep Dive: ${competencyName}`;
    modal.style.display = 'flex';
    
    // Show loader/placeholder
    document.getElementById('deep-dive-content').innerHTML = '<div class="flex justify-center items-center h-48 col-span-2"><div id="loader"></div></div>';

    google.script.run
        .withSuccessHandler(data => {
            if (data.error) {
                document.getElementById('deep-dive-content').innerHTML = `<p class="text-red-500 col-span-2">Error: ${data.error}</p>`;
                return;
            }
            
            // Restore original content structure
            document.getElementById('deep-dive-content').innerHTML = `
                <div>
                    <h3 class="text-xl font-bold text-slate-700 mb-4 text-center">Score Comparison</h3>
                    <canvas id="deep-dive-bar-chart"></canvas>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-slate-700 mb-4 text-center">Top Performers</h3>
                    <ul id="top-performers-list" class="space-y-2"></ul>
                </div>`;

            // Draw Bar Chart
            const ctx = document.getElementById('deep-dive-bar-chart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Employee', 'Team Avg', 'Company Avg'],
                    datasets: [{
                        label: 'Scores',
                        data: [data.employeeScore, data.teamAverage, data.companyAverage],
                        backgroundColor: ['#ef4444', '#f97316', '#22c55e']
                    }]
                },
                options: {
                    indexAxis: 'y',
                    scales: { x: { beginAtZero: true, max: 4 } },
                    plugins: { legend: { display: false } }
                }
            });

            // Populate Top Performers
            const list = document.getElementById('top-performers-list');
            list.innerHTML = '';
            if (data.topPerformers.length > 0) {
                data.topPerformers.forEach(performer => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-gray-50 p-2 rounded';
                    li.innerHTML = `<span class="text-sm font-medium text-gray-800">${performer.name}</span>
                                    <span class="text-sm font-bold text-blue-600">${performer.score.toFixed(2)}</span>`;
                    list.appendChild(li);
                });
            } else {
                list.innerHTML = '<p class="text-gray-500 text-center">No top performers found.</p>';
            }
        })
        .withFailureHandler(err => {
            document.getElementById('deep-dive-content').innerHTML = `<p class="text-red-500 col-span-2">An error occurred: ${err.message}</p>`;
        })
        .getCompetencyDeepDive(employeeId, competencyName);
}

function closeDeepDiveModal() {
    document.getElementById('competency-deep-dive-modal').style.display = 'none';
}

// Helper to create a category title
function buildCategory(title) {
    return `<div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm"><div class="md:col-span-2 mt-3 mb-1"><h3 class="text-lg font-bold text-slate-700 border-b pb-1">${title}</h3></div></div>`;
}

function showRequestDetails(requestId, context) {
    if (!fullEmployeeData || fullEmployeeData.length === 0) {
        alert("The main employee data is still loading. Please wait a moment and try again.");
        return;
    }

    const modal = document.getElementById('request-details-modal');
    const title = document.getElementById('request-details-modal-title');
    const body = document.getElementById('request-details-modal-body');
    const footer = document.getElementById('request-details-modal-footer');

    title.textContent = `Details for Request ID: ${requestId}`;
    body.innerHTML = '<p>Loading...</p>';
    footer.innerHTML = '';

    const requestData = (context === 'my-requests')
      ? window.allChangeRequests.myRequests.find(r => r.RequestID == requestId)
      : window.allChangeRequests.approvals.find(r => r.RequestID == requestId);

    if (!requestData) {
        body.innerHTML = '<p class="text-red-500">Could not find request details.</p>';
        modal.style.display = 'flex';
        return;
    }

    const requestType = requestData.RequestType;
    let beforeData = {};
    let afterData = {};

    let detailsHtml = `<div class="md:col-span-2">`;

    detailsHtml += `
        <div class="mb-4 pb-2 border-b border-gray-200">
            <span class="block text-xs font-bold text-gray-500 uppercase">Request Type</span>
            <span class="text-xl font-bold text-slate-800">${requestType}</span>
        </div>
        <div class="grid grid-cols-1 gap-y-1">
    `;

    const categories = {
        'EMPLOYEE DETAILS': ['employeeName', 'employeeId', 'gender', 'dateHired', 'dateOfBirth'],
        'JOB DETAILS': ['jobTitle', 'level', 'status', 'contractType', 'competency', 'jobLevel', 'payrollType', 'effectiveDate'], 
        'ORGANIZATIONAL ASSIGNMENT': ['positionId', 'division', 'group', 'department', 'section', 'managerName', 'managerEmployeeId']
    };

    const keyToLabelMap = {
        employeeName: 'Name', employeeId: 'Employee ID', gender: 'Gender', dateHired: 'Date Hired', dateOfBirth: 'Date of Birth',
        jobTitle: 'Job Title', level: 'Level', status: 'Status', contractType: 'Contract Type',
        positionId: 'Position ID', division: 'Division', group: 'Group', department: 'Department', section: 'Section',
        managerName: 'Reports To (Name)', managerEmployeeId: 'Reports To (ID)',
        competency: 'Competency', jobLevel: 'Job Level', payrollType: 'Payroll Type', effectiveDate: 'Effective Date',
        RequestID: 'Request ID', RequestorEmail: 'Requestor', SubmissionTimestamp: 'Submitted', Status: 'Status', RequestType: 'RequestType',
        ApproverEmail: 'Approver', ApprovalTimestamp: 'Approved On', ApproverComments: 'Approver Comments', ImplementerEmail: 'Implemented By',
        ImplementationTimestamp: 'Implemented On', Justification: 'Justification', EffectiveDate: 'Effective Date',
        JiraTicket: 'Jira Ticket', SupportingDocuments: 'Documents'
    };

    try {
        if (requestType.includes('Transfer') || requestType.includes('Promotion')) {
            const curPosId = String(requestData.CurrentPositionID || '').trim();
            const newPosId = String(requestData.NewPositionID || '').trim();

            const beforePos = fullEmployeeData.find(p => String(p.positionId).trim() === curPosId);
            const afterPosBase = fullEmployeeData.find(p => String(p.positionId).trim() === newPosId);
            
            beforeData = beforePos || {}; 
            afterData = { 
                ...(afterPosBase || {}), 
                employeeName: requestData.EmployeeName, 
                employeeId: requestData.EmployeeID,
                gender: requestData.Gender, 
                dateHired: requestData.DateHired, 
                dateOfBirth: requestData.DateOfBirth,
                status: requestData.RequestType, 
                effectiveDate: requestData.EffectiveDate,
                managerName: afterPosBase ? afterPosBase.managerName : '', 
                managerEmployeeId: afterPosBase ? afterPosBase.managerEmployeeId : ''
            };

        } else if (requestType.includes('replacement for vacancy')) {
            const vacPosId = String(requestData.VacantPositionID || '').trim();
            beforeData = fullEmployeeData.find(p => String(p.positionId).trim() === vacPosId) || {};
            afterData = {
                ...beforeData, status: 'FILLED VACANCY', effectiveDate: requestData.EffectiveDate,
                employeeName: requestData.NewEmployeeName, 
                employeeId: requestData.NewEmployeeID, 
                gender: '', dateHired: '', dateOfBirth: ''
            };

        } else if (requestType.includes('newly created position')) {
            beforeData = {}; 
            afterData = {
                ...requestData, 
                positionId: 'TBD (New)', status: 'VACANT', 
                jobTitle: requestData.NewJobTitle, level: requestData.NewLevel,
                managerName: requestData.ReportingTo, managerEmployeeId: requestData.ReportingToId,
                employeeName: '', employeeId: '', gender: '', dateHired: '', dateOfBirth: ''
            };
        
        } else if (requestType.includes('Resignation') || requestType.includes('Separation')) {
            const empId = String(requestData.EmployeeID || '').trim();
            beforeData = fullEmployeeData.find(p => String(p.employeeId).trim() === empId) || {};
            afterData = { ...beforeData, status: 'RESIGNED', effectiveDate: requestData.EffectiveDate };
        
        } else if (requestType.includes('Employment Status') || requestType.includes('Regularization')) {
            const empId = String(requestData.EmployeeID || '').trim();
            beforeData = fullEmployeeData.find(p => String(p.employeeId).trim() === empId) || {};
            const newStatus = requestType.includes('Regularization') ? 'REGULAR' : requestData.NewStatus;
            afterData = { ...beforeData, status: newStatus, effectiveDate: requestData.EffectiveDate };
        
        } else if (requestType.includes('Reporting line')) {
            const empId = String(requestData.EmployeeID || '').trim();
            beforeData = fullEmployeeData.find(p => String(p.employeeId).trim() === empId) || {};
            afterData = { ...beforeData, managerName: requestData.NewReportingToName, effectiveDate: requestData.EffectiveDate };
        
        } else if (requestType.includes('Job Title')) {
            const empId = String(requestData.EmployeeID || '').trim();
            beforeData = fullEmployeeData.find(p => String(p.employeeId).trim() === empId) || {};
            afterData = { ...beforeData, jobTitle: requestData.NewJobTitle, effectiveDate: requestData.EffectiveDate };
        
        } else if (requestType.includes('Name Correction')) {
            const empId = String(requestData.EmployeeID || '').trim();
            beforeData = fullEmployeeData.find(p => String(p.employeeId).trim() === empId) || {};
            const newName = requestData.NewName || requestData.NewEmployeeName;
            afterData = { ...beforeData, employeeName: newName };
        
        } else if (requestType.includes('Position on Hold') || requestType.includes('Cancelled') || requestType.includes('Deleted')) {
            const targetPosId = String(requestData.CurrentPositionID || requestData.PositionID || '').trim();
            const foundPos = fullEmployeeData.find(p => String(p.positionId).trim() === targetPosId);
            beforeData = foundPos || {};
            afterData = { ...beforeData, status: requestData.Action };
        }

    } catch (e) {
        console.error(e);
        body.innerHTML = `<p class="text-red-500">Error preparing comparison: ${e.message}</p>`;
        footer.innerHTML = `<button onclick="closeRequestDetailsModal()" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Close</button>`;
        modal.style.display = 'flex';
        return;
    }

    for (const [category, keys] of Object.entries(categories)) {
        let categoryHtml = '';
        if (category === 'EMPLOYEE DETAILS' && !(requestType.includes('Transfer') || requestType.includes('Promotion') || requestType.includes('Name') || requestType.includes('replacement'))) {
            continue;
        }
        for (const key of keys) {
            const dataKey = key; 
            let beforeStr = (beforeData[dataKey] === null || typeof beforeData[dataKey] === 'undefined') ? '' : String(beforeData[dataKey]);
            let afterStr = (afterData[dataKey] === null || typeof afterData[dataKey] === 'undefined') ? '' : String(afterData[dataKey]);
            
            if (key.toLowerCase().includes('date') && beforeStr) beforeStr = new Date(beforeStr).toLocaleDateString();
            if (key.toLowerCase().includes('date') && afterStr) afterStr = new Date(afterStr).toLocaleDateString();

            if (beforeStr || afterStr || (beforeStr !== afterStr)) {
                const label = keyToLabelMap[key] || key;
                const before = beforeStr || '<i class="text-gray-400">N/A</i>';
                const after = afterStr || '<i class="text-gray-400">N/A</i>';
                let afterClass = 'text-gray-800 text-left whitespace-nowrap';
                
                if (beforeStr !== afterStr) {
                    afterClass = 'text-blue-600 font-bold bg-blue-100 px-1 rounded text-left whitespace-nowrap';
                }
                
                categoryHtml += `
                    <div class="font-semibold text-gray-600 text-left py-2">${label}:</div>
                    <div class="text-gray-500 text-left py-2 whitespace-nowrap">${before}</div>
                    <div class="${afterClass} py-2">${after}</div>
                `;
            }
        }
        
        if (categoryHtml) {
            detailsHtml += buildCategory(category);
            detailsHtml += `
                <div class="grid grid-cols-[160px,1fr,1fr] gap-x-4">
                    <div class="py-2"></div>
                    <div class="font-bold text-gray-800 text-left py-2">Before</div>
                    <div class="font-bold text-gray-800 text-left py-2">After</div>
                    ${categoryHtml}
                </div>
            `;
        }
    }
    
    detailsHtml += buildCategory('ADDITIONAL DETAILS');
    const requestFields = ['RequestID', 'RequestorEmail', 'SubmissionTimestamp', 'ApproverEmail', 'ApprovalTimestamp', 'ImplementerEmail', 'ImplementationTimestamp', 'Justification', 'ApproverComments', 'JiraTicket', 'SupportingDocuments'];
    
    requestFields.forEach(key => {
        if (requestData.hasOwnProperty(key) && requestData[key]) {
            let value = requestData[key];
            if (key === 'SupportingDocuments') {
                value = `<button onclick="openDocumentViewer('${requestData.RequestID}')" class="text-blue-600 hover:underline">View Documents</button>`;
            } else if (key.includes('Timestamp') && value) {
                value = new Date(value).toLocaleDateString() + ' ' + new Date(value).toLocaleTimeString();
            }
            
            detailsHtml += `
                <div class="grid grid-cols-[160px,1fr] gap-x-4 items-start py-2">
                    <div class="font-semibold text-gray-600 text-left">${keyToLabelMap[key] || key}:</div>
                    <div class="text-gray-800">${value}</div>
                </div>
            `;
        }
    });

    if (requestData.AuditTrail) {
        detailsHtml += buildCategory('AUDIT TRAIL / HISTORY');
        const logs = requestData.AuditTrail.split('\n').filter(line => line.trim() !== '');
        
        let logHtml = '<div class="space-y-2 bg-gray-50 p-3 rounded border">';
        logs.forEach(log => {
            let colorClass = 'text-gray-600';
            if(log.includes('RETURNED')) colorClass = 'text-yellow-700 font-bold';
            if(log.includes('REJECTED')) colorClass = 'text-red-700 font-bold';
            if(log.includes('APPROVED')) colorClass = 'text-green-700 font-bold';
            if(log.includes('RESUBMITTED')) colorClass = 'text-blue-700 font-bold';
            
            logHtml += `<div class="text-xs ${colorClass} border-b border-gray-200 pb-1 last:border-0">${log}</div>`;
        });
        logHtml += '</div>';
        
        detailsHtml += logHtml;
    }

    detailsHtml += `</div></div>`;
    body.innerHTML = detailsHtml;

    footer.innerHTML = `<button onclick="closeRequestDetailsModal()" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Close</button>`;
    let actionButtons = '';
    if (['Pending', 'Approved', 'Implemented'].includes(requestData.Status)) {
      actionButtons += `<button onclick="openPreviewModal('${requestId}')" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Preview Change</button>`;
    }
    if (context === 'approvals') {
      if (requestData.Status === 'Pending') {
        actionButtons += `
          <button onclick="handleApprovalAction('${requestId}', 'Approved')" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Approve</button>
          <button onclick="handleApprovalAction('${requestId}', 'Rejected')" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Reject</button>
          <button onclick="handleApprovalAction('${requestId}', 'Returned')" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">Return</button>
        `;
      } else if (requestData.Status === 'Approved' && userCanApprove && requestData.RequestType !== 'Hiring of a new employee (replacement for vacancy)') {
           actionButtons += `<button onclick="handleImplementAction('${requestId}')" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Implement Change</button>`;
      }
    }
    
    footer.innerHTML = actionButtons + footer.innerHTML;
    modal.style.display = 'flex';
}

function closeRequestDetailsModal() {
  document.getElementById('request-details-modal').style.display = 'none';
}

function renderMyRequestsTable() {
    const requests = window.allChangeRequests ? window.allChangeRequests.myRequests : [];
    const table = $('#my-requests-table');
    if ($.fn.DataTable.isDataTable(table)) {
        table.DataTable().destroy();
    }
    table.empty();

    if (!requests || requests.length === 0) {
        table.html('<thead><tr><th>Info</th></tr></thead><tbody><tr><td>No requests found.</td></tr></tbody>');
        return;
    }

    table.DataTable({
        data: requests,
        columns: [
            { title: 'Request ID', data: 'RequestID', render: function(data, type, row) {
                return `<span class="text-blue-600 hover:underline cursor-pointer" onclick="showRequestDetails('${row.RequestID}', 'my-requests')">${data}</span>`;
              }
            },
            { title: 'Requestor', data: 'RequestorEmail' },
            { title: 'Type of Request', data: 'RequestType' },
            { title: 'Status', data: 'Status', render: function(data, type, row) {
                let color = 'text-gray-600';
                if(data === 'Approved') color = 'text-green-600 font-bold';
                if(data === 'Rejected') color = 'text-red-600 font-bold';
                if(data === 'Returned') color = 'text-yellow-600 font-bold';
                return `<span class="${color}">${data}</span>`;
            }},
            { title: 'Action', data: null, render: function(data, type, row) {
                if (row.Status === 'Returned') {
                    return `<button onclick="editChangeRequest('${row.RequestID}')" class="px-2 py-1 bg-yellow-500 text-white text-xs rounded hover:bg-yellow-600 shadow">Edit</button>`;
                }
                return '';
            }}
        ],
        responsive: false,
        scrollX: true,
        dom: 'Bfrtip',
        buttons: ['colvis']
    });
}

function editChangeRequest(requestId) {
    const request = window.allChangeRequests.myRequests.find(r => r.RequestID === requestId);
    if (!request) { alert("Request data not found."); return; }

    // 1. Open Modal
    document.getElementById('request-modal').style.display = 'flex';

    // --- FIX: LOAD APPROVERS IMMEDIATELY ---
    const approverSelect = document.getElementById('approver-email-select');
    approverSelect.innerHTML = '<option value="">Loading approvers...</option>';
    
    google.script.run
        .withSuccessHandler(approvers => {
            approverSelect.innerHTML = '<option value="">-- Select an Approver --</option>';
            if (approvers && approvers.length > 0) {
                approvers.forEach(approver => {
                    const option = document.createElement('option');
                    option.value = approver.email;
                    option.textContent = approver.email;
                    approverSelect.appendChild(option);
                });
                
                // Set the previously selected approver if available
                if (request.ApproverEmail) {
                    approverSelect.value = request.ApproverEmail;
                }
            } else {
                approverSelect.innerHTML = '<option value="">No approvers found (Check Permissions Sheet)</option>';
            }
        })
        .withFailureHandler(err => {
            approverSelect.innerHTML = `<option value="">Error loading approvers</option>`;
            console.error("Failed to load approvers:", err);
        })
        .getApproverList();

    // 2. Set Request Type and Trigger Change to build HTML
    const typeSelect = document.getElementById('request-type');
    typeSelect.value = request.RequestType;
    handleRequestTypeChange(); // Build fields

    // 3. Populate Fields (Delayed to ensure DOM is ready)
    setTimeout(() => {
        // --- FIX: RE-FETCH LIVE EMPLOYEE DATA ---
        let liveEmpData = {};
        if (request.EmployeeID) {
             const foundEmp = fullEmployeeData.find(e => String(e.employeeId).trim() === String(request.EmployeeID).trim());
             if (foundEmp) liveEmpData = foundEmp;
        }

        const map = {
            'justification': request.Justification,
            'effective-date-request': request.EffectiveDate ? new Date(request.EffectiveDate).toISOString().split('T')[0] : '',
            
            'request-EmployeeID': request.EmployeeID,
            'request-DateHired': request.DateHired ? new Date(request.DateHired).toISOString().split('T')[0] : (liveEmpData.dateHired || ''),
            'request-DateOfBirth': request.DateOfBirth ? new Date(request.DateOfBirth).toISOString().split('T')[0] : (liveEmpData.dateOfBirth || ''),
            'request-Gender': request.Gender || liveEmpData.gender,

            'request-Division': request.Division || liveEmpData.division,
            'request-Group': request.Group || liveEmpData.group,
            'request-Department': request.Department || liveEmpData.department,
            'request-Section': request.Section || liveEmpData.section,
            'request-JobTitle': request.JobTitle || liveEmpData.jobTitle,
            'request-Level': request.Level || liveEmpData.level,
            'request-JobLevel': request.JobLevel || liveEmpData.jobLevel,
            'request-ContractType': request.ContractType || liveEmpData.contractType,

            'current-position-id': request.CurrentPositionID || liveEmpData.positionId,
            'current-reporting-to': request.CurrentReportingTo || liveEmpData.managerName,
            'current-job-title': request.CurrentJobTitle || liveEmpData.jobTitle,
            'current-name': request.EmployeeName || liveEmpData.employeeName,
            'reporting-to-id-request': request.ReportingToId,
            'request-NewReportingTo': request.NewReportingTo,
            'request-NewReportingToId': request.NewReportingToId,
            'request-job-title': request.NewJobTitle,
            'request-reporting-to': request.ReportingTo,
            'request-reporting-to-id': request.ReportingToId
        };

        for (const [id, val] of Object.entries(map)) {
            const el = document.getElementById(id);
            if(el) el.value = val || '';
        }

        const setDrop = (id, val) => {
            const container = document.getElementById(id);
            if (container) {
                const input = container.querySelector('.searchable-dropdown-input');
                if(input) input.value = val || '';
                if (val && id.startsWith('req-filter')) container.removeAttribute('data-empty');
            }
        };

        setDrop('req-filter-employee', request.EmployeeName || liveEmpData.employeeName);
        setDrop('req-filter-division', request.Division || liveEmpData.division);
        setDrop('req-filter-group', request.Group || liveEmpData.group);
        setDrop('req-filter-department', request.Department || liveEmpData.department);
        setDrop('req-filter-section', request.Section || liveEmpData.section);

        setDrop('new-position-dropdown', request.NewPositionID);
        setDrop('new-job-title-dropdown', request.NewJobTitle);
        setDrop('vacant-position-dropdown', request.VacantPositionID);
        setDrop('new-status-dropdown', request.NewStatus);
        setDrop('position-id-dropdown', request.CurrentPositionID || request.PositionID);
        setDrop('new-reporting-to-dropdown', request.NewReportingToName);
        setDrop('reason-leaving-request-dropdown', request.ReasonForLeaving);

        setDrop('request-division-dropdown', request.Division);
        setDrop('request-group-dropdown', request.Group);
        setDrop('request-department-dropdown', request.Department);
        setDrop('request-section-dropdown', request.Section);

        const actionSelect = document.querySelector('select[name="Action"]');
        if(actionSelect && request.Action) actionSelect.value = request.Action;

        // Handle Files
        const oldMsg = document.getElementById('existing-docs-msg');
        if(oldMsg) oldMsg.remove();

        const form = document.getElementById('request-form');
        if (request.SupportingDocuments && request.SupportingDocuments !== '') {
            form.dataset.hasAttachments = 'true';
            const attachContainer = document.querySelector('.attachment-group');
            if(attachContainer) {
                const msg = document.createElement('div');
                msg.id = 'existing-docs-msg';
                msg.className = 'text-xs text-green-600 font-bold mt-2 p-2 bg-green-50 border border-green-200 rounded';
                msg.innerHTML = ` Previous documents attached. <span onclick="openDocumentViewer('${request.RequestID}')" class="underline text-blue-600 cursor-pointer">View</span>`;
                attachContainer.parentNode.insertBefore(msg, attachContainer.nextSibling);
            }
        } else {
            form.dataset.hasAttachments = 'false';
        }

        let hiddenId = document.getElementById('edit-request-id');
        if(!hiddenId) {
            hiddenId = document.createElement('input');
            hiddenId.type = 'hidden';
            hiddenId.id = 'edit-request-id';
            document.getElementById('request-form').appendChild(hiddenId);
        }
        hiddenId.value = requestId;

        const submitBtn = document.querySelector('#request-form button[onclick="submitRequest()"]');
        if (submitBtn) {
            submitBtn.textContent = "Resubmit Request";
            submitBtn.classList.remove('bg-blue-600');
            submitBtn.classList.add('bg-yellow-600');
        }

    }, 200);
}

function renderApprovalsTable() {
    const requests = window.allChangeRequests ? window.allChangeRequests.approvals : [];
    const table = $('#approvals-table');
    if ($.fn.DataTable.isDataTable(table)) {
        table.DataTable().destroy();
    }
    table.empty();

    if (!requests || requests.length === 0) {
        table.html('<thead><tr><th>Info</th></tr></thead><tbody><tr><td>No requests found.</td></tr></tbody>');
        return;
    }

    table.DataTable({
        data: requests,
        columns: [
            { title: 'Request ID', data: 'RequestID', render: function(data, type, row) {
                return `<span class="text-blue-600 hover:underline cursor-pointer" onclick="showRequestDetails('${row.RequestID}', 'approvals')">${data}</span>`;
              }
            },
            { title: 'Requestor', data: 'RequestorEmail' },
            { title: 'Type of Request', data: 'RequestType' },
            { title: 'Status', data: 'Status' },
            {
              title: 'Documents',
              data: 'SupportingDocuments',
              render: function(data, type, row) {
                if (row.SupportingDocuments) {
                  return `<button onclick="openDocumentViewer('${row.RequestID}')" class="px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">View</button>`;
                }
                return 'N/A';
              },
              className: 'text-center'
            }
        ],
        responsive: false,
        scrollX: true,
        dom: 'Bfrtip',
        buttons: ['colvis']
    });
}

function loadChangeRequestData(callback) {
    showSavingOverlay('Loading Change Requests...');
    google.script.run
        .withSuccessHandler(data => {
            hideSavingOverlay();
            // ROBUSTNESS FIX: Handle cases where data is already an object or a string
            if (typeof data === 'string') {
              window.allChangeRequests = JSON.parse(data);
            } else {
              window.allChangeRequests = data;
            }
            // changeRequestsDataLoaded = true; // This line is now removed
            if (callback) callback();
        })
        .withFailureHandler(err => {
            hideSavingOverlay();
            $('#my-requests-table').html(`<thead><tr><th>Error</th></tr></thead><tbody><tr><td>Error loading requests: ${err.message}.</td></tr></tbody>`);
            $('#approvals-table').html(`<thead><tr><th>Error</th></tr></thead><tbody><tr><td>Error loading approvals: ${err.message}.</td></tr></tbody>`);
        })
        .getChangeRequests();
}

function refreshChangeRequestData() {
  // changeRequestsDataLoaded = false; // Invalidate the cache - This line is now removed
  
  // Determine which tab is currently active to decide which table to redraw
  const myRequestsTabActive = document.getElementById('my-requests-view').classList.contains('active');
  const approvalsTabActive = document.getElementById('approvals-view').classList.contains('active');

  if (myRequestsTabActive) {
    loadChangeRequestData(renderMyRequestsTable);
  } else if (approvalsTabActive) {
    loadChangeRequestData(renderApprovalsTable);
  }
  
  // Also refresh the notification badges
  google.script.run.withSuccessHandler(updateNotificationBadges).getRequestCounts();
}

function handleApprovalAction(requestId, action) {
  // If action is "Returned", use the new Modal flow
  if (action === 'Returned') {
      openReturnModal(requestId);
      return; 
  }

  // Existing logic for Approve/Reject
  let comments = '';
  if (action === 'Rejected') {
    comments = prompt(`Comments are required for this action (${action}):`);
    if (comments === null) return;
    if (!comments.trim()) {
      alert('You must provide comments to ' + action.toLowerCase() + ' a request.');
      return;
    }
  } else {
    comments = prompt(`Please provide optional comments for this action (${action}):`);
    if (comments === null) return;
  }
  
  processActionBackend(requestId, action, comments);
}

// Helper to call backend (refactored to avoid code duplication)
function processActionBackend(requestId, action, comments) {
  showSavingOverlay('Processing Action...');
  google.script.run
    .withSuccessHandler(response => {
      hideSavingOverlay();
      alert(response);
      closeRequestDetailsModal();
      closeReturnModal(); // Ensure return modal is closed if open
      refreshChangeRequestData(); // Refresh tables
    })
    .withFailureHandler(err => {
      hideSavingOverlay();
      alert('Error: ' + err.message);
    })
    .processRequestAction(requestId, action, comments);
}

// --- RETURN MODAL LOGIC START ---

// Global variable to store the ID of the request currently being returned
let currentReturnRequestId = null;

function openReturnModal(requestId) {
    currentReturnRequestId = requestId;
    const container = document.getElementById('return-checklist-container');
    container.innerHTML = '';
    
    // Define standard fields to check
    const fieldsToCheck = [
        { id: 'chk-effective', label: 'Effective Date' },
        { id: 'chk-employee', label: 'Employee Details (Name/ID)' },
        { id: 'chk-position', label: 'Position / Job Details' },
        { id: 'chk-justification', label: 'Justification' },
        { id: 'chk-documents', label: 'Attachments / Documents' },
        { id: 'chk-reason', label: 'Reason for Leaving' },
        { id: 'chk-other', label: 'Other' }
    ];

    fieldsToCheck.forEach(field => {
        const item = document.createElement('div');
        item.className = "bg-gray-50 p-2 rounded border border-gray-200";
        item.innerHTML = `
            <div class="flex items-center">
                <input type="checkbox" id="${field.id}" class="h-4 w-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500 cursor-pointer" onchange="toggleCommentBox('${field.id}')">
                <label for="${field.id}" class="ml-2 block text-sm font-medium text-gray-700 cursor-pointer select-none">${field.label}</label>
            </div>
            <input type="text" id="${field.id}-comment" class="mt-2 w-full p-1 text-sm border-b border-gray-300 bg-transparent focus:outline-none focus:border-blue-500" placeholder="Specify error (e.g., Wrong date)..." style="display:none;">
        `;
        container.appendChild(item);
    });

    document.getElementById('return-general-comment').value = '';
    document.getElementById('return-modal').style.display = 'flex';
}

function toggleCommentBox(checkboxId) {
    const checkbox = document.getElementById(checkboxId);
    const commentBox = document.getElementById(checkboxId + '-comment');
    if (checkbox.checked) {
        commentBox.style.display = 'block';
        commentBox.focus();
    } else {
        commentBox.style.display = 'none';
        commentBox.value = '';
    }
}

function closeReturnModal() {
    document.getElementById('return-modal').style.display = 'none';
    currentReturnRequestId = null;
}

function submitReturnDecision() {
    if (!currentReturnRequestId) return;

    // 1. Gather checked items
    const checkboxes = document.querySelectorAll('#return-checklist-container input[type="checkbox"]:checked');
    // Allow return if EITHER a checkbox is checked OR a general comment is written
    const generalComment = document.getElementById('return-general-comment').value.trim();
    
    if (checkboxes.length === 0 && !generalComment) {
        alert("Please select at least one field or provide a general comment.");
        return;
    }

    let structuredComments = [];
    
    checkboxes.forEach(cb => {
        const label = cb.nextElementSibling.textContent;
        const commentInput = document.getElementById(cb.id + '-comment');
        const specificComment = commentInput.value.trim() ? `: ${commentInput.value.trim()}` : '';
        structuredComments.push(`[${label}${specificComment}]`);
    });

    if (generalComment) {
        structuredComments.push(`Note: ${generalComment}`);
    }

    // 3. Combine into final string
    const finalCommentString = structuredComments.join('\n');

    // 4. Send to Backend using the helper function
    processActionBackend(currentReturnRequestId, 'Returned', finalCommentString);
}

// --- RETURN MODAL LOGIC END ---

function handleImplementAction(requestId) {
  if (!confirm('Are you sure you want to implement this change? This will permanently alter the main org chart.')) {
    return;
  }
  
  showSavingOverlay('Implementing Change...');
  google.script.run
    .withSuccessHandler(function(response) {
      hideSavingOverlay();
      // NEW: Check for the 'success' property in the response object
      if (response && response.success) {
        alert(response.message);
        closeRequestDetailsModal();
        
        // Full data refresh for the main org chart
        fetchData(); 
        
        // Force a refresh of the request list to show the "Implemented" status
        // changeRequestsDataLoaded = false; // This line is now removed
        loadChangeRequestData(renderApprovalsTable);

        // Also refresh the notification badges
        google.script.run.withSuccessHandler(updateNotificationBadges).getRequestCounts();
      } else {
        // If the backend returns a structured error, display it. Otherwise, show a generic failure message.
        alert('Implementation Failed: ' (response ? response.error : 'An unknown error occurred on the server.'));
      }
    })
    .withFailureHandler(err => {
      hideSavingOverlay();
      alert('A critical client-side error occurred: ' + err.message);
    })
    .implementApprovedChange(requestId);
}

function updateRequestLocationDropdowns(level, selectedValue) {
  // Get current values from all relevant dropdowns to build the filter chain
  const selectedDivision = document.querySelector('#request-division-dropdown .searchable-dropdown-input').value;
  const selectedGroup = document.querySelector('#request-group-dropdown .searchable-dropdown-input').value;

  if (level === 'division') {
    // When a division is selected, filter groups based on it.
    const filteredGroups = [...new Set(fullEmployeeData
        .filter(e => e.division === selectedValue)
        .map(e => e.group).filter(String))].sort();
    createSearchableDropdown('request-group-dropdown', filteredGroups, null, null, (sel) => updateRequestLocationDropdowns('group', sel));
    
    // Reset Department and Section dropdowns
    createSearchableDropdown('request-department-dropdown', [], null, null, (sel) => updateRequestLocationDropdowns('department', sel));
    createSearchableDropdown('request-section-dropdown', [], null, null, null);

  } else if (level === 'group') {
    // When a group is selected, filter departments based on BOTH the selected division AND the new group.
    const filteredDepartments = [...new Set(fullEmployeeData
        .filter(e => e.division === selectedDivision && e.group === selectedValue)
        .map(e => e.department).filter(String))].sort();
    createSearchableDropdown('request-department-dropdown', filteredDepartments, null, null, (sel) => updateRequestLocationDropdowns('department', sel));
    
    // Reset Section dropdown
    createSearchableDropdown('request-section-dropdown', [], null, null, null);

  } else if (level === 'department') {
    // When a department is selected, filter sections based on division, group, AND department.
    const filteredSections = [...new Set(fullEmployeeData
        .filter(e => e.division === selectedDivision && e.group === selectedGroup && e.department === selectedValue)
        .map(e => e.section).filter(String))].sort();
    createSearchableDropdown('request-section-dropdown', filteredSections, null, null, null);
  }
}

function handleFileUpload(event) {
  const files = event.target.files;
  const list = document.getElementById('support-docs-list');
  const warning = document.getElementById('file-limit-warning');
  list.innerHTML = '';

  if (files.length > 5) {
    warning.style.display = 'block';
    event.target.value = ''; // Clear the selected files
    return;
  }
  
  warning.style.display = 'none';

  if (files.length > 0) {
    const fileNames = Array.from(files).map(file => `<li>${escapeHtml(file.name)}</li>`).join('');
    list.innerHTML = `<strong>Selected files:</strong><ul class="list-disc list-inside mt-1">${fileNames}</ul>`;
  }
}

function escapeHtml(unsafe) {
    return unsafe
         .replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;")
         .replace(/'/g, "&#039;");
}

// --- NEW FUNCTIONS for PREVIEW ---

function openPreviewModal(requestId) {
    const modal = document.getElementById('preview-modal');
    const loader = document.getElementById('preview-loader-container');
    const chartDiv = document.getElementById('preview_chart_div');
    const descP = document.getElementById('preview-change-description');

    document.getElementById('preview-modal-title').textContent = `Preview Request: ${requestId}`;
    descP.textContent = 'Loading details...';
    chartDiv.innerHTML = ''; // Clear previous chart
    loader.style.display = 'flex';
    modal.style.display = 'flex';
    currentPreviewZoom = 1.0; // Reset zoom
    zoomPreview(0); // Apply reset zoom

    google.script.run
        .withSuccessHandler(previewResult => {
            // --- MODIFIED ERROR HANDLING ---
            if (!previewResult || (!previewResult.chartData && !previewResult.error)) {
                chartDiv.innerHTML = '<p class="text-red-500 p-4 font-bold text-center">Error: Received invalid data structure from server.</p>';
                loader.style.display = 'none';
                descP.textContent = 'Error loading preview.';
                return;
            }
            // If the backend sent a specific error message, display it
            if (previewResult.error) {
                chartDiv.innerHTML = `<p class="text-red-500 p-4 font-bold text-center">Backend Error: ${previewResult.error}</p>`;
                loader.style.display = 'none';
                descP.textContent = 'Error loading preview.';
                return;
            }
            // --- END MODIFIED ERROR HANDLING ---
            previewHighlightIds = previewResult.highlightIds || [];
            previewChangeDescription = previewResult.changeDescription || 'Previewing Change';
            descP.textContent = previewChangeDescription;
            drawPreviewChart(previewResult.chartData); // Pass the chartData array
            loader.style.display = 'none';
        })
        .withFailureHandler(error => {
            chartDiv.innerHTML = `<p class="text-red-500 p-4 font-bold text-center">Error generating preview: ${error.message}</p>`;
            loader.style.display = 'none';
            descP.textContent = 'Error loading preview.';
        })
        .getPreviewOrgChartData(requestId);
}

function closePreviewModal() {
    document.getElementById('preview-modal').style.display = 'none';
    document.getElementById('preview_chart_div').innerHTML = ''; // Clear chart
    previewChart = null; // Release chart object if necessary
    previewDataTable = null;
    previewHighlightIds = [];
    previewChangeDescription = '';
}

// --- NEW DOCUMENT VIEWER FUNCTIONS ---

/**
 * Initiates the process of viewing documents for a request.
 * Calls the backend to get a list of files.
 */
function openDocumentViewer(requestId) {
    const modal = document.getElementById('jd-modal');
    const title = document.getElementById('jd-modal-title');
    const contentArea = document.getElementById('jd-content-area');

    title.textContent = `Documents for Request ${requestId}`;
    contentArea.innerHTML = '<div class="flex justify-center items-center h-full"><div id="loader"></div><p class="ml-4">Finding documents...</p></div>';
    modal.style.display = 'flex';

    google.script.run
        .withSuccessHandler(fileList => {
            if (fileList.error) {
                contentArea.innerHTML = `<p class="text-red-500 text-center font-bold">Error: ${fileList.error}</p>`;
                return;
            }

            if (fileList.length === 0) {
                contentArea.innerHTML = '<p class="text-center text-gray-600 font-bold">No documents are attached to this request.</p>';
            } else if (fileList.length === 1) {
                showDocumentInViewer(fileList[0].url);
            } else {
                let buttonsHtml = '<p class="mb-4">Please select a document to view:</p><div class="flex flex-col space-y-2">';
                fileList.forEach(file => {
                    const escapedUrl = encodeURIComponent(file.url); // Use encodeURIComponent
                    const originalName = file.name;
                    let displayName = `<div class="text-left w-full">${escapeHtml(originalName)}</div>`;
                    
                    // Use decodeURIComponent in the onclick to get the URL back
                    buttonsHtml += `<button onclick="showDocumentInViewer(decodeURIComponent('${escapedUrl}'))" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 flex justify-start items-center">${displayName}</button>`;
                });
                buttonsHtml += '</div>';
                contentArea.innerHTML = buttonsHtml;
            }
        })
        .withFailureHandler(err => {
            contentArea.innerHTML = `<p class="text-red-500 text-center font-bold">Failed to retrieve documents. Error: ${err.message}</p>`;
        })
        .getRequestDocumentList(requestId);
}

function showDocumentInViewer(url) {
    const contentArea = document.getElementById('jd-content-area');
    // Convert /view to /preview for embedding if possible, but keep original for button
    let embedUrl = url;
    if (url.includes('/view')) {
        embedUrl = url.replace('/view', '/preview');
    }

    if (url && url.startsWith('http')) {
        contentArea.innerHTML = `
            <div class="flex justify-end mb-2">
                <a href="${url}" target="_blank" class="px-3 py-1 bg-gray-600 text-white text-xs rounded hover:bg-gray-700">Open in New Tab</a>
            </div>
            <iframe src="${embedUrl}" style="width:100%; height:60vh; border:none;"></iframe>
        `;
    } else {
        contentArea.innerHTML = '<p class="text-center text-red-600 font-bold">Invalid document URL provided.</p>';
    }
}

/**
 * Renders the selected document in the iframe viewer.
 */
function showDocumentInViewer(url) {
    const contentArea = document.getElementById('jd-content-area');
    if (url && url.startsWith('http')) {
        contentArea.innerHTML = `<iframe src="${url}" style="width:100%; height:60vh; border:none;"></iframe>`;
    } else {
        contentArea.innerHTML = '<p class="text-center text-red-600 font-bold">Invalid document URL provided.</p>';
    }
}
// --- END NEW FUNCTIONS ---

function zoomPreview(amount) {
    currentPreviewZoom = Math.max(0.2, currentPreviewZoom + amount);
    document.getElementById('preview_chart_div').style.transform = 'scale(' + currentPreviewZoom + ')';
}

/**
 * Draws the org chart specifically for the preview modal.
 * Includes highlighting logic.
 * @param {Array<Object>} previewDataArray Array of employee/position objects for the preview.
 */
function drawPreviewChart(previewDataArray) {
    var chartDiv = document.getElementById('preview_chart_div');
    if (!previewDataArray || previewDataArray.length === 0) {
        chartDiv.innerHTML = '<p class="text-center text-gray-500 pt-10">No data to display for preview.</p>';
        return;
    }

    // --- MAJOR FIX: Create a temporary, local employeeMap for this preview ---
    const previewEmployeeMap = new Map(previewDataArray.map(emp => [emp.nodeId, emp]));

    // This is a modified version of getChartData that accepts the local map
    const getPreviewChartData = (filteredData, localMap) => {
        var finalSet = new Set(filteredData);
        var positionsToProcess = Array.from(finalSet);
        positionsToProcess.forEach(function(pos) {
            var current = pos;
            var path = new Set();
            while (current && current.managerId) {
                if (path.has(current.managerId)) {
                    console.error('Circular reference detected in preview for:', pos.positionId);
                    break;
                }
                path.add(current.managerId);
                var manager = localMap.get(current.managerId);
                if (manager && !finalSet.has(manager)) {
                    finalSet.add(manager);
                    current = manager;
                } else {
                    break;
                }
            }
        });
        return Array.from(finalSet);
    };
    
    // Use the local map to build the complete hierarchy
    var chartDataForDisplay = getPreviewChartData(previewDataArray, previewEmployeeMap);

    if (chartDataForDisplay.length === 0) {
        chartDiv.innerHTML = '<p class="text-center text-gray-500 pt-10">Chart rendering error: No root node found in preview data.</p>';
        return;
    }

    previewDataTable = new google.visualization.DataTable();
    previewDataTable.addColumn('string', 'Node ID');
    previewDataTable.addColumn('string', 'Reporting to ID');

    chartDataForDisplay.forEach(function(emp) {
        let nodeHtml;
        const isHighlighted = emp.isPreviewChange || false;
        const changeType = emp.changeType || '';
        let highlightClass = '';
        let labelHtml = '';

        if (isHighlighted) {
            const isVacated = (changeType || '').toUpperCase().startsWith('VACATED');
            highlightClass = isVacated ? 'preview-vacated' : 'preview-highlight';
            const labelText = changeType || 'CHANGED'; // Use the full string from the backend
            const labelColor = isVacated ? '#ef4444' : '#f59e0b';
            labelHtml = `<div class="preview-label" style="background-color: ${labelColor};">${labelText}</div>`;
        }
        
        const isInactive = (emp.positionstatus || '').toUpperCase() === 'INACTIVE';
        let inactiveOverlayHtml = isInactive ? '<div class="inactive-overlay">INACTIVE</div>' : '';

        if (emp.employeeid) {
            const photoUrl = emp.gender && emp.gender.toLowerCase() === 'female' ? 'https://i.imgur.com/dTvdfy0.png' : 'https://i.imgur.com/bIbZ89x.png';
            const deptSection = emp.section ? `${emp.department || ''} (${emp.section})` : (emp.department || '');
            const levelClass = `level-${emp.level || 'default'}`;
            
            nodeHtml = `<div class="node-card ${levelClass}-border ${levelClass}-bg ${highlightClass}">
                            ${labelHtml}
                            ${inactiveOverlayHtml}
                            <img src="${photoUrl}" onerror="this.onerror=null;this.src='https://i.imgur.com/RHvayzz.png';">
                            <div class="node-text">
                              <div class="name">${emp.employeename || 'N/A'}</div>
                              <div class="title">${emp.jobtitle || 'N/A'}</div>
                              <div class="dept">${deptSection}</div>
                            </div>
                          </div>`;
        } else {
            nodeHtml = `<div class="vacant-card ${highlightClass}">
                            ${labelHtml}
                            ${inactiveOverlayHtml}
                            <div class="name">VACANT</div>
                            <div class="title">${emp.jobtitle || 'N/A'}</div>
                          </div>`;
        }

        previewDataTable.addRow([{ v: emp.nodeId, f: nodeHtml }, emp.managerId]);
    });

    previewChart = new google.visualization.OrgChart(chartDiv);
    previewChart.draw(previewDataTable, { allowHtml: true, allowCollapse: true, nodeClass: 'google-visualization-orgchart-node' });
}

function viewCompetencyProfile(rawEmployeeId) {
  if (!rawEmployeeId) return;
  const employeeId = String(rawEmployeeId).trim();

  switchTab('competency');

  // Force view to Individual Profile
  document.getElementById('individual-profile-view').style.display = 'block';
  document.getElementById('individual-profile-content').style.display = 'block';
  document.getElementById('team-competency-section').style.display = 'none';
  
  // Pre-show containers
  document.getElementById('competency-summary-container').style.display = 'grid';
  document.getElementById('competency-history-container').style.display = 'block';
  document.getElementById('competency-charts-container').style.display = 'grid';
  
  // Update buttons styling
  const btnProfile = document.getElementById('show-individual-profile');
  const btnTeam = document.getElementById('show-team-heatmap');
  if (btnProfile && btnTeam) {
      btnProfile.classList.add('bg-white', 'shadow', 'text-blue-700');
      btnProfile.classList.remove('text-gray-600', 'hover:bg-gray-300');
      btnTeam.classList.add('text-gray-600', 'hover:bg-gray-300');
      btnTeam.classList.remove('bg-white', 'shadow', 'text-blue-700');
  }

  // Load Data
  drawCompetencyDashboard(employeeId);

  // Sync Filters: Auto-fill Division/Group/Dept based on the employee
  const employee = fullEmployeeData.find(e => String(e.employeeId).trim() === employeeId);
  if (employee) {
      document.getElementById('comp-division-filter-value').value = employee.division || 'all';
      document.getElementById('comp-group-filter-value').value = employee.group || 'all';
      document.getElementById('comp-department-filter-value').value = employee.department || 'all';
      document.getElementById('comp-section-filter-value').value = employee.section || 'all';
      document.getElementById('competency-employee-select').value = employeeId;

      // Trigger populate to update visual text in dropdowns
      populateCompetencyFilters();
  }
  
  document.getElementById('competency-view').scrollIntoView({ behavior: 'smooth' });
}

/* =========================================================================
   AI JD BUILDER: LEVEL & POSITION AUTOMATION
   ========================================================================= */

// 1. GLOBAL MAPPING (String keys to handle both "1" and 1)
const LEVEL_MAPPING = {
  '1': 'Executive',
  '2': 'Director',
  '3': 'Managerial',
  '4': 'Supervisory',
  '5': 'Rank & File',
  '6': 'Jobcon'
};

// 2. POPULATE DROPDOWN (Called when Modal Opens)
function populateAILevelDropdown() {
  const levelSelect = document.getElementById('ai-level');
  if (!levelSelect) return;

  levelSelect.innerHTML = '<option value="">-- Select Level --</option>';

  // Create options from our mapping
  for (const [key, label] of Object.entries(LEVEL_MAPPING)) {
    const option = document.createElement('option');
    option.value = label; // The value we want to select (e.g. "Managerial")
    option.textContent = label; // The text user sees
    levelSelect.appendChild(option);
  }
}

function openAIJDModal() {
  document.getElementById('ai-jd-modal').style.display = 'flex';
  
  populateAILevelDropdown();
  initializeAIJobSelector();
  
  // --- NEW: Initialize Picker ---
  initializeCompetencyPicker();
  // Clear previous selections
  selectedCompetencies.clear();
  updateCompetencyUI();
}

function closeAIJDModal() {
  document.getElementById('ai-jd-modal').style.display = 'none';
  resetAIJDForm(); // <--- Auto-clear data on close
}

function resetAIJDForm() {
  // 1. Reset all input fields
  document.getElementById('ai-jd-form').reset();
  
  // 2. Explicitly clear text area and file input to be safe
  document.getElementById('ai-workload-text').value = '';
  document.getElementById('ai-upload-file').value = '';

  // 3. Reset the Preview Column to its default "Empty" state
  document.getElementById('ai-preview-content').innerHTML = `
    <div class="text-center text-gray-400 mt-20">
      <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
      <p>Generated content will appear here.</p>
    </div>
  `;
}

function switchAIInputTab(mode) {
  const workloadBtn = document.getElementById('tab-jd-workload');
  const uploadBtn = document.getElementById('tab-jd-upload');
  const workloadFields = document.getElementById('ai-workload-fields');
  const uploadFields = document.getElementById('ai-upload-fields');

  if (mode === 'workload') {
    workloadBtn.className = "flex-1 py-2 text-sm font-medium rounded-md bg-white shadow text-purple-700 transition-colors";
    uploadBtn.className = "flex-1 py-2 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-200 transition-colors";
    workloadFields.style.display = 'block';
    uploadFields.style.display = 'none';
  } else {
    uploadBtn.className = "flex-1 py-2 text-sm font-medium rounded-md bg-white shadow text-purple-700 transition-colors";
    workloadBtn.className = "flex-1 py-2 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-200 transition-colors";
    workloadFields.style.display = 'none';
    uploadFields.style.display = 'block';
  }
}

function generateJD() {
  // 1. Get values from the correct IDs (Handling the new Dropdown structure)
  // The 'ai-job-title' is now a hidden input populated by the dropdown logic
  const jobTitle = document.getElementById('ai-job-title').value;
  
  // 2. Validation
  if (!jobTitle) { 
    alert("Please select or enter a Job Title."); 
    // Focus the visible input inside the dropdown container for better UX
    const visibleInput = document.querySelector('#ai-job-title-dropdown-container .searchable-dropdown-input');
    if(visibleInput) visibleInput.focus();
    return; 
  }

  const isWorkload = document.getElementById('ai-workload-fields').style.display !== 'none';
  const loader = document.getElementById('ai-loading-overlay');
  
  // 3. Prepare Payload
  const payload = {
    jobTitle: jobTitle,
    // Add Position ID to payload so backend context is complete
    positionId: document.getElementById('ai-position-id').value,
    type: isWorkload ? 'workload' : 'upload',

    // --- NEW: Add Competencies to Payload ---
    competencies: document.getElementById('ai-selected-competencies').value
  };
  
  if (isWorkload) {
    payload.level = document.getElementById('ai-level').value;
    payload.department = document.getElementById('ai-dept').value;
    payload.content = document.getElementById('ai-workload-text').value;
    
    if (!payload.content.trim()) { 
        alert("Please paste the Workload Assessment or Task List."); 
        return; 
    }
    
    // Show loader and send
    submitAIRequest(payload, loader);
    
  } else {
    // Upload Mode Logic
    const fileInput = document.getElementById('ai-upload-file');
    if (fileInput.files.length === 0) { 
        alert("Please select a file to upload."); 
        return; 
    }
    
    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = function(e) {
      payload.file = {
        name: file.name,
        mimeType: file.type,
        content: e.target.result.split(',')[1] // base64
      };
      // Dummy content string to satisfy backend checks
      payload.content = "File Uploaded: " + file.name; 
      
      // Show loader and send
      submitAIRequest(payload, loader);
    };
    reader.readAsDataURL(file);
  }
}

function submitAIRequest(payload, loader) {
  // Reveal the loading overlay
  if(loader) loader.style.display = 'flex';
  
  // Clear previous content to avoid confusion
  const contentDiv = document.getElementById('ai-preview-content');
  // Don't fully clear it, just let the overlay cover it. 
  // If we clear it, we lose the 'Generated content will appear here' placeholder if it fails.
  
  google.script.run
    .withSuccessHandler(function(data) {
       console.log("AI Response Received:", data); // Debugging line
       renderAIOutput(data);
    })
    .withFailureHandler(function(err) {
      if(loader) loader.style.display = 'none';
      console.error("Backend Error:", err); // Debugging line
      alert("Error generating JD: " + err.message);
    })
    .generateJobDescriptionAI(payload);
}

/* =========================================================================
   COMPLETE AI RENDERER & LOGIC (Paste this into Index.html script)
   ========================================================================= */

// --- 1. HELPER FUNCTIONS (Must be defined first) ---

// Helper: Regenerate Button
const regenBtn = (section) => `
  <button onclick="triggerRegenerate('${section}')" class="ml-2 text-gray-400 hover:text-purple-600 transition-colors" title="Regenerate this section">
    <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
  </button>
`;

// Helper: Flatten Nested JSON (Fixes "hidden data" issues) - THIS WAS MISSING
function flattenObject(obj, prefix = '') {
  let result = {};
  for (const key in obj) {
    if (obj.hasOwnProperty(key)) {
      const newKey = prefix ? `${prefix}.${key}` : key;
      if (typeof obj[key] === 'object' && obj[key] !== null && !Array.isArray(obj[key])) {
        Object.assign(result, flattenObject(obj[key], newKey));
      } else {
        result[newKey] = obj[key];
      }
    }
  }
  return result;
}

// Helper: Fuzzy Search (Finds keys ignoring case/spaces)
function fuzzyFind(flattenedData, synonyms) {
  if (!flattenedData) return null;
  const allKeys = Object.keys(flattenedData);
  for (const key of allKeys) {
    const keyParts = key.toLowerCase().split('.');
    const lastPart = keyParts[keyParts.length - 1].replace(/_/g, '').replace(/\s/g, '');
    if (synonyms.includes(lastPart)) {
      return flattenedData[key];
    }
  }
  return null;
}

// Helper: Robust Deep Search (Recursive backup)
function deepSearch(obj, targetKeys) {
  if (!obj || typeof obj !== 'object') return null;
  const foundKey = Object.keys(obj).find(k => targetKeys.includes(k.toLowerCase().replace(/_/g, '').replace(/\s/g, '')));
  if (foundKey) return obj[foundKey];
  for (const key in obj) {
    if (typeof obj[key] === 'object' && obj[key] !== null) {
      const result = deepSearch(obj[key], targetKeys);
      if (result) return result;
    }
  }
  return null;
}

// Helper: Unwrap Data (Fixes [object Object] errors)
function unwrap(val) {
  if (!val) return null;
  if (typeof val === 'string') return val;
  if (typeof val === 'number') return String(val);
  if (Array.isArray(val)) {
    if (val.length === 0) return null;
    return typeof val[0] === 'string' ? val.join(' ') : unwrap(val[0]);
  }
  const keys = Object.keys(val);
  if (keys.length > 0) {
      const preferred = keys.find(k => ['text', 'value', 'content', 'description', 'summary'].includes(k.toLowerCase()));
      return unwrap(val[preferred || keys[0]]);
  }
  return JSON.stringify(val);
}

// Helper: Render Simple List (Tags)
function renderListSimple(items, emptyMsg) {
  if (!items) return `<span class="text-gray-400 italic text-xs">${emptyMsg}</span>`;
  if (typeof items === 'string') items = items.split(',').map(s => s.trim());
  if (!Array.isArray(items)) items = [items];
  
  return items.map(k => {
      const text = (typeof k === 'object') ? unwrap(k) : k;
      return `<span class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-xs font-semibold mb-1 mr-1 inline-block">${text}</span>`;
  }).join('');
}

// Helper: Render Bullet List
function renderListBullets(items) {
  if (!items) return '';
  if (typeof items === 'string') return `<li>${items}</li>`;
  if (!Array.isArray(items)) items = [items];
  return items.map(i => {
      const text = (typeof i === 'object') ? unwrap(i) : i;
      return `<li>${text}</li>`;
  }).join('');
}

// Helper: Render PLOC
function renderPLOC(respObj) {
  if (!respObj) return '<p class="text-gray-400 italic text-xs">No data found.</p>';
  if (Array.isArray(respObj)) {
      return `<ul contenteditable="true" class="editable-content list-disc ml-4 text-gray-700 text-xs space-y-1 p-2">${renderListBullets(respObj)}</ul>`;
  }
  const categories = ['Planning', 'Leading', 'Organizing', 'Controlling'];
  const colors = {'Planning': 'blue', 'Leading': 'purple', 'Organizing': 'yellow', 'Controlling': 'green'};
  let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
  let foundAny = false;
  categories.forEach(cat => {
    const key = Object.keys(respObj).find(k => k.toLowerCase().includes(cat.toLowerCase()));
    const items = key ? respObj[key] : [];
    const listItems = Array.isArray(items) ? items : (items ? [items] : []);
    if (listItems.length > 0) foundAny = true;
    const color = colors[cat];
    html += `<div class="border rounded p-3 bg-${color}-50 border-${color}-200">
        <h5 class="font-bold text-${color}-800 mb-2 uppercase text-xs tracking-wider select-none">${cat.charAt(0)} - ${cat}</h5>
        <ul contenteditable="true" class="editable-content list-disc list-outside ml-4 text-gray-700 space-y-1 text-xs outline-none p-1 rounded">
          ${listItems.length > 0 ? renderListBullets(listItems) : '<li class="text-gray-400 italic">Click to add...</li>'}
        </ul></div>`;
  });
  html += '</div>';
  if (!foundAny) {
      const values = Object.values(respObj).flat();
      return `<ul contenteditable="true" class="editable-content list-disc ml-4 text-gray-700 text-xs space-y-1 p-2">${renderListBullets(values)}</ul>`;
  }
  return html;
}

/* --- MAIN RENDER FUNCTION (Fixed Missing Key) --- */
function renderAIOutput(data) {
  // Hide loader
  const loader = document.getElementById('ai-loading-overlay');
  if(loader) loader.style.display = 'none';
  
  try {
      if (data.error) {
        document.getElementById('ai-preview-content').innerHTML = `<div class="text-red-500 font-bold p-4 border border-red-300 rounded bg-red-50">${data.error}</div>`;
        return;
      }

      // --- EXTRACT ---
      const flatData = flattenObject(data); 
      const rootKeys = Object.keys(data);
      
      const getters = {
        role: ['organizationalrole', 'role', 'jobsummary', 'rolesummary', 'summary', 'description', 'position_summary'],
        kpis: ['kpis', 'keyperformanceindicators', 'metrics', 'measures'],
        core: ['coreresponsibilities', 'coreduties', 'responsibilities', 'duties', 'core'],
        support: ['supportingresponsibilities', 'secondaryduties', 'supporting', 'otherduties'],
        tools: ['productivitytools', 'tools', 'software', 'technology', 'systemsandtools'],
        conditions: ['workingconditions', 'workenvironment', 'conditions', 'environment'],
        ld: ['ldmatrix', 'learninganddevelopment', 'training', 'development'],
        kn: ['knowledge', 'technicalknowledge', 'education'],
        ex: ['experience', 'workexperience'],
        co: ['competencies', 'skills', 'corecompetencies'],
        at: ['personalattributes', 'attributes', 'softskills'],
        
        // --- THIS WAS MISSING. IT IS FIXED NOW: ---
        quals: ['keyqualifications', 'qualifications', 'requirements', 'skillsmatrix'],
        
        rel: ['organizationalrelationship', 'relationships', 'reporting', 'structure', 'reportingto'],
        int: ['preferredinternal', 'internalcandidate', 'internal'],
        ext: ['preferredexternal', 'externalcandidate', 'external']
      };

      let orgRole = unwrap(deepSearch(data, getters.role));
      let kpis = deepSearch(data, getters.kpis);
      let tools = deepSearch(data, getters.tools);
      let conditions = unwrap(deepSearch(data, getters.conditions));
      let orgRel = unwrap(deepSearch(data, getters.rel));
      
      // This line was crashing because getters.quals was undefined. It will work now.
      let qualifications = deepSearch(data, getters.quals) || data; 
      
      let know = fuzzyFind(flatData, getters.kn);
      let exp = fuzzyFind(flatData, getters.ex);
      let comp = fuzzyFind(flatData, getters.co);
      let attr = fuzzyFind(flatData, getters.at);
      let prefInt = unwrap(deepSearch(data, getters.int));
      let prefExt = unwrap(deepSearch(data, getters.ext));
      let ldMatrix = deepSearch(data, getters.ld);

      // Responsibilities (Prefer Object Structure)
      let coreResp = null;
      let suppResp = null;
      
      const coreKey = rootKeys.find(k => getters.core.includes(k.toLowerCase().replace(/_/g, '')));
      if (coreKey) coreResp = data[coreKey];
      else coreResp = fuzzyFind(flatData, getters.core);

      const suppKey = rootKeys.find(k => getters.support.includes(k.toLowerCase().replace(/_/g, '')));
      if (suppKey) suppResp = data[suppKey];
      else suppResp = fuzzyFind(flatData, getters.support);


      // --- BUILD HTML ---
      const html = `
        <div class="border-b pb-4 mb-6">
          <h1 class="text-2xl font-bold text-gray-900 select-none">${document.getElementById('ai-job-title').value || 'Job Description'}</h1>
        </div>

        <div class="bg-gray-100 p-2 rounded mb-4 border-l-4 border-blue-600">
          <h3 class="font-bold text-slate-800 uppercase text-sm tracking-wide">Job Overview & Accountabilities</h3>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
          <div id="section-role">
            <h4 class="font-bold text-gray-700 mb-2 uppercase text-xs border-b flex items-center select-none">
              Organizational Role ${regenBtn('Organizational Role')}
            </h4>
            <p contenteditable="true" class="editable-content text-gray-600 italic text-sm p-2 rounded outline-none content-area">
              ${unwrap(orgRole) || 'Role summary not generated. Click to draft...'}
            </p>
          </div>

          <div id="section-kpis">
            <h4 class="font-bold text-gray-700 mb-2 uppercase text-xs border-b flex items-center select-none">
              Recommended KPIs ${regenBtn('KPIs')}
            </h4>
            <div contenteditable="true" class="editable-content flex flex-wrap content-area p-2 rounded outline-none gap-2">
              ${renderListSimple(kpis, "No KPIs generated. Click to add...")}
            </div>
          </div>
        </div>

        <div class="bg-gray-100 p-2 rounded mb-4 border-l-4 border-blue-600">
          <h3 class="font-bold text-slate-800 uppercase text-sm tracking-wide">Areas of Accountabilities</h3>
        </div>

        <div class="mb-8" id="section-core">
          <h4 class="font-bold text-gray-700 mb-3 uppercase text-sm border-b pb-1 bg-gray-50 p-1 flex items-center justify-between select-none">
            Core Responsibilities (PLOC) ${regenBtn('Core Responsibilities')}
          </h4>
          <div class="content-area">${renderPLOC(coreResp)}</div>
        </div>
        <div class="mb-8" id="section-support">
          <h4 class="font-bold text-gray-700 mb-3 uppercase text-sm border-b pb-1 bg-gray-50 p-1 flex items-center justify-between select-none">
            Supporting Responsibilities (PLOC) ${regenBtn('Supporting Responsibilities')}
          </h4>
          <div class="content-area">${renderPLOC(suppResp)}</div>
        </div>

        <div class="bg-gray-100 p-2 rounded mb-4 border-l-4 border-blue-600">
          <h3 class="font-bold text-slate-800 uppercase text-sm tracking-wide">Specification & Work Conditions</h3>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div id="section-rel">
            <h4 class="font-bold text-gray-700 mb-2 uppercase text-xs border-b flex items-center select-none">
              Organizational Relationship ${regenBtn('Organizational Relationship')}
            </h4>
            <p contenteditable="true" class="editable-content text-gray-700 text-xs p-2 rounded outline-none content-area">
                ${orgRel || 'Reports to: [Manager Title]\nSupervises: [Subordinates]'}
            </p>
          </div>
          <div id="section-tools">
            <h4 class="font-bold text-gray-700 mb-2 uppercase text-xs border-b flex items-center select-none">
              Productivity Tools ${regenBtn('Productivity Tools')}
            </h4>
            <ul contenteditable="true" class="editable-content list-disc ml-4 text-gray-700 text-xs content-area p-2 rounded outline-none">
                ${tools ? renderListBullets(tools) : '<li>Click to add tool...</li>'}
            </ul>
          </div>
        </div>

        <div class="mb-8" id="section-cond">
          <h4 class="font-bold text-gray-700 mb-2 uppercase text-xs border-b flex items-center select-none">
            Working Conditions ${regenBtn('Working Conditions')}
          </h4>
          <p contenteditable="true" class="editable-content text-gray-700 text-xs p-2 rounded outline-none content-area">
              ${conditions || 'Click to describe working conditions...'}
          </p>
        </div>

        <div class="bg-gray-100 p-2 rounded mb-4 border-l-4 border-blue-600">
          <h3 class="font-bold text-slate-800 uppercase text-sm tracking-wide">Key Qualification Matrix</h3>
        </div>

        <div class="mb-6" id="section-quals">
          <h4 class="font-bold text-gray-700 mb-2 uppercase text-xs border-b flex items-center select-none">
            Key Qualifications ${regenBtn('Key Qualifications')}
          </h4>
          <div class="grid grid-cols-2 gap-6 text-xs content-area">
            <div><strong class="block mb-1 text-gray-900 select-none">Knowledge:</strong> <ul contenteditable="true" class="editable-content list-disc ml-4 text-gray-600 p-1 rounded">${know ? renderListBullets(know) : '<li>Click to add...</li>'}</ul></div>
            <div><strong class="block mb-1 text-gray-900 select-none">Experience:</strong> <ul contenteditable="true" class="editable-content list-disc ml-4 text-gray-600 p-1 rounded">${exp ? renderListBullets(exp) : '<li>Click to add...</li>'}</ul></div>
            <div>
               <strong class="block mb-1 text-gray-900 select-none">Competencies:</strong> 
               <ul contenteditable="true" class="editable-content list-disc ml-4 text-gray-600 p-1 rounded mb-3">${comp ? renderListBullets(comp) : '<li>Click to add...</li>'}</ul>
               <strong class="block mb-1 text-indigo-700 select-none border-t pt-2">Preferred from Internal:</strong>
               <p contenteditable="true" class="editable-content text-gray-600 p-1 rounded">${prefInt || 'N/A'}</p>
            </div>
            <div>
               <strong class="block mb-1 text-gray-900 select-none">Attributes:</strong> 
               <ul contenteditable="true" class="editable-content list-disc ml-4 text-gray-600 p-1 rounded mb-3">${attr ? renderListBullets(attr) : '<li>Click to add...</li>'}</ul>
               <strong class="block mb-1 text-indigo-700 select-none border-t pt-2">Preferred from External:</strong>
               <p contenteditable="true" class="editable-content text-gray-600 p-1 rounded">${prefExt || 'N/A'}</p>
            </div>
          </div>
        </div>
        
        <div class="bg-green-50 p-4 rounded border border-green-200 mt-4">
          <h4 class="font-bold text-green-800 mb-2 text-xs uppercase select-none">Learning & Development Matrix</h4>
          <ul contenteditable="true" class="editable-content list-disc ml-4 text-green-900 text-xs p-2 rounded outline-none">
            ${ldMatrix ? renderListBullets(ldMatrix) : '<li>Click to add training...</li>'}
          </ul>
        </div>

        <details class="mt-8 border-t pt-4">
            <summary class="text-xs text-gray-400 cursor-pointer hover:text-gray-600 select-none">Troubleshoot: View Raw AI Data</summary>
            <pre class="bg-gray-800 text-green-400 p-4 rounded mt-2 text-xs overflow-auto max-h-60 select-all">${JSON.stringify(data, null, 2)}</pre>
        </details>
      `;

      document.getElementById('ai-preview-content').innerHTML = html;
      
  } catch (err) {
      console.error("Rendering Error:", err);
      document.getElementById('ai-preview-content').innerHTML = `<div class="text-red-600 bg-red-100 p-4 rounded border border-red-400">
        <strong>Rendering Error:</strong><br> ${err.message}<br><br>
        <small>Check console (F12) for details.</small>
      </div>`;
  }
}

function copyJDToClipboard() {
  const content = document.getElementById('ai-preview-content').innerText;
  navigator.clipboard.writeText(content).then(() => alert("Copied to clipboard!"));
}

function saveAIJD() {
  const content = document.getElementById('ai-preview-content');
  const jobTitle = document.getElementById('ai-job-title').value;
  const posId = document.getElementById('ai-position-id').value;

  if (!content.innerText.trim() || content.innerText.includes("Generated content will appear here")) {
    alert("Please generate a Job Description first.");
    return;
  }
  if (!posId) {
    alert("Please enter a Position ID (e.g., 04-CSD-001) to save the file correctly.");
    document.getElementById('ai-position-id').focus();
    return;
  }

  const btn = event.target;
  const originalText = btn.textContent;
  btn.textContent = "Saving to Drive...";
  btn.disabled = true;

  const { jsPDF } = window.jspdf;

  html2canvas(content, { scale: 2, useCORS: true, backgroundColor: '#ffffff' }).then(canvas => {
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jsPDF('p', 'mm', 'a4');
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = pdf.internal.pageSize.getHeight();
    const margin = 15; 
    const contentWidth = pdfWidth - (margin * 2);
    const contentHeight = (canvas.height * contentWidth) / canvas.width;
    
    let heightLeft = contentHeight;
    let position = margin;

    pdf.addImage(imgData, 'PNG', margin, position, contentWidth, contentHeight);
    heightLeft -= (pdfHeight - (margin * 2));

    while (heightLeft > 0) {
      position = heightLeft - contentHeight;
      pdf.addPage();
      pdf.addImage(imgData, 'PNG', margin, -pdfHeight + margin, contentWidth, contentHeight);
      heightLeft -= pdfHeight;
    }
    
    // --- NEW: SEND TO BACKEND INSTEAD OF DOWNLOADING ---
    const pdfDataUri = pdf.output('datauristring'); // Get base64 string

    google.script.run
      .withSuccessHandler(function(res) {
        if (res.success) {
          alert(` Saved Successfully!\n\nFile: ${res.name}\nLocation: Job Description General Folder`);
        } else {
          alert("Error Saving: " + res.error);
        }
        btn.textContent = originalText;
        btn.disabled = false;
      })
      .withFailureHandler(function(err) {
        alert("Server Error: " + err.message);
        btn.textContent = originalText;
        btn.disabled = false;
      })
      .saveJDToDrive(pdfDataUri, posId, jobTitle);

  }).catch(err => {
    console.error(err);
    alert("Error creating PDF: " + err.message);
    btn.textContent = originalText;
    btn.disabled = false;
  });
}

/* =========================================================================
   UPDATED REGENERATE FUNCTION (Handles New Sections)
   ========================================================================= */
// --- 3. REGENERATE TRIGGER FUNCTION ---

function triggerRegenerate(section) {
  let containerId = "";
  if (section === 'Organizational Role') containerId = "section-role";
  if (section === 'KPIs') containerId = "section-kpis";
  if (section === 'Core Responsibilities') containerId = "section-core";
  if (section === 'Supporting Responsibilities') containerId = "section-support";
  if (section === 'Organizational Relationship') containerId = "section-rel";
  if (section === 'Productivity Tools') containerId = "section-tools";
  if (section === 'Working Conditions') containerId = "section-cond";
  if (section === 'Key Qualifications') containerId = "section-quals";

  const container = document.querySelector(`#${containerId} .content-area`);
  if (!container) return;

  const originalHTML = container.innerHTML;
  container.innerHTML = `<div class="animate-pulse flex space-x-2 items-center text-purple-600 p-2"><div class="h-4 w-4 bg-purple-400 rounded-full"></div><span class="text-xs">Regenerating ${section}...</span></div>`;

  const payload = {
    jobTitle: document.getElementById('ai-job-title').value,
    level: document.getElementById('ai-level').value,
    department: document.getElementById('ai-dept').value,
    content: document.getElementById('ai-workload-text').value
  };

  google.script.run
    .withSuccessHandler(newData => {
      // Re-render Section Logic
      if (section.includes('Responsibilities')) {
         let html = "";
         if(newData.CoreResponsibilities) html = renderPLOC(newData.CoreResponsibilities); 
         else if(newData.SupportingResponsibilities) html = renderPLOC(newData.SupportingResponsibilities);
         container.innerHTML = html;
      }
      else if (section === 'KPIs') {
         container.innerHTML = renderListSimple(newData.KPIs, "No KPIs generated.");
      }
      else if (['Organizational Role', 'Organizational Relationship', 'Working Conditions'].includes(section)) {
         // Handle simple text keys
         let key = section.replace(/ /g, ''); // "OrganizationalRole"
         // Map "Working Conditions" to "WorkingConditions" etc.
         container.innerHTML = unwrap(newData[key]) || unwrap(newData) || "N/A";
      }
      else if (section === 'Productivity Tools') {
         container.innerHTML = renderListBullets(newData.ProductivityTools || []);
      }
      else if (section === 'Key Qualifications') {
         const q = newData.KeyQualifications || newData; 
         const findQ = (keyPart) => {
             const foundKey = Object.keys(q).find(k => k.toLowerCase().includes(keyPart.toLowerCase()));
             return foundKey ? q[foundKey] : [];
         };
         
         const know = findQ('knowledge');
         const exp = findQ('experience');
         const comp = findQ('competencies');
         const attr = findQ('attributes');
         const pint = findQ('internal');
         const pext = findQ('external');

         container.innerHTML = `
            <div><strong class="block mb-1 text-gray-900 select-none">Knowledge:</strong> <ul contenteditable="true" class="editable-content list-disc ml-4 text-gray-600 p-1 rounded">${renderListBullets(know)}</ul></div>
            <div><strong class="block mb-1 text-gray-900 select-none">Experience:</strong> <ul contenteditable="true" class="editable-content list-disc ml-4 text-gray-600 p-1 rounded">${renderListBullets(exp)}</ul></div>
            <div><strong class="block mb-1 text-gray-900 select-none">Competencies:</strong> <ul contenteditable="true" class="editable-content list-disc ml-4 text-gray-600 p-1 rounded mb-3">${renderListBullets(comp)}</ul><strong class="block mb-1 text-indigo-700 select-none border-t pt-2">Preferred from Internal:</strong><p contenteditable="true" class="editable-content text-gray-600 p-1 rounded">${unwrap(pint) || 'N/A'}</p></div>
            <div><strong class="block mb-1 text-gray-900 select-none">Attributes:</strong> <ul contenteditable="true" class="editable-content list-disc ml-4 text-gray-600 p-1 rounded mb-3">${renderListBullets(attr)}</ul><strong class="block mb-1 text-indigo-700 select-none border-t pt-2">Preferred from External:</strong><p contenteditable="true" class="editable-content text-gray-600 p-1 rounded">${unwrap(pext) || 'N/A'}</p></div>
         `;
      }
    })
    .withFailureHandler(err => {
      alert("Error regenerating section: " + err.message);
      container.innerHTML = originalHTML; 
    })
    .regenerateJDSection(section, payload);
}

// IMPORTANT: Move 'renderPLOC' and other helpers OUTSIDE 'renderAIOutput' 
// so 'triggerRegenerate' can use them.
function renderPLOC_Global(respObj) {
    // ... (Paste your renderPLOC logic here) ...
    // Copy the exact logic from your current renderPLOC function
    if (!respObj) return '<p class="text-gray-400 italic text-xs">No data found.</p>';
    if (Array.isArray(respObj)) return `<ul class="list-disc ml-4 text-gray-700 text-xs space-y-1">${respObj.map(i => `<li>${i}</li>`).join('')}</ul>`;
    
    const categories = ['Planning', 'Leading', 'Organizing', 'Controlling'];
    const colors = {'Planning': 'blue', 'Leading': 'purple', 'Organizing': 'yellow', 'Controlling': 'green'};
    let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
    categories.forEach(cat => {
      const key = Object.keys(respObj).find(k => k.toLowerCase().includes(cat.toLowerCase()));
      const items = key ? respObj[key] : [];
      const listItems = Array.isArray(items) ? items : (items ? [items] : []);
      const color = colors[cat];
      html += `<div class="border rounded p-3 bg-${color}-50 border-${color}-200"><h5 class="font-bold text-${color}-800 mb-2 uppercase text-xs tracking-wider">${cat.charAt(0)} - ${cat}</h5><ul class="list-disc list-outside ml-4 text-gray-700 space-y-1 text-xs">${listItems.length > 0 ? listItems.map(i => `<li>${i}</li>`).join('') : '<li class="text-gray-400 italic">None</li>'}</ul></div>`;
    });
    html += '</div>';
    return html;
}

/* --- AI JD BUILDER: ORG CHART CONNECTION (UPDATED) --- */

function initializeAIJobSelector() {
  if (typeof fullEmployeeData === 'undefined' || fullEmployeeData.length === 0) return;

  // Filter Active Positions
  const activePositions = fullEmployeeData.filter(e => e.positionStatus !== 'Inactive' && e.jobTitle);

  // Map for Dropdown
  const dropdownItems = activePositions.map(e => ({
    displayLabel: e.jobTitle, 
    positionId: e.positionId 
  }));

  // Initialize Dropdown
  createSearchableDropdown('ai-job-title-dropdown-container', dropdownItems, 'displayLabel', 'positionId', function(selectedPosId) {
    
    // Find Employee Record
    const empData = activePositions.find(e => e.positionId === selectedPosId);
    
    if (empData) {
      // --- AUTO-POPULATE FIELDS ---
      
      // Position ID
      const posIdField = document.getElementById('ai-position-id');
      if (posIdField) posIdField.value = empData.positionId;

      // Department
      const deptField = document.getElementById('ai-dept');
      if (deptField) deptField.value = empData.department;

      // Job Title (Hidden field for AI)
      document.getElementById('ai-job-title').value = empData.jobTitle;

      // --- ROBUST LEVEL AUTO-POPULATION ---
      const levelField = document.getElementById('ai-level');
      if (levelField && empData.level) {
          // 1. Clean the data (convert to string and trim)
          const rawLevel = String(empData.level).trim();
          
          // 2. Try Direct Mapping (e.g. "3" -> "Managerial")
          if (LEVEL_MAPPING[rawLevel]) {
              levelField.value = LEVEL_MAPPING[rawLevel];
          } 
          // 3. Try Name Match (e.g. Data is already "Managerial")
          else if (Object.values(LEVEL_MAPPING).includes(rawLevel)) {
              levelField.value = rawLevel;
          }
          // 4. Try Regex Extract (e.g. "Level 3" -> "3" -> "Managerial")
          else {
              const match = rawLevel.match(/\d+/); // Find first number
              if (match && LEVEL_MAPPING[match[0]]) {
                  levelField.value = LEVEL_MAPPING[match[0]];
              } else {
                  // Fallback: Just try to set it as-is
                  levelField.value = rawLevel; 
              }
          }
          console.log(`Auto-Populate Level: Raw="${rawLevel}" -> Set="${levelField.value}"`);
      }

      // UX Cleanup: Show clean title in visible input
      const visibleInput = document.querySelector('#ai-job-title-dropdown-container .searchable-dropdown-input');
      if (visibleInput) visibleInput.value = empData.jobTitle;
    }
  });

  // Sync Manual Typing
  const input = document.querySelector('#ai-job-title-dropdown-container .searchable-dropdown-input');
  if (input) {
    input.addEventListener('input', function(e) {
      document.getElementById('ai-job-title').value = e.target.value;
    });
  }
}

/* =========================================================================
   COMPETENCY PICKER LOGIC
   ========================================================================= */

let allCompetencies = [];
let selectedCompetencies = new Set();

function initializeCompetencyPicker() {
  const input = document.getElementById('competency-search-input');
  const list = document.getElementById('competency-dropdown-list');
  
  // 1. Fetch data from backend
  google.script.run
    .withSuccessHandler(data => {
      allCompetencies = data || [];
      renderCompetencyDropdown(''); // Initial render
    })
    .getCompetencyNames();

  // 2. Setup Input Event Listeners
  input.addEventListener('input', (e) => {
    renderCompetencyDropdown(e.target.value);
    list.style.display = 'block';
  });

  input.addEventListener('focus', () => {
    renderCompetencyDropdown(input.value);
    list.style.display = 'block';
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!document.getElementById('competency-multiselect-wrapper').contains(e.target) && 
        !list.contains(e.target)) {
      list.style.display = 'none';
    }
  });
}

function renderCompetencyDropdown(query) {
  const list = document.getElementById('competency-dropdown-list');
  list.innerHTML = '';
  
  const filtered = allCompetencies.filter(c => 
    c.toLowerCase().includes(query.toLowerCase()) && 
    !selectedCompetencies.has(c) // Don't show if already selected
  );

  if (filtered.length === 0) {
    const empty = document.createElement('div');
    empty.className = 'multiselect-option text-gray-400 italic';
    empty.textContent = 'No matches found';
    list.appendChild(empty);
    return;
  }

  filtered.forEach(comp => {
    const div = document.createElement('div');
    div.className = 'multiselect-option';
    div.textContent = comp;
    div.onclick = () => addCompetencyTag(comp);
    list.appendChild(div);
  });
}

function addCompetencyTag(comp) {
  selectedCompetencies.add(comp);
  updateCompetencyUI();
  
  // Clear input and refocus
  const input = document.getElementById('competency-search-input');
  input.value = '';
  input.focus();
  document.getElementById('competency-dropdown-list').style.display = 'none';
}

function removeCompetencyTag(comp) {
  selectedCompetencies.delete(comp);
  updateCompetencyUI();
}

function updateCompetencyUI() {
  const wrapper = document.getElementById('competency-multiselect-wrapper');
  const input = document.getElementById('competency-search-input');
  
  // Remove existing tags (but keep the input)
  const existingTags = wrapper.querySelectorAll('.multiselect-tag');
  existingTags.forEach(t => t.remove());

  // Add tags back
  selectedCompetencies.forEach(comp => {
    const tag = document.createElement('div');
    tag.className = 'multiselect-tag';
    tag.innerHTML = `
      ${comp}
      <button type="button" onclick="removeCompetencyTag('${comp}')">&times;</button>
    `;
    wrapper.insertBefore(tag, input);
  });

  // Update hidden input for form submission
  document.getElementById('ai-selected-competencies').value = Array.from(selectedCompetencies).join(', ');
}

</script>
</div>
</body>
</html>
